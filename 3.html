document.addEventListener('DOMContentLoaded', function() {
    const devicesData = JSON.parse(document.getElementById('devices-data').textContent);
    const tableBody = document.getElementById('results-table-body');
    let currentRow = null; // Track current row being edited
    
    devicesData.forEach(device => {
        const row = document.createElement('tr');
        row.id = `device-row-${device.id}`;
        row.setAttribute('data-id', device.id);
        row.className = 'device-row';
        
        for (const key in device) {
            const cell = document.createElement('td');
            cell.id = `cell-${device.id}-${key}`;
            cell.className = `cell-${key}`;
            
            if (key === "current_user__username") {
                const container = document.createElement('div');
                container.id = `user-container-${device.id}`;
                container.className = 'current-user-cell';
                
                const userText = document.createElement('span');
                userText.id = `user-text-${device.id}`;
                userText.className = 'current-user-text';
                userText.textContent = device[key] || '';
                container.appendChild(userText);
                
                const editIcon = document.createElement('i');
                editIcon.id = `edit-icon-${device.id}`;
                editIcon.className = 'fas fa-edit current-user-edit-icon ms-2';
                editIcon.setAttribute('title', 'Edit Device');
                
                editIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    currentRow = row; // Set current row before opening modal
                    openEditModal(device);
                });
                
                container.appendChild(editIcon);
                cell.appendChild(container);
            } else {
                cell.textContent = device[key];
            }
            
            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });

    function openEditModal(device) {
        // Populate form fields
        Object.keys(device).forEach(key => {
            const editField = document.getElementById(`edit-${key.replace('__', '-')}`);
            if (editField) {
                editField.value = device[key] || '';
            }
        });

        // Initialize or refresh optimized selects in the modal
        document.querySelectorAll('#editDeviceModal .optimized-select').forEach(select => {
            if (!select.optimizedSelect) {
                new OptimizedSelect(select);
            }
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
        modal.show();
    }

    // Save changes handler
    document.getElementById('saveDeviceChanges').addEventListener('click', function() {
        if (!currentRow) return; // Guard clause if no row selected
        
        const form = document.getElementById('edit-device-form');
        const deviceId = currentRow.getAttribute('data-id');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        fetch(`/api/devices/${deviceId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(updatedDevice => {
            // Update only the current row
            updateTableRow(deviceId, updatedDevice);
            
            // Reset currentRow and close modal
            currentRow = null;
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
            modal.hide();
        })
        .catch(error => {
            console.error('Error:', error);
            currentRow = null; // Reset on error too
        });
    });

    // Add modal hidden event to reset currentRow
    document.getElementById('editDeviceModal').addEventListener('hidden.bs.modal', function() {
        currentRow = null; // Reset currentRow when modal is closed
    });

    function updateTableRow(deviceId, updatedDevice) {
        if (!currentRow) return; // Guard clause
        
        Object.keys(updatedDevice).forEach(key => {
            const cell = currentRow.querySelector(`#cell-${deviceId}-${key}`);
            if (cell) {
                if (key === "current_user__username") {
                    const userText = cell.querySelector(`#user-text-${deviceId}`);
                    if (userText) {
                        userText.textContent = updatedDevice[key] || '';
                    }
                } else {
                    cell.textContent = updatedDevice[key];
                }
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
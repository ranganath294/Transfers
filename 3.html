{% extends 'iot_catalogue/base.html' %}
{% load static %}

{% block content_div %}
<form id="iot-search-form" method="post" action="{% url 'iot_catalogue:search' %}" class="row g-3">
    {% csrf_token %}
    <div class="col-md-6" id="search-form-left-col">
        <div class="mb-3" id="device-type-container">
            <label class="form-label" for="device-type-select">Device Type</label>
            <select name="device_type" class="form-select optimized-select" id="device-type-select">
                <option value="default" selected>-- All --</option>
                <option value="Headset">Headset</option>
                <!-- ... other options ... -->
            </select>
        </div>

        <!-- Other left column fields -->
    </div>

    <div class="col-md-6" id="search-form-right-col">
        <!-- Right column fields -->
    </div>
</form>

<!-- Edit Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" id="editDeviceDialog">
        <div class="modal-content" id="editDeviceContent">
            <div class="modal-header" id="editDeviceHeader">
                <h5 class="modal-title" id="editDeviceModalLabel">Edit Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="editDeviceBody">
                <form id="edit-device-form" class="row g-3">
                    <div class="col-md-6" id="edit-form-left-col">
                        <div class="mb-3" id="edit-device-type-container">
                            <label class="form-label" for="edit-device-type">Device Type</label>
                            <select name="device_type" class="form-select optimized-select" id="edit-device-type">
                                <option value="Headset">Headset</option>
                                <option value="Speaker">Speaker</option>
                                <!-- ... other options ... -->
                            </select>
                        </div>

                        <div class="mb-3" id="edit-model-number-container">
                            <label class="form-label" for="edit-model-number">Model Number</label>
                            <select name="model_number" class="form-select optimized-select" id="edit-model-number">
                                {% for model_number in model_numbers %}
                                <option value="{{ model_number }}">{{ model_number }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Other left column fields -->
                    </div>

                    <div class="col-md-6" id="edit-form-right-col">
                        <!-- Right column fields with their unique IDs -->
                    </div>
                </form>
            </div>
            <div class="modal-footer" id="editDeviceFooter">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDeviceChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block results_div %}
{% if devices %}
<div class="card-body" id="results-card">
    <div class="table-shadow" id="results-table-container">
        <div class="table-container" id="results-scrollable-container">
            <table class="table table-hover table-sticky mb-0" id="results-table">
                <thead>
                    <tr class="bg-light" id="results-header-row">
                        {% for col_name in column_names %}
                            <th class="fw-semibold" id="col-header-{{ col_name|lower|slugify }}">{{ col_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script id="devices-data" type="application/json">
    {{ devices|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const devicesData = JSON.parse(document.getElementById('devices-data').textContent);
    const tableBody = document.getElementById('results-table-body');
    
    devicesData.forEach(device => {
        const row = document.createElement('tr');
        row.id = `device-row-${device.id}`;
        row.setAttribute('data-id', device.id);
        
        for (const key in device) {
            const cell = document.createElement('td');
            cell.id = `cell-${device.id}-${key}`;
            
            if (key === "current_user__username") {
                const container = document.createElement('div');
                container.id = `user-container-${device.id}`;
                
                const userText = document.createElement('span');
                userText.id = `user-text-${device.id}`;
                userText.textContent = device[key] || '';
                container.appendChild(userText);
                
                const editIcon = document.createElement('i');
                editIcon.id = `edit-icon-${device.id}`;
                editIcon.className = 'fas fa-edit ms-2';
                editIcon.setAttribute('title', 'Edit Device');
                
                editIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditModal(device);
                });
                
                container.appendChild(editIcon);
                cell.appendChild(container);
            } else {
                cell.textContent = device[key];
            }
            
            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });

    function openEditModal(device) {
        // Populate form fields
        Object.keys(device).forEach(key => {
            const editField = document.getElementById(`edit-${key.replace('__', '-')}`);
            if (editField) {
                editField.value = device[key] || '';
            }
        });

        // Store device ID
        document.getElementById('edit-device-form').setAttribute('data-device-id', device.id);

        // Refresh optimized selects
        document.querySelectorAll('#editDeviceModal .optimized-select').forEach(select => {
            if (!select.optimizedSelect) {
                new OptimizedSelect(select);
            }
        });

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
        modal.show();
    }

    // Save changes handler
    document.getElementById('saveDeviceChanges').addEventListener('click', function() {
        const form = document.getElementById('edit-device-form');
        const deviceId = form.getAttribute('data-device-id');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        fetch(`/api/devices/${deviceId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(updatedDevice => {
            updateTableRow(deviceId, updatedDevice);
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
            modal.hide();
        })
        .catch(error => console.error('Error:', error));
    });

    function updateTableRow(deviceId, updatedDevice) {
        Object.keys(updatedDevice).forEach(key => {
            const cell = document.getElementById(`cell-${deviceId}-${key}`);
            if (cell) {
                if (key === "current_user__username") {
                    const userText = document.getElementById(`user-text-${deviceId}`);
                    if (userText) {
                        userText.textContent = updatedDevice[key] || '';
                    }
                } else {
                    cell.textContent = updatedDevice[key];
                }
            }
        });
    }
});
</script>
{% endif %}
{% endblock %}

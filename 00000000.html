coverage_types = ['Legacy', 'NewFR']

csv_file_path = os.path.join(ConfigPaths.ref_dir, "projected_percentages.csv")
projection_df = pd.read_csv(csv_file_path)

phase_data = {
    phase: {coverage_type: calculate_phase_metrics(all_tc_df, phase, coverage_type) for coverage_type in coverage_types}
    for phase in phases
}

table_data = []
sp_groups = all_tc_df.groupby('SP Name')

for sp_name, sp_group in sp_groups:
    sp_teams = []
    team_groups = sp_group.groupby('Test Team')

    for team_name, team_group in team_groups:
        team_phase_data = []

        for phase in phases:
            phase_metrics = phase_data[phase]
            phase_date = get_phase_date(phase_dates_df, sp_name, phase)
            unique_issue_count, unique_issue_list, unique_cr_list, unique_cr_count, unique_jira_list, unique_jira_count = get_unique_issue_counts(all_tc_df, sp_name, team_name, phase)

            phase_info = {
                'phase': phase,
                'date': phase_date,
                'metrics': {
                    'coverage_percentage': phase_metrics['coverage_percentage'],
                    'passed_percentage': phase_metrics['passed_percentage'],
                    'failed_percentage': phase_metrics['failed_percentage'],
                    'blocked_percentage': phase_metrics['blocked_percentage']
                },
                'unique_issue_count': int(unique_issue_count),
                'unique_issue_list': unique_issue_list,
                'unique_cr_list': unique_cr_list,
                'unique_cr_count': unique_cr_count,
                'unique_jira_list': unique_jira_list,
                'unique_jira_count': unique_jira_count,
                "expected_cov_percentage": get_expected_coverage(projection_df, sp_name, team_name, phase)
            }

            team_phase_data.append(phase_info)

        sp_teams.append({
            'team_name': team_name,
            'phases': team_phase_data
        })

    table_data.append({
        'sp_name': sp_name,
        'teams': sp_teams
    })

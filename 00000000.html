<div class="alert-container px-5">
</div>
<div class="container container-fluid">
    <h1 class="page-title">SP Metrics Report</h1>
    
    <div class="select-container">
        <label for="sp_name" class="form-label">Select SP:</label>
        <select id="sp_name" name="sp_name" class="form-select">
            <option value="">--No SP Selected--</option>
            {% for sp_name in sp_names %}
                <option value="{{ sp_name }}" {% if sp_name == selected_sp %}selected{% endif %}>{{ sp_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="table-responsive">
        <table id="counts_table" class="table table-hover">
            <thead>
                <tr></tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById('sp_name').addEventListener('change', function() {
        const spName = this.value;
        const tableResponsive = document.querySelector('.table-responsive');

        if (spName) {
            // Add loading state
            tableResponsive.classList.add('table-loading');

            fetch(`/get_counts/?sp_name=${spName}`)
                .then(response => response.json())
                .then(data => {
                    // Remove loading state
                    tableResponsive.classList.remove('table-loading');

                    const tableBody = document.querySelector('#counts_table tbody');
                    tableBody.innerHTML = '';
                    const tableHead = document.querySelector('#counts_table thead tr');
                    tableHead.innerHTML = '<th scope="col" class="metrics-cell">Metrics</th>';
                    
                    if (data.length > 0) {
                        const teams = Object.keys(data[0]).filter(key => key !== 'Metrics');
                        teams.forEach(team => {
                            const th = document.createElement('th');
                            th.setAttribute('scope', 'col');
                            th.textContent = team;
                            tableHead.appendChild(th);
                        });
                        
                        data.forEach(row => {
                            const tr = document.createElement('tr');
                            const metricsTd = document.createElement('td');
                            metricsTd.textContent = row.Metrics;
                            metricsTd.className = 'metrics-cell';
                            tr.appendChild(metricsTd);
                            
                            teams.forEach(team => {
                                const td = document.createElement('td');
                                const value = row[team] !== undefined ? row[team] : '';
                                td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                                tr.appendChild(td);
                            });
                            
                            tableBody.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    // Remove loading state
                    tableResponsive.classList.remove('table-loading');

                    console.error('Error:', error);
                    const tableBody = document.querySelector('#counts_table tbody');
                    tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
                });
        } else {
            const tableBody = document.querySelector('#counts_table tbody');
            tableBody.innerHTML = '<tr><td colspan="100%" class="table-empty">Please select an SP to view metrics</td></tr>';
            const tableHead = document.querySelector('#counts_table thead tr');
            tableHead.innerHTML = '<th scope="col" class="metrics-cell">Metrics</th>';
        }
    });
</script>

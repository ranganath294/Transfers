class OptimizedMultiSelect {
    static counter = 0; // Static counter to ensure unique ID
    constructor(originalSelect, options = {}) {
        if(originalSelect.dataset.initialized){
            return;
        }
        this.originalSelect = originalSelect;
        this.options = {
            itemHeight: 35,
            maxVisibleItems: 8,
            ...options
        };
        this.itemHeight = this.options.itemHeight;
        this.maxVisibleItems = this.options.maxVisibleItems;
        this.allOptions = Array.from(originalSelect.options)
            .filter(opt => opt.value) // Filter out empty values
            .map(opt => ({
                value: opt.value,
                label: opt.text,
                selected: opt.selected
            }));
        this.selectedValues = new Set();
        this.isOpen = false;
        originalSelect.dataset.initialized = 'true';
        // Generate a unique elementId
        this.elementId = `${originalSelect.id}-optimized-select`;
        
        // Initialize selected values from original select
        Array.from(originalSelect.selectedOptions).forEach(option => {
            if (option.value) {
                this.selectedValues.add(option.value);
            }
        });
        
        this.init();
    }
    
    init() {
        // Create wrapper
        this.wrapper = document.createElement('div');
        this.wrapper.className = 'optimized-select-wrapper';
        this.wrapper.id = `${this.elementId}-wrapper`;
        
        // Create selected items container - MOVED OUTSIDE THE DROPDOWN
        this.selectedItemsContainer = document.createElement('div');
        this.selectedItemsContainer.className = 'selected-items-container';
        this.selectedItemsContainer.id = `${this.elementId}-selected-items`;
        this.selectedItemsContainer.style.marginBottom = '0.5rem';
        this.selectedItemsContainer.style.maxHeight = '15rem'; // Allow more height for selected items
        this.selectedItemsContainer.style.overflowY = 'auto';
        this.selectedItemsContainer.style.border = '1px solid #dee2e6';
        this.selectedItemsContainer.style.borderRadius = '4px';
        this.selectedItemsContainer.style.padding = '0.5rem';
        
        // Create button with selected items display
        this.button = document.createElement('button');
        this.button.className = 'optimized-select-button form-select';
        this.button.id = `${this.elementId}-button`;
        this.button.type = 'button'; // Prevent form submission
        
        // Create selected summary text
        this.selectedSummary = document.createElement('span');
        this.selectedSummary.className = 'selected-summary';
        this.button.appendChild(this.selectedSummary);
        
        // Create dropdown container
        this.dropdown = document.createElement('div');
        this.dropdown.className = 'optimized-select-dropdown';
        this.dropdown.id = `${this.elementId}-dropdown`;
        
        // Create search input
        this.searchInput = document.createElement('input');
        this.searchInput.className = 'optimized-select-search form-control';
        this.searchInput.id = `${this.elementId}-search`;
        this.searchInput.placeholder = 'Search...';
        
        // Create options container
        this.optionsContainer = document.createElement('div');
        this.optionsContainer.className = 'optimized-select-options';
        this.optionsContainer.id = `${this.elementId}-options`;
        
        // Create virtual scroll container
        this.virtualScroll = document.createElement('div');
        this.virtualScroll.className = 'virtual-scroll-container';
        this.virtualScroll.id = `${this.elementId}-virtual-scroll`;
        
        // Assemble the components in the correct order
        this.dropdown.appendChild(this.searchInput);
        this.dropdown.appendChild(this.optionsContainer);
        this.optionsContainer.appendChild(this.virtualScroll);
        
        // New order: selected items, then button, then dropdown
        this.wrapper.appendChild(this.selectedItemsContainer);
        this.wrapper.appendChild(this.button);
        this.wrapper.appendChild(this.dropdown);
        
        // Insert custom select after original
        this.originalSelect.style.display = 'none';
        this.originalSelect.parentNode.insertBefore(this.wrapper, this.originalSelect.nextSibling);
        
        this.addEventListeners();
        this.updateButtonText();
        this.updateSelectedItemsDisplay();
    }
    
    addEventListeners() {
        // Toggle dropdown with improved handling
        this.button.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent focus issues
            this.toggleDropdown();
        });
        
        // Handle search
        this.searchInput.addEventListener('input', () => {
            this.filterAndRenderOptions();
        });
        
        // Handle keyboard navigation
        this.searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.closeDropdown();
            }
        });
        
        // Prevent search input from closing dropdown
        this.searchInput.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
        
        // Handle scroll
        this.optionsContainer.addEventListener('scroll', () => {
            this.renderVisibleOptions();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('mousedown', (e) => {
            if (!this.wrapper.contains(e.target)) {
                this.closeDropdown();
            }
        });
        
        // Prevent dropdown from closing when clicking inside
        this.dropdown.addEventListener('mousedown', (e) => {
            e.stopPropagation();
        });
    }
    
    toggleDropdown() {
        if (this.isOpen) {
            this.closeDropdown();
        } else {
            this.openDropdown();
        }
    }
    
    openDropdown() {
        this.isOpen = true;
        this.dropdown.style.display = 'block';
        this.searchInput.focus();
        this.filterAndRenderOptions();
    }
    
    closeDropdown() {
        this.isOpen = false;
        this.dropdown.style.display = 'none';
        this.searchInput.value = '';
    }
    
    filterAndRenderOptions() {
        const searchTerm = this.searchInput.value.toLowerCase();
        this.filteredOptions = this.allOptions.filter(option => 
            option.label.toLowerCase().includes(searchTerm)
        );
        
        // Reset scroll position
        this.optionsContainer.scrollTop = 0;
        
        // Handle empty state
        if (this.filteredOptions.length === 0) {
            this.virtualScroll.innerHTML = '<div class="empty-options">No options found</div>';
            return;
        }
        
        // Calculate the height based on the number of filtered options
        const height = Math.min(this.filteredOptions.length, this.maxVisibleItems) * this.itemHeight;
        this.optionsContainer.style.height = `${height}px`;
        this.virtualScroll.style.height = `${this.filteredOptions.length * this.itemHeight}px`;
        
        this.renderVisibleOptions();
    }
    
    renderVisibleOptions() {
        const scrollTop = this.optionsContainer.scrollTop;
        const startIndex = Math.floor(scrollTop / this.itemHeight);
        const endIndex = startIndex + this.maxVisibleItems + 2;
        
        this.virtualScroll.innerHTML = '';
        this.filteredOptions.slice(startIndex, endIndex).forEach((option, index) => {
            const optionEl = document.createElement('div');
            optionEl.className = 'optimized-select-option';
            if (this.selectedValues.has(option.value)) {
                optionEl.classList.add('selected');
            }
            
            const labelEl = document.createElement('span');
            labelEl.textContent = option.label;
            optionEl.appendChild(labelEl);
            
            optionEl.style.position = 'absolute';
            optionEl.style.top = `${(startIndex + index) * this.itemHeight}px`;
            optionEl.style.height = `${this.itemHeight}px`;
            
            optionEl.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent focus issues
                this.toggleOption(option);
            });
            
            this.virtualScroll.appendChild(optionEl);
        });
    }
    
    toggleOption(option) {
        if (this.selectedValues.has(option.value)) {
            this.selectedValues.delete(option.value);
        } else {
            this.selectedValues.add(option.value);
        }
        
        this.updateOriginalSelect();
        this.updateSelectedItemsDisplay();
        this.updateButtonText();
        this.renderVisibleOptions(); // Re-render to update selected state
    }
    
    updateOriginalSelect() {
        // Update original select element
        Array.from(this.originalSelect.options).forEach(option => {
            option.selected = this.selectedValues.has(option.value);
        });
        
        // Dispatch change event
        this.originalSelect.dispatchEvent(new Event('change'));
    }
    
    updateSelectedItemsDisplay() {
        this.selectedItemsContainer.innerHTML = '';
        
        // Always show the container but hide when empty
        if (this.selectedValues.size === 0) {
            this.selectedItemsContainer.style.display = 'none';
            return;
        }
        
        this.selectedItemsContainer.style.display = 'flex';
        
        this.allOptions
            .filter(option => this.selectedValues.has(option.value))
            .forEach(option => {
                const itemEl = document.createElement('div');
                itemEl.className = 'selected-item';
                
                const labelEl = document.createElement('span');
                labelEl.className = 'selected-item-label';
                labelEl.textContent = option.label;
                itemEl.appendChild(labelEl);
                
                const removeEl = document.createElement('span');
                removeEl.className = 'selected-item-remove';
                removeEl.innerHTML = '&times;'; // Cross mark
                removeEl.setAttribute('role', 'button');
                removeEl.setAttribute('aria-label', `Remove ${option.label}`);
                removeEl.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.selectedValues.delete(option.value);
                    this.updateOriginalSelect();
                    this.updateSelectedItemsDisplay();
                    this.updateButtonText();
                    this.renderVisibleOptions();
                });
                
                itemEl.appendChild(removeEl);
                this.selectedItemsContainer.appendChild(itemEl);
            });
    }
    
    updateButtonText() {
        const selected = this.allOptions.filter(option => this.selectedValues.has(option.value));
        
        if (selected.length === 0) {
            this.selectedSummary.textContent = 'Choose options...';
            this.button.style.borderTopLeftRadius = '4px';
            this.button.style.borderTopRightRadius = '4px';
        } else if (selected.length === 1) {
            this.selectedSummary.textContent = `Select SPs (${selected.length} selected)`;
        } else {
            this.selectedSummary.textContent = `Select SPs (${selected.length} selected)`;
        }
    }
}
function calculateInnerTable1Metrics(sp, selectedTeam) {
    const teamData = sp.teams.find(team => team.team_name === selectedTeam);
    if (!teamData) return null;

    const processedDetails = teamData.phases.reduce((accumDetails, phase) => {
        // Merged lists for unique details
        const mergedUniqueCRs = new Set();
        const mergedUniqueJiras = new Set();
        const mergedUniqueFailureReasons = new Set();
        const mergedUniqueTestCases = new Set();

        if (phase.coverage_types) {
            phase.coverage_types.forEach(ct => {
                // Merge unique lists
                (ct.unique_cr_list || []).forEach(cr => mergedUniqueCRs.add(cr));
                (ct.unique_jira_list || []).forEach(jira => mergedUniqueJiras.add(jira));
                (ct.unique_failure_reasons || []).forEach(reason => mergedUniqueFailureReasons.add(reason));
                (ct.unique_test_cases || []).forEach(testCase => mergedUniqueTestCases.add(testCase));
            });
        } else {
            // Merge unique lists directly from phase
            (phase.unique_cr_list || []).forEach(cr => mergedUniqueCRs.add(cr));
            (phase.unique_jira_list || []).forEach(jira => mergedUniqueJiras.add(jira));
            (phase.unique_failure_reasons || []).forEach(reason => mergedUniqueFailureReasons.add(reason));
            (phase.unique_test_cases || []).forEach(testCase => mergedUniqueTestCases.add(testCase));
        }

        // Convert sets to sorted arrays
        const uniqueCRList = Array.from(mergedUniqueCRs).sort();
        const uniqueJiraList = Array.from(mergedUniqueJiras).sort();
        const uniqueFailureReasonsList = Array.from(mergedUniqueFailureReasons).sort();
        const uniqueTestCasesList = Array.from(mergedUniqueTestCases).sort();

        accumDetails.push({
            phase: phase.phase,
            unique_cr_list: uniqueCRList,
            unique_cr_count: uniqueCRList.length,
            unique_jira_list: uniqueJiraList,
            unique_jira_count: uniqueJiraList.length,
            unique_failure_reasons_list: uniqueFailureReasonsList,
            unique_failure_reasons_count: uniqueFailureReasonsList.length,
            unique_test_cases_list: uniqueTestCasesList,
            unique_test_cases_count: uniqueTestCasesList.length
        });

        return accumDetails;
    }, []);

    return {
        details: processedDetails
    };
}

function createInnerTable1ExpandButton() {
    const expandBtn = document.createElement('button');
    expandBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#328AA4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-plus-circle">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="16"></line>
        <line x1="8" y1="12" x2="16" y2="12"></line>
    </svg>`;
    expandBtn.className = 'inner-table-1-expand-btn';
    expandBtn.style.cssText = `
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.2s ease;
    `;
    
    return expandBtn;
}

function createInnerTable1CollapseButton() {
    const collapseBtn = document.createElement('button');
    collapseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#328AA4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-minus-circle">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="8" y1="12" x2="16" y2="12"></line>
    </svg>`;
    collapseBtn.className = 'inner-table-1-collapse-btn';
    collapseBtn.style.cssText = `
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.2s ease;
    `;
    
    return collapseBtn;
}

function renderInnerTable1(data, targetRow) {
    // Create a new row that spans all columns
    const innerTableRow = document.createElement('tr');
    innerTableRow.className = 'inner-table-1-row';
    
    const innerTableCell = document.createElement('td');
    innerTableCell.setAttribute('colspan', '15'); // Match total number of columns in main table
    
    const innerTable = document.createElement('table');
    innerTable.className = 'inner-table-1';
    innerTable.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        margin: 10px;
    `;
    
    // Create header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    const headers = [
        'Phase', 
        'Unique CRs', 
        'Unique JIRAs', 
        'Failure Reasons', 
        'Unique Test Cases'
    ];
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        th.style.cssText = `
            background-color: #328AA4;
            color: white;
            padding: 8px;
            border: 1px solid #ddd;
        `;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    innerTable.appendChild(thead);
    
    // Create body
    const tbody = document.createElement('tbody');
    data.details.forEach(detail => {
        const tr = document.createElement('tr');
        
        // Phase
        const phaseTd = document.createElement('td');
        phaseTd.textContent = detail.phase;
        phaseTd.style.cssText = `
            padding: 8px;
            border: 1px solid #ddd;
        `;
        tr.appendChild(phaseTd);
        
        // Unique CRs
        const crTd = document.createElement('td');
        crTd.innerHTML = formatLongList(detail.unique_cr_list, detail.unique_cr_count);
        crTd.style.cssText = `
            padding: 8px;
            border: 1px solid #ddd;
        `;
        tr.appendChild(crTd);
        
        // Unique JIRAs
        const jiraTd = document.createElement('td');
        jiraTd.innerHTML = formatLongList(detail.unique_jira_list, detail.unique_jira_count);
        jiraTd.style.cssText = `
            padding: 8px;
            border: 1px solid #ddd;
        `;
        tr.appendChild(jiraTd);
        
        // Failure Reasons
        const failureReasonsTd = document.createElement('td');
        failureReasonsTd.innerHTML = formatLongList(detail.unique_failure_reasons_list, detail.unique_failure_reasons_count);
        failureReasonsTd.style.cssText = `
            padding: 8px;
            border: 1px solid #ddd;
        `;
        tr.appendChild(failureReasonsTd);
        
        // Unique Test Cases
        const testCasesTd = document.createElement('td');
        testCasesTd.innerHTML = formatLongList(detail.unique_test_cases_list, detail.unique_test_cases_count);
        testCasesTd.style.cssText = `
            padding: 8px;
            border: 1px solid #ddd;
        `;
        tr.appendChild(testCasesTd);
        
        tbody.appendChild(tr);
    });
    
    innerTable.appendChild(tbody);
    innerTableCell.appendChild(innerTable);
    innerTableRow.appendChild(innerTableCell);
    
    // Insert the new row after the clicked row
    targetRow.parentNode.insertBefore(innerTableRow, targetRow.nextSibling);
}

// Modify the existing renderCoverageTable function to add expand/collapse
function renderCoverageTable(data, targetElementId) {
    // ... existing renderCoverageTable code ...

    // After creating table rows, add this to modify expand column
    data.forEach(sp => {
        sp.teams.forEach(team => {
            team.phases.forEach((phase, phaseIndex) => {
                // Find the row corresponding to this phase
                const rows = tbody.querySelectorAll('tr');
                const phaseRow = rows[phaseIndex];
                
                if (phaseRow) {
                    // First column (empty in original) becomes expand/collapse column
                    const expandTd = document.createElement('td');
                    const expandBtn = createInnerTable1ExpandButton();
                    
                    expandBtn.addEventListener('click', (e) => {
                        const selectedTeam = document.querySelector('input[name="team-filter"]:checked').value;
                        
                        // Calculate inner table data
                        const innerTableData = calculateInnerTable1Metrics(sp, selectedTeam);
                        
                        if (innerTableData) {
                            // Check if inner table already exists
                            const existingInnerTable = phaseRow.nextElementSibling;
                            const isInnerTableExists = existingInnerTable && 
                                existingInnerTable.classList.contains('inner-table-1-row');
                            
                            if (!isInnerTableExists) {
                                // Render inner table
                                renderInnerTable1(innerTableData, phaseRow);
                                
                                // Replace expand button with collapse button
                                expandTd.innerHTML = '';
                                const collapseBtn = createInnerTable1CollapseButton();
                                collapseBtn.addEventListener('click', () => {
                                    // Remove inner table row
                                    const innerTableRow = phaseRow.nextElementSibling;
                                    if (innerTableRow && innerTableRow.classList.contains('inner-table-1-row')) {
                                        innerTableRow.remove();
                                        
                                        // Replace collapse button with expand button
                                        expandTd.innerHTML = '';
                                        expandTd.appendChild(expandBtn);
                                    }
                                });
                                expandTd.appendChild(collapseBtn);
                            }
                        }
                    });
                    
                    expandTd.appendChild(expandBtn);
                    phaseRow.insertBefore(expandTd, phaseRow.firstChild);
                }
            });
        });
    });

    // Rest of the existing renderCoverageTable code remains the same
}
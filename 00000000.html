def download_excel(request):
    selected_sp = request.GET.get('sp_name', '')
    if not selected_sp:
        return JsonResponse({'status': 'error', 'error_msg': 'No SP name provided'})
    
    file_path = os.path.join(ConfigPaths.download_excel_files, "coverage_reports", f"{selected_sp}_coverage_report.xlsx")
    
    if not os.path.exists(file_path):
        error_msg = f"File not found for SP: {selected_sp}"
        return JsonResponse({'status': 'error', 'error_msg': error_msg})
    
    # Check if the file is a valid Excel file
    try:
        # Verify the file can be opened with openpyxl
        openpyxl.load_workbook(file_path)
    except Exception as e:
        return JsonResponse({
            'status': 'error', 
            'error_msg': f"Invalid Excel file: {str(e)}"
        }, status=500)
    
    # Serve the file
    try:
        with open(file_path, 'rb') as file:
            file_data = file.read()
            
        # Use FileResponse instead of HttpResponse for better file handling
        response = FileResponse(
            open(file_path, 'rb'),
            content_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )
        filename = f"{selected_sp}_coverage_report.xlsx"
        response['Content-Disposition'] = f'attachment; filename="{filename}"'
        return response
    except Exception as e:
        return JsonResponse({
            'status': 'error', 
            'error_msg': f"File download error: {str(e)}"
        }, status=500)
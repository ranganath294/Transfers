// Update the event listener for the SP select
spSelect.addEventListener('change', function() {
    // Get all selected options
    const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
    // Filter out any empty values
    const spNames = selectedOptions.filter(name => name);
    
    const tableContainer = document.getElementById('table-container');
    const tableBody = document.getElementById('table-body');
    const tableHeaders = document.getElementById('table-headers');

    // Clear existing content
    tableBody.innerHTML = '';
    
    // Completely rebuild the table header (including removing any existing header rows)
    const thead = tableHeaders.parentNode;
    thead.innerHTML = ''; // Remove all existing header rows
    
    // Create the main headers row
    const mainHeaderRow = document.createElement('tr');
    mainHeaderRow.id = 'table-headers';
    mainHeaderRow.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
    thead.appendChild(mainHeaderRow);

    if (spNames.length > 0) {
        // Add loading state
        tableContainer.classList.add('table-loading');

        // Create the URL with multiple sp_name parameters
        const params = new URLSearchParams();
        spNames.forEach(name => {
            params.append('sp_name', name);
        });

        fetch(`/get_counts_new/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');
                
                // Get all metrics (keys of the data object)
                const metrics = Object.keys(data);
                
                if (metrics.length > 0) {
                    // Collect all SPs and their teams
                    const spTeams = {};
                    metrics.forEach(metric => {
                        Object.keys(data[metric]).forEach(sp => {
                            if (!spTeams[sp]) {
                                spTeams[sp] = new Set();
                            }
                            Object.keys(data[metric][sp]).forEach(team => {
                                spTeams[sp].add(team);
                            });
                        });
                    });
                    
                    // Check if we need a second header row for teams
                    let needTeamHeaders = false;
                    Object.values(spTeams).forEach(teams => {
                        if (teams.size > 1) needTeamHeaders = true;
                    });
                    
                    // Create SP headers (with colspan if needed)
                    Object.keys(spTeams).forEach(sp => {
                        const teams = Array.from(spTeams[sp]);
                        
                        if (teams.length > 1) {
                            // SP with multiple teams - add colspan header
                            const spHeader = document.createElement('th');
                            spHeader.setAttribute('colspan', teams.length);
                            spHeader.setAttribute('scope', 'colgroup');
                            spHeader.textContent = sp;
                            spHeader.style.borderBottom = needTeamHeaders ? '1px solid #dee2e6' : 'none';
                            mainHeaderRow.appendChild(spHeader);
                        } else if (teams.length === 1) {
                            // SP with just one team - simpler header
                            const spHeader = document.createElement('th');
                            spHeader.setAttribute('scope', 'col');
                            spHeader.textContent = sp;
                            mainHeaderRow.appendChild(spHeader);
                        }
                    });
                    
                    // Create second row for team headers if needed
                    if (needTeamHeaders) {
                        const teamHeaderRow = document.createElement('tr');
                        teamHeaderRow.innerHTML = '<th class="metrics-cell"></th>'; // Empty cell above metrics
                        
                        Object.keys(spTeams).forEach(sp => {
                            const teams = Array.from(spTeams[sp]);
                            teams.forEach(team => {
                                const teamHeader = document.createElement('th');
                                teamHeader.setAttribute('scope', 'col');
                                teamHeader.textContent = team;
                                teamHeaderRow.appendChild(teamHeader);
                            });
                        });
                        
                        thead.appendChild(teamHeaderRow);
                    }
                    
                    // Create data rows
                    metrics.forEach((metric, rowIndex) => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('id', `data-row-${rowIndex}`);
                        
                        const metricsTd = document.createElement('td');
                        metricsTd.setAttribute('id', `metrics-cell-${rowIndex}`);
                        metricsTd.textContent = metric;
                        metricsTd.className = 'metrics-cell';
                        tr.appendChild(metricsTd);
                        
                        // Add cells for each SP and team
                        Object.keys(spTeams).forEach(sp => {
                            const teams = Array.from(spTeams[sp]);
                            teams.forEach(team => {
                                const td = document.createElement('td');
                                const value = data[metric][sp]?.[team] ?? '';
                                td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                                tr.appendChild(td);
                            });
                        });
                        
                        tableBody.appendChild(tr);
                    });
                } else {
                    // No data case
                    const emptyRow = document.createElement('tr');
                    emptyRow.innerHTML = '<td colspan="2" class="table-empty">No data available</td>';
                    tableBody.appendChild(emptyRow);
                }
            })
            .catch(error => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');
                console.error('Error:', error);
                addAlert('danger', `Error loading data. Please try again.`);
                
                // Show empty state
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = '<td colspan="2" class="table-empty">Error loading data</td>';
                tableBody.appendChild(emptyRow);
            });
    } else {
        // No SP selected
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = '<td colspan="2" class="table-empty">Please select at least one SP to view metrics</td>';
        tableBody.appendChild(emptyRow);
        
        addAlert('warning', `Please select at least one SP to view metrics`);
    }
});

// Helper function to show alerts
function addAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    
    // Clear existing alerts
    const existingAlerts = alertContainer.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}
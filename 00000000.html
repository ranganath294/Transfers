<!-- Change the select to allow multiple selections -->
<div id="sp-selector" class="select-container">
    <label for="sp-select" class="form-label">Select SP:</label>
    <select id="sp-select" name="sp_name" class="form-select" multiple>
        <option value="">--No SP Selected--</option>
        {% for sp_name in sp_names %}
            <option value="{{ sp_name }}" {% if sp_name == selected_sp %}selected{% endif %}>{{ sp_name }}</option>
        {% endfor %}
    </select>
</div>









document.getElementById('sp-select').addEventListener('change', function() {
    // Get all selected options
    const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
    // Filter out any empty values
    const spNames = selectedOptions.filter(name => name);
    
    const tableContainer = document.getElementById('table-container');

    if (spNames.length > 0) {
        // Add loading state
        tableContainer.classList.add('table-loading');

        // Create the URL with multiple sp_name parameters
        const params = new URLSearchParams();
        spNames.forEach(name => {
            params.append('sp_name', name);
        });

        fetch(`/get_counts/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');

                // Rest of your code to populate the table
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';
                const tableHeaders = document.getElementById('table-headers');
                tableHeaders.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
                
                if (data.length > 0) {
                    const teams = Object.keys(data[0]).filter(key => key !== 'Metrics');
                    teams.forEach((team, index) => {
                        const th = document.createElement('th');
                        th.setAttribute('id', `team-header-${index}`);
                        th.setAttribute('scope', 'col');
                        th.textContent = team;
                        tableHeaders.appendChild(th);
                    });
                    
                    data.forEach((row, rowIndex) => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('id', `data-row-${rowIndex}`);
                        
                        const metricsTd = document.createElement('td');
                        metricsTd.setAttribute('id', `metrics-cell-${rowIndex}`);
                        metricsTd.textContent = row.Metrics;
                        metricsTd.className = 'metrics-cell';
                        tr.appendChild(metricsTd);
                        
                        teams.forEach((team, colIndex) => {
                            const td = document.createElement('td');
                            td.setAttribute('id', `data-cell-${rowIndex}-${colIndex}`);
                            const value = row[team] !== undefined ? row[team] : '';
                            td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                            tr.appendChild(td);
                        });
                        
                        tableBody.appendChild(tr);
                    });
                }
            })
            .catch(error => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');

                console.error('Error:', error);
                addAlert('danger', `Error loading data. Please try again.`);
            });
    } else {
        addAlert('danger', `Please select at least one SP to view metrics`);
    }
});

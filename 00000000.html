<div id="alert-container" class="alert-container px-5">
</div>
<div id="main-container" class="container container-fluid">
    <h1 id="page-title" class="page-title">SP Metrics Report</h1>
    
    <div id="sp-selector" class="select-container">
        <label for="sp-select" class="form-label">Select SP:</label>
        <select id="sp-select" name="sp_name" class="form-select">
            <option value="">--No SP Selected--</option>
            {% for sp_name in sp_names %}
                <option value="{{ sp_name }}" {% if sp_name == selected_sp %}selected{% endif %}>{{ sp_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="table-container" class="table-responsive">
        <table id="metrics-table" class="table table-hover">
            <thead>
                <tr id="table-headers">
                    <th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>
</div>

<script>
    document.getElementById('sp-select').addEventListener('change', function() {
        const spName = this.value;
        const tableContainer = document.getElementById('table-container');

        if (spName) {
            // Add loading state
            tableContainer.classList.add('table-loading');

            fetch(`/get_counts/?sp_name=${encodeURIComponent(spName)}`)
                .then(response => response.json())
                .then(data => {
                    // Remove loading state
                    tableContainer.classList.remove('table-loading');

                    const tableBody = document.getElementById('table-body');
                    tableBody.innerHTML = '';
                    const tableHeaders = document.getElementById('table-headers');
                    tableHeaders.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
                    
                    if (data.length > 0) {
                        const teams = Object.keys(data[0]).filter(key => key !== 'Metrics');
                        teams.forEach((team, index) => {
                            const th = document.createElement('th');
                            th.setAttribute('id', `team-header-${index}`);
                            th.setAttribute('scope', 'col');
                            th.textContent = team;
                            tableHeaders.appendChild(th);
                        });
                        
                        data.forEach((row, rowIndex) => {
                            const tr = document.createElement('tr');
                            tr.setAttribute('id', `data-row-${rowIndex}`);
                            
                            const metricsTd = document.createElement('td');
                            metricsTd.setAttribute('id', `metrics-cell-${rowIndex}`);
                            metricsTd.textContent = row.Metrics;
                            metricsTd.className = 'metrics-cell';
                            tr.appendChild(metricsTd);
                            
                            teams.forEach((team, colIndex) => {
                                const td = document.createElement('td');
                                td.setAttribute('id', `data-cell-${rowIndex}-${colIndex}`);
                                const value = row[team] !== undefined ? row[team] : '';
                                td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                                tr.appendChild(td);
                            });
                            
                            tableBody.appendChild(tr);
                        });
                    }
                })
                .catch(error => {
                    // Remove loading state
                    tableContainer.classList.remove('table-loading');

                    console.error('Error:', error);
                    const tableBody = document.getElementById('table-body');
                    tableBody.innerHTML = '<tr><td id="error-message" colspan="100%" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
                });
        } else {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '<tr><td id="empty-message" colspan="100%" class="table-empty">Please select an SP to view metrics</td></tr>';
            const tableHeaders = document.getElementById('table-headers');
            tableHeaders.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
        }
    });
</script>
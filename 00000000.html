data = [
    {
        "sp_name": "Pakala.LA.2.0",
        "teams": [
            {
                "team_name": "BT",
                "phases": [
                    {
                        "phase": "ES",
                        "date": "01-03-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 100.0,
                                    "passed_percentage": 92.5,
                                    "failed_percentage": 7.5,
                                    "blocked_percentage": 0.0,
                                    "total": 40,
                                    "passed": 37,
                                    "failed": 3,
                                    "blocked": 0,
                                    "coverage": 40,
                                },
                                "unique_issue_count": 1,
                                "unique_issue_list": ["CR-4011766"],
                                "unique_cr_list": ["CR-4011766"],
                                "unique_cr_count": 1,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                    {
                        "phase": "FC",
                        "date": "02-28-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 100.0,
                                    "passed_percentage": 98.52507374631269,
                                    "failed_percentage": 1.4749262536873156,
                                    "blocked_percentage": 0.0,
                                    "total": 1356,
                                    "passed": 1336,
                                    "failed": 20,
                                    "blocked": 0,
                                    "coverage": 1356,
                                },
                                "unique_issue_count": 14,
                                "unique_issue_list": [
                                    "CR-4047945",
                                    "CR-4044927",
                                    "CR-4030113",
                                    "CR-4060809",
                                    "QSTABILITY-19198607",
                                    "CR-3947816",
                                    "CR-4046179",
                                    "CR-4053323",
                                    "CR-4022868",
                                    "CR-3980650",
                                    "CR-3986878",
                                    "CR-3957027",
                                    "CR-4039680",
                                    "CR-4036880",
                                ],
                                "unique_cr_list": [
                                    "CR-4047945",
                                    "CR-4044927",
                                    "CR-4030113",
                                    "CR-4060809",
                                    "CR-3947816",
                                    "CR-4046179",
                                    "CR-4053323",
                                    "CR-4022868",
                                    "CR-3980650",
                                    "CR-3986878",
                                    "CR-3957027",
                                    "CR-4039680",
                                    "CR-4036880",
                                ],
                                "unique_cr_count": 13,
                                "unique_jira_list": ["QSTABILITY-19198607"],
                                "unique_jira_count": 1,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                    {
                        "phase": "CS",
                        "date": "04-15-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 4.280155642023346,
                                    "passed_percentage": 0.9727626459143969,
                                    "failed_percentage": 3.3073929961089497,
                                    "blocked_percentage": 22.37354085603113,
                                    "total": 514,
                                    "passed": 5,
                                    "failed": 17,
                                    "blocked": 115,
                                    "coverage": 22,
                                },
                                "unique_issue_count": 4,
                                "unique_issue_list": [
                                    "CR-4030113",
                                    "CR-4060809",
                                    "CNSSDEBUG-4850649",
                                    "CR-4046249",
                                ],
                                "unique_cr_list": [
                                    "CR-4030113",
                                    "CR-4060809",
                                    "CR-4046249",
                                ],
                                "unique_cr_count": 3,
                                "unique_jira_list": ["CNSSDEBUG-4850649"],
                                "unique_jira_count": 1,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                ],
            },
            {
                "team_name": "WLAN",
                "phases": [
                    {
                        "phase": "ES",
                        "date": "01-03-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                    {
                        "phase": "FC",
                        "date": "02-28-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 100.0,
                                    "passed_percentage": 97.27668845315904,
                                    "failed_percentage": 2.7233115468409586,
                                    "blocked_percentage": 0.0,
                                    "total": 918,
                                    "passed": 893,
                                    "failed": 25,
                                    "blocked": 0,
                                    "coverage": 918,
                                },
                                "unique_issue_count": 11,
                                "unique_issue_list": [
                                    "CNSSDEBUG-4842212",
                                    "CR-4057870",
                                    "CR-4038136",
                                    "CR-4009220",
                                    "CR-4053968",
                                    "CR-4031898",
                                    "CR-4056760",
                                    "QSTABILITY-19197265",
                                    "QSTABILITY-19197266",
                                    "CR-4031774",
                                    "CR-4033440",
                                ],
                                "unique_cr_list": [
                                    "CR-4057870",
                                    "CR-4038136",
                                    "CR-4009220",
                                    "CR-4053968",
                                    "CR-4031898",
                                    "CR-4056760",
                                    "CR-4031774",
                                    "CR-4033440",
                                ],
                                "unique_cr_count": 8,
                                "unique_jira_list": [
                                    "CNSSDEBUG-4842212",
                                    "QSTABILITY-19197265",
                                    "QSTABILITY-19197266",
                                ],
                                "unique_jira_count": 3,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0,
                                    "passed_percentage": 0,
                                    "failed_percentage": 0,
                                    "blocked_percentage": 0,
                                    "total": 0,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                    {
                        "phase": "CS",
                        "date": "04-15-2025",
                        "coverage_types": [
                            {
                                "coverage_type": "Legacy",
                                "metrics": {
                                    "coverage_percentage": 27.35191637630662,
                                    "passed_percentage": 0.0,
                                    "failed_percentage": 27.35191637630662,
                                    "blocked_percentage": 0.34843205574912894,
                                    "total": 574,
                                    "passed": 0,
                                    "failed": 157,
                                    "blocked": 2,
                                    "coverage": 157,
                                },
                                "unique_issue_count": 1,
                                "unique_issue_list": ["CR-4040350"],
                                "unique_cr_list": ["CR-4040350"],
                                "unique_cr_count": 1,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                            {
                                "coverage_type": "NewFR",
                                "metrics": {
                                    "coverage_percentage": 0.0,
                                    "passed_percentage": 0.0,
                                    "failed_percentage": 0.0,
                                    "blocked_percentage": 0.0,
                                    "total": 3,
                                    "passed": 0,
                                    "failed": 0,
                                    "blocked": 0,
                                    "coverage": 0,
                                },
                                "unique_issue_count": 0,
                                "unique_issue_list": [],
                                "unique_cr_list": [],
                                "unique_cr_count": 0,
                                "unique_jira_list": [],
                                "unique_jira_count": 0,
                            },
                        ],
                    },
                ],
            },
        ],
    }
]

import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter
import os
import sys
import pandas as pd

sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..', '..', '..')))
from config_paths import ConfigPaths
from CNSS_Metrics.utils import get_filtered_active_sps, get_phase_dates_csv, get_sp_df
from CNSS_Metrics.cst_reporting_views.scripts.active_sps_view import prepare_table_data_active_sps

class ExcelFormatter:
    @staticmethod
    def format_percentage(value):
        return round(value, 2)

    @staticmethod
    def set_cell(ws, row, col, value, merge_range=None, bold=False, bg_color=None, font_color='000000'):
        cell = ws.cell(row=row, column=col, value=value)
        cell.alignment = Alignment(horizontal='center', vertical='center')
        cell.font = Font(bold=bold, color=font_color)
        cell.border = Border(
            left=Side(style='thin'), right=Side(style='thin'), 
            top=Side(style='thin'), bottom=Side(style='thin')
        )
        if bg_color:
            cell.fill = PatternFill(start_color=bg_color, end_color=bg_color, fill_type="solid")
        if merge_range:
            ws.merge_cells(start_row=merge_range[0], start_column=col, end_row=merge_range[1], end_column=col)

class RowSpanCalculator:
    @staticmethod
    def calculate_sp_rowspan(sp):
        return sum(RowSpanCalculator.calculate_team_rowspan(team) for team in sp['teams'])

    @staticmethod
    def calculate_team_rowspan(team):
        return sum(RowSpanCalculator.calculate_phase_rowspan(phase) for phase in team['phases'])

    @staticmethod
    def calculate_phase_rowspan(phase):
        return max(1, len(phase.get('coverage_types', [{}])))  # At least 1 row per phase

class DataFetcher:
    @staticmethod
    def get_projection_table(df, sp_name, test_team, test_phase):
        result = df[(df['SP Name'] == sp_name) & 
                    (df['Test Team'] == test_team) & 
                    (df['Test Phase'] == test_phase)]
        if result.empty or result['Projection_Table'].isnull().all():
            return None
        else:
            return result['Projection_Table'].values[0]

class ExcelWriter:
    def __init__(self, ws):
        self.ws = ws

    def write_coverage_data(self, data):
        row = 3  # Start from the second row (headers are in row 1)
        for sp in data:
            sp_rowspan = RowSpanCalculator.calculate_sp_rowspan(sp)
            sp_start_row = row  # Track SP start row
            for team in sp['teams']:
                team_rowspan = RowSpanCalculator.calculate_team_rowspan(team)
                team_start_row = row  # Track Team start row
                for phase in team['phases']:
                    phase_rowspan = RowSpanCalculator.calculate_phase_rowspan(phase)
                    for i, coverage_type in enumerate(phase.get('coverage_types', [{}])):
                        # Merge and write SP Name (only once per SP)
                        if row == sp_start_row:
                            ExcelFormatter.set_cell(self.ws, row, 1, sp['sp_name'], merge_range=(sp_start_row, sp_start_row + sp_rowspan - 1))
                        # Merge and write Team Name (only once per Team)
                        if row == team_start_row:
                            ExcelFormatter.set_cell(self.ws, row, 2, team['team_name'], merge_range=(team_start_row, team_start_row + team_rowspan - 1))
                        # Merge and write Date (only once per Phase)
                        if i == 0:
                            ExcelFormatter.set_cell(self.ws, row, 3, phase['date'], merge_range=(row, row + phase_rowspan - 1))
                        # Merge and write Phase (only once per Phase)
                        if i == 0:
                            ExcelFormatter.set_cell(self.ws, row, 4, phase['phase'], merge_range=(row, row + phase_rowspan - 1))
                        # Coverage Type
                        ExcelFormatter.set_cell(self.ws, row, 5, coverage_type.get('coverage_type', ''))
                        # Metrics
                        metrics = coverage_type.get('metrics', {})
                        ExcelFormatter.set_cell(self.ws, row, 6, metrics.get('total', 0))
                        ExcelFormatter.set_cell(self.ws, row, 7, metrics.get('coverage', 0))
                        ExcelFormatter.set_cell(self.ws, row, 8, ExcelFormatter.format_percentage(metrics.get('coverage_percentage', 0)))
                        ExcelFormatter.set_cell(self.ws, row, 9, metrics.get('passed', 0))
                        ExcelFormatter.set_cell(self.ws, row, 10, ExcelFormatter.format_percentage(metrics.get('passed_percentage', 0)))
                        ExcelFormatter.set_cell(self.ws, row, 11, metrics.get('failed', 0))
                        ExcelFormatter.set_cell(self.ws, row, 12, ExcelFormatter.format_percentage(metrics.get('failed_percentage', 0)))
                        ExcelFormatter.set_cell(self.ws, row, 13, metrics.get('blocked', 0))
                        ExcelFormatter.set_cell(self.ws, row, 14, ExcelFormatter.format_percentage(metrics.get('blocked_percentage', 0)))
                        # Unique Issues Issued
                        ExcelFormatter.set_cell(self.ws, row, 15, coverage_type.get('unique_issue_count', 0))
                        row += 1  # Move to the next row
        return row

    def write_team_phase_summary(self, data, start_row):
        projected_percentages_csvs_mapping_csv_path = os.path.join(ConfigPaths.ref_dir, "projected_percentages_csvs_mapping.csv")
        projected_percentages_df = pd.read_csv(projected_percentages_csvs_mapping_csv_path, low_memory=False)
        row = start_row
        for sp in data:
            for team in sp['teams']:
                for phase in team['phases']:
                    print("##################################")
                    print(sp["sp_name"])
                    print(team["team_name"])
                    print(phase["phase"])
                    projected_percentages_csv_name = DataFetcher.get_projection_table(projected_percentages_df, sp["sp_name"], team["team_name"], phase["phase"])
                    print(projected_percentages_csv_name)
                    projected_percentages_csv_path = None
                    if projected_percentages_csv_name:
                        projected_percentages_csv_path = os.path.join(ConfigPaths.root_dir, "downloaded_projectionsheets", projected_percentages_csv_name)
                    if projected_percentages_csv_path and os.path.exists(projected_percentages_csv_path):
                        projection_data_df = pd.read_csv(projected_percentages_csv_path, low_memory=False)
                        # Rename the first column header to "Date" if it's "Unnamed: 0"
                        if 'Unnamed: 0' in projection_data_df.columns:
                            projection_data_df.rename(columns={'Unnamed: 0': 'Date'}, inplace=True)
                        # Convert percentage strings to numbers, ignoring non-numeric values
                        for col in projection_data_df.columns:
                            if projection_data_df[col].dtype == 'object':
                                if col != 'Date':  # Skip conversion for the 'Date' column or any other string columns
                                    projection_data_df[col] = pd.to_numeric(projection_data_df[col].str.rstrip('%'), errors='coerce')
                        # Write Team Phase Summary Header
                        header = f"{team['team_name']} Test Summary {phase['phase']}"
                        ExcelFormatter.set_cell(self.ws, row, 1, header, bold=True, merge_range=(row, row), font_color="0000FF")
                        row += 1
                        # Define headers for the summary table
                        summary_headers = [
                            "Name", "Total TCs", "Coverage", "Coverage %", "Passed", "Pass %", "Failed", "Fail %", "Blocked", "Block %", "Unique CRs", "Unique JIRAs"
                        ]
                        # Write headers to the worksheet
                        for col_num, header in enumerate(summary_headers, 1):
                            ExcelFormatter.set_cell(self.ws, row, col_num, header, bold=True, bg_color="003366", font_color="FFFFFF")
                        row += 1
                        for coverage_type in phase.get('coverage_types', [{}]):
                            ExcelFormatter.set_cell(self.ws, row, 1, coverage_type.get('coverage_type', ''))
                            metrics = coverage_type.get('metrics', {})
                            ExcelFormatter.set_cell(self.ws, row, 2, metrics.get('total', 0))
                            ExcelFormatter.set_cell(self.ws, row, 3, metrics.get('coverage', 0))
                            ExcelFormatter.set_cell(self.ws, row, 4, ExcelFormatter.format_percentage(metrics.get('coverage_percentage', 0)))
                            ExcelFormatter.set_cell(self.ws, row, 5, metrics.get('passed', 0))
                            ExcelFormatter.set_cell(self.ws, row, 6, ExcelFormatter.format_percentage(metrics.get('passed_percentage', 0)))
                            ExcelFormatter.set_cell(self.ws, row, 7, metrics.get('failed', 0))
                            ExcelFormatter.set_cell(self.ws, row, 8, ExcelFormatter.format_percentage(metrics.get('failed_percentage', 0)))
                            ExcelFormatter.set_cell(self.ws, row, 9, metrics.get('blocked', 0))
                            ExcelFormatter.set_cell(self.ws, row, 10, ExcelFormatter.format_percentage(metrics.get('blocked_percentage', 0)))
                            unique_cr_list_comma_seperated_string = ', '.join(coverage_type.get('unique_cr_list', []))
                            unique_jira_list_comma_seperated_string = ', '.join(coverage_type.get('unique_jira_list', []))
                            ExcelFormatter.set_cell(self.ws, row, 11, f"{coverage_type.get('unique_cr_count', 0)} ({unique_cr_list_comma_seperated_string})")
                            ExcelFormatter.set_cell(self.ws, row, 12, f"{coverage_type.get('unique_jira_count', 0)} ({unique_jira_list_comma_seperated_string})")
                            row += 1
                        row += 1  # Add a blank row between summaries
                        # Write Projection Data Header
                        projection_header = f"{team['team_name']} {phase['phase']} Coverage Projection and Status"
                        ExcelFormatter.set_cell(self.ws, row, 1, projection_header, bold=True, merge_range=(row, row), font_color="0000FF")
                        row += 1
                        # Write projection data DataFrame to the worksheet
                        for col_num, header in enumerate(projection_data_df.columns, 1):
                            ExcelFormatter.set_cell(self.ws, row, col_num, header, bold=True, bg_color="003366", font_color="FFFFFF")
                        row += 1
                        for _, row_data in projection_data_df.iterrows():
                            for col_num, value in enumerate(row_data, 1):
                                ExcelFormatter.set_cell(self.ws, row, col_num, value)
                            row += 1
                        row += 2  # Add a blank row after projection data
        return row

def generate_coverage_summary_xl(sp_name):
    selected_team = "All"
    selected_phase = "All"
    phases = ['ES', 'FC', 'CS']
    phase_dates_df = get_phase_dates_csv() 
    
    all_tc_df = pd.DataFrame()
    all_tc_df = get_sp_df(sp_name, phase_dates_df, selected_team, selected_phase, all_tc_df)

    data = prepare_table_data_active_sps(all_tc_df, phases, phase_dates_df, include_values=True, include_coverage_types=True)
    
    # Create a new workbook and select the active worksheet
    wb = openpyxl.Workbook()
    ws = wb.active
    ws.title = "Coverage Report"

    # Define headers
    headers = [
        "SP Name", "Test Team", "Date", "Phase", "Coverage Type",
        "Total TCs", "Coverage", "Coverage %", "Passed", "Pass %",
        "Failed", "Fail %", "Blocked", "Block %", "Unique Issues Issued"
    ]
    header = "Coverage Report - Level - 3 Based"
    ExcelFormatter.set_cell(ws, 1, 1, header, bold=True, merge_range=(1, 1), font_color="0000FF")

    # Write headers to the worksheet
    for col_num, header in enumerate(headers, 1):
        ExcelFormatter.set_cell(ws, 2, col_num, header, bold=True, bg_color="328AA4", font_color="FFFFFF")

    # Write coverage data to the worksheet and return the last row
    excel_writer = ExcelWriter(ws)
    current_row = excel_writer.write_coverage_data(data) + 2  # Start after the main data table

    # Write team phase summaries to the worksheet and return the last row
    current_row = excel_writer.write_team_phase_summary(data, current_row) + 2 

    # Adjust column widths
    max_length_limit = 30
    for col in ws.columns:
        max_length = 0
        column = col[0].column_letter  # Get column letter
        for cell in col:
            try:
                if cell.value:
                    max_length = max(max_length, len(str(cell.value)))
            except:
                pass
        # Cap the max_length at the specified limit
        max_length = min(max_length, max_length_limit)
        ws.column_dimensions[column].width = (max_length + 2) * 1.2  # Adjust width

    # Save the workbook
    wb.save(r"C:\Dropbox\To Laptop\New folder\00000_coverage_report.xlsx")




# sp_name = "Pakala.LA.2.0"
sp_name = "Kaanapali.LA.1.0"

generate_coverage_summary_xl(sp_name)

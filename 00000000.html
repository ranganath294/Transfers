document.getElementById('sp_name').addEventListener('change', function() {
    const spName = this.value;
    const tableResponsive = document.querySelector('.table-responsive');
    
    if (spName) {
        // Add loading state
        tableResponsive.classList.add('table-loading');
        
        fetch(`/get_counts/?sp_name=${spName}`)
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                tableResponsive.classList.remove('table-loading');
                // ... rest of your existing code ...
            })
            .catch(error => {
                // Remove loading state
                tableResponsive.classList.remove('table-loading');
                console.error('Error:', error);
                const tableBody = document.querySelector('#counts_table tbody');
                tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-danger">Error loading data. Please try again.</td></tr>';
            });
    } else {
        const tableBody = document.querySelector('#counts_table tbody');
        tableBody.innerHTML = '<tr><td colspan="100%" class="table-empty">Please select an SP to view metrics</td></tr>';
        const tableHead = document.querySelector('#counts_table thead tr');
        tableHead.innerHTML = '<th scope="col" class="metrics-cell">Metrics</th>';
    }
});
// Add event listener for Graphs button
graphsInput.addEventListener('change', async () => {
    if (graphsInput.checked) {
        console.log('Graphs clicked');
        const spSelect = document.getElementById('sp_name');
        const selectedSp = spSelect.value;
        const selectedTeam = document.querySelector('input[name="team-filter"]:checked').value;

        if (!selectedSp) {
            addAlert('danger', 'Please select an SP first');
            return;
        }

        contentContainer.innerHTML = ''; // Clear the content container
        
        // Create a single card structure for graphs view
        const graphCardElement = document.createElement('div');
        graphCardElement.className = 'card mb-3';

        // Create card body
        const graphCardBody = document.createElement('div');
        graphCardBody.className = 'card-body';
        
        // Create phase filter container for graphs view
        const phaseFilterContainer = document.createElement('div');
        phaseFilterContainer.className = 'mb-3'; // Add margin bottom for spacing

        // Create button group for phase filters with 4px gap
        const graphPhaseButtonGroup = document.createElement('div');
        graphPhaseButtonGroup.className = 'btn-group';
        graphPhaseButtonGroup.setAttribute('role', 'group');
        graphPhaseButtonGroup.setAttribute('aria-label', 'Phase filters');
        graphPhaseButtonGroup.style.gap = '4px'; // Add 4px gap between buttons
        
        // Create phase filter buttons
        const phases = ['all', 'ES', 'FC', 'CS'];
        phases.forEach(phase => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `btn btn-outline-primary graph-phase-filter ${phase === 'all' ? 'active' : ''}`;
            button.setAttribute('data-phase', phase);
            button.textContent = phase === 'all' ? 'All Phases' : phase;
            graphPhaseButtonGroup.appendChild(button);
        });
        
        // Create graph content container
        const graphContentContainer = document.createElement('div');
        graphContentContainer.id = 'graphContentContainer';
        graphContentContainer.className = 'mt-3'; // Add margin top for spacing
        
        // Append elements to the card
        phaseFilterContainer.appendChild(graphPhaseButtonGroup);
        graphCardBody.appendChild(phaseFilterContainer);
        graphCardBody.appendChild(graphContentContainer);
        graphCardElement.appendChild(graphCardBody);
        
        // Append card to the main content container
        contentContainer.appendChild(graphCardElement);
        
        // Add event listeners for phase filter buttons
        graphPhaseButtonGroup.addEventListener('click', async (e) => {
            if (e.target.classList.contains('graph-phase-filter')) {
                // Remove active class from all buttons
                graphPhaseButtonGroup.querySelectorAll('.graph-phase-filter').forEach(btn => btn.classList.remove('active'));
                // Add active class to the clicked button
                e.target.classList.add('active');
                // Get the selected phase
                const selectedPhase = e.target.getAttribute('data-phase');
                
                // Clear the graph content container
                graphContentContainer.innerHTML = '';
                
                // Create loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'text-center mt-3';
                loadingIndicator.textContent = 'Loading graphs...';
                graphContentContainer.appendChild(loadingIndicator);
                
                // Fetch and render graphs with the selected phase
                await fetchAndRenderGraphs(selectedSp, selectedTeam, selectedPhase, graphContentContainer);
                
                // Remove loading indicator
                loadingIndicator.remove();
            }
        });
        
        // Fetch and render graphs with default 'all' phase
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'text-center mt-3';
        loadingIndicator.textContent = 'Loading graphs...';
        graphContentContainer.appendChild(loadingIndicator);
        
        await fetchAndRenderGraphs(selectedSp, selectedTeam, 'all', graphContentContainer);
        
        // Remove loading indicator
        loadingIndicator.remove();
    }
});

// Function to fetch and render graphs based on selected parameters
async function fetchAndRenderGraphs(selectedSp, selectedTeam, selectedPhase, container) {
    const params = new URLSearchParams();
    params.append('sp_name', selectedSp);
    params.append('team', selectedTeam);
    params.append('phase', selectedPhase);
    
    try {
        const response = await fetch(`{% url 'cst_reporting_views:get_graph_image' %}?${params.toString()}`);
        if (!response.ok) throw new Error('Network response was not ok');

        const data = await response.json();
        const images = data.images || [];

        if (images.length === 0) {
            const noGraphMessage = document.createElement('div');
            noGraphMessage.textContent = 'Graph not available for selected phase';
            noGraphMessage.className = 'text-center mt-3';
            container.appendChild(noGraphMessage);
        } else {
            // Create a container for the images
            const imageContainer = document.createElement('div');
            imageContainer.className = 'graph-images-container';
            
            images.forEach((imageData, index) => {
                // Create a figure element to hold image and caption
                const figure = document.createElement('figure');
                figure.className = 'figure mb-4'; // Add margin bottom for spacing between images
                
                // Create an image element
                const img = document.createElement('img');
                img.className = 'figure-img img-fluid rounded'; // Add Bootstrap classes for responsive image
                img.alt = imageData.title || `Graph Image ${index + 1}`;
                
                // Set the src attribute of the image to the base64 data
                img.src = `data:image/jpg;base64,${imageData.graph_image}`;
                
                // Create title caption
                const figureCaption = document.createElement('figcaption');
                figureCaption.className = 'figure-caption text-center fw-bold';
                figureCaption.textContent = imageData.title || `Graph ${index + 1}`;
                
                // Append elements to figure
                figure.appendChild(img);
                figure.appendChild(figureCaption);
                
                // Append figure to image container
                imageContainer.appendChild(figure);
            });
            
            // Append the image container to the main container
            container.appendChild(imageContainer);
        }
    } catch (error) {
        console.error('Error fetching graph images:', error);
        addAlert('danger', `Error fetching graph images. Please try again.\n ${error}`);
    }
}
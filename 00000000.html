{% extends 'base.html' %}
{% block content %}
<style>
    /* Container styles */
    .container {
        padding: 2rem;
        max-width: 100%;
    }

    /* Select dropdown styles */
    .select-container {
        margin-bottom: 2rem;
    }

    .form-select {
        max-width: 300px;
        border: 1px solid #dee2e6;
        padding: 0.5rem;
        border-radius: 4px;
    }

    /* Enhanced table container styles */
    .table-responsive {
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: inline-block;
        min-width: min-content;
        border: 1px solid #dee2e6;
        overflow: hidden; /* Maintains border-radius with table inside */
    }

    /* Enhanced table styles */
    .table {
        margin-bottom: 0;
        width: auto !important;
        min-width: 0 !important;
        border-collapse: separate;
        border-spacing: 0;
    }

    /* Header styles */
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        white-space: nowrap;
        border: 1px solid #dee2e6;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 1;
        color: #2c3e50;
    }

    /* Cell styles */
    .table td {
        vertical-align: middle;
        border: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }

    /* Metrics column styling */
    .metrics-cell {
        background-color: #e8f4ff;
        font-weight: 500;
        color: #1e90ff !important;
        white-space: nowrap;
        padding-right: 1.5rem !important;
        border-right: 2px solid #dee2e6 !important; /* Emphasize metrics column */
    }

    th.metrics-cell{
        background-color: #f7f9fa !important;
        color: #2c3e50 !important;
        font-weight: 600 !important;
    }

    /* Other columns */
    .table th:not(:first-child),
    .table td:not(:first-child) {
        text-align: center;
        white-space: nowrap;
        min-width: 100px; /* Ensures minimum column width */
    }

    /* Hover effect */
    .table tbody tr:hover {
        background-color: rgba(232, 244, 255, 0.3);
    }

    /* Title styling */
    .page-title {
        color: #2c3e50;
        margin-bottom: 2rem;
        font-weight: 600;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
        .container {
            padding: 1.5rem;
        }
        
        .table th,
        .table td {
            padding: 0.75rem;
        }
    }

    @media (max-width: 768px) {
        .container {
            padding: 1rem;
        }
        
        .metrics-cell {
            padding-right: 1rem !important;
        }
        
        .table td:not(:first-child), 
        .table th:not(:first-child) {
            padding: 0.5rem;
            min-width: 80px;
        }
        
        .table-responsive {
            margin: 0 -1rem;
            border-radius: 0;
            border-left: none;
            border-right: none;
        }
    }

    /* Loading state */
    .table-loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Empty state */
    .table-empty {
        padding: 2rem;
        text-align: center;
        color: #6c757d;
    }
</style>

<div id="alert-container" class="alert-container px-5">
</div>
<div id="main-container" class="container container-fluid">
    <h1 id="page-title" class="page-title">SP Metrics Report</h1>

    <div id="sp-selector" class="select-container">
        <label for="sp-select" class="form-label">Select SP:</label>
        <select id="sp-select" name="sp_name" class="form-select" multiple>
            {% for sp_name in sp_names %}
                <option value="{{ sp_name }}" {% if sp_name == selected_sp %}selected{% endif %}>{{ sp_name }}</option>
            {% endfor %}
        </select>
    </div>

    <div id="table-container" class="table-responsive">
        <table id="metrics-table" class="table table-hover">
            <thead>
                <tr id="table-headers">
                    <th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>
    </div>
</div>



<style>
    /* Enhanced multi-select dropdown styling */
    .optimized-select-wrapper {
        position: relative;
        width: 100%;
    }
    
    /* Button styling */
    .optimized-select-button {
        width: 100%;
        text-align: left;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-height: 38px;
        background-color: #fff;
        border: 1px solid #ced4da;
        position: relative;
        padding-right: 2rem;
    }
    
    .optimized-select-button::after {
        content: '';
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 0;
        height: 0;
        border-left: 5px solid transparent;
        border-right: 5px solid transparent;
        border-top: 5px solid #6c757d;
    }
    
    /* Improved dropdown container */
    .optimized-select-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        z-index: 1000;
        margin-top: 0.25rem;
        overflow: hidden;
    }
    
    /* Selected items styling */
    .selected-items-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        padding: 0.75rem;
        min-height: 0;
        max-height: 6rem;
        overflow-y: auto;
        border-bottom: 1px solid #eee;
        background-color: #f8f9fa;
    }
    
    .selected-item {
        display: flex;
        align-items: center;
        background-color: #e7f2ff;
        border: 1px solid #d0e2ff;
        border-radius: 3rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        transition: all 0.2s ease;
        user-select: none;
    }
    
    .selected-item:hover {
        background-color: #d0e2ff;
    }
    
    .selected-item-label {
        margin-right: 0.25rem;
    }
    
    .selected-item-remove {
        margin-left: 0.3rem;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        width: 1rem;
        height: 1rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-weight: bold;
        border-radius: 50%;
        transition: all 0.2s ease;
    }
    
    .selected-item-remove:hover {
        color: #dc3545;
        background-color: rgba(0, 0, 0, 0.05);
    }
    
    /* Search input styling */
    .optimized-select-search {
        width: 100%;
        padding: 0.75rem;
        border: none;
        border-bottom: 1px solid #eee;
        border-radius: 0;
        outline: none;
    }
    
    .optimized-select-search:focus {
        box-shadow: none;
        border-color: #eee;
    }
    
    /* Options container */
    .optimized-select-options {
        overflow-y: auto;
        position: relative;
        max-height: calc(35px * 8); /* Based on item height and max visible items */
    }
    
    .virtual-scroll-container {
        position: relative;
    }
    
    /* Option styling */
    .optimized-select-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        position: absolute;
        width: 100%;
        display: flex;
        align-items: center;
        transition: background-color 0.15s ease;
    }
    
    .optimized-select-option:hover {
        background-color: #f3f9ff;
    }
    
    .optimized-select-option.selected {
        background-color: #e9f3ff;
        font-weight: 500;
    }
    
    .optimized-select-option.selected::before {
        content: 'âœ“';
        margin-right: 0.5rem;
        color: #0d6efd;
        font-weight: bold;
    }
    
    /* Scrollbar styling */
    .optimized-select-options::-webkit-scrollbar {
        width: 8px;
    }
    
    .optimized-select-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }
    
    .optimized-select-options::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }
    
    .optimized-select-options::-webkit-scrollbar-thumb:hover {
        background: #999;
    }
    
    /* Empty state */
    .empty-options {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
    }
    
    /* Responsive styling */
    @media (max-width: 768px) {
        .selected-item {
            padding: 0.2rem 0.5rem;
            font-size: 0.8rem;
        }
        
        .selected-item-remove {
            margin-left: 0.2rem;
        }
        
        .optimized-select-search {
            padding: 0.5rem;
        }
    }
</style>


<script>
    // Enhanced OptimizedMultiSelect with better UI
    class OptimizedMultiSelect {
        static counter = 0; // Static counter to ensure unique ID
        constructor(originalSelect, options = {}) {
            if(originalSelect.dataset.initialized){
                return;
            }
            this.originalSelect = originalSelect;
            this.options = {
                itemHeight: 35,
                maxVisibleItems: 8,
                ...options
            };
            this.itemHeight = this.options.itemHeight;
            this.maxVisibleItems = this.options.maxVisibleItems;
            this.allOptions = Array.from(originalSelect.options)
                .filter(opt => opt.value) // Filter out empty values
                .map(opt => ({
                    value: opt.value,
                    label: opt.text,
                    selected: opt.selected
                }));
            this.selectedValues = new Set();
            this.isOpen = false;
            originalSelect.dataset.initialized = 'true';
            // Generate a unique elementId
            this.elementId = `${originalSelect.id}-optimized-select`;
            
            // Initialize selected values from original select
            Array.from(originalSelect.selectedOptions).forEach(option => {
                if (option.value) {
                    this.selectedValues.add(option.value);
                }
            });
            
            this.init();
        }
        
        init() {
            // Create wrapper
            this.wrapper = document.createElement('div');
            this.wrapper.className = 'optimized-select-wrapper';
            this.wrapper.id = `${this.elementId}-wrapper`;
            
            // Create button with selected items display
            this.button = document.createElement('button');
            this.button.className = 'optimized-select-button form-select';
            this.button.id = `${this.elementId}-button`;
            this.button.type = 'button'; // Prevent form submission
            
            // Create selected summary text
            this.selectedSummary = document.createElement('span');
            this.selectedSummary.className = 'selected-summary';
            this.button.appendChild(this.selectedSummary);
            
            // Create dropdown container
            this.dropdown = document.createElement('div');
            this.dropdown.className = 'optimized-select-dropdown';
            this.dropdown.id = `${this.elementId}-dropdown`;
            
            // Create search input
            this.searchInput = document.createElement('input');
            this.searchInput.className = 'optimized-select-search form-control';
            this.searchInput.id = `${this.elementId}-search`;
            this.searchInput.placeholder = 'Search...';
            
            // Create selected items container - position it correctly
            this.selectedItemsContainer = document.createElement('div');
            this.selectedItemsContainer.className = 'selected-items-container';
            this.selectedItemsContainer.id = `${this.elementId}-selected-items`;
            
            // Create options container
            this.optionsContainer = document.createElement('div');
            this.optionsContainer.className = 'optimized-select-options';
            this.optionsContainer.id = `${this.elementId}-options`;
            
            // Create virtual scroll container
            this.virtualScroll = document.createElement('div');
            this.virtualScroll.className = 'virtual-scroll-container';
            this.virtualScroll.id = `${this.elementId}-virtual-scroll`;
            
            // Assemble the components in the correct order
            this.dropdown.appendChild(this.selectedItemsContainer);
            this.dropdown.appendChild(this.searchInput);
            this.dropdown.appendChild(this.optionsContainer);
            this.optionsContainer.appendChild(this.virtualScroll);
            this.wrapper.appendChild(this.button);
            this.wrapper.appendChild(this.dropdown);
            
            // Insert custom select after original
            this.originalSelect.style.display = 'none';
            this.originalSelect.parentNode.insertBefore(this.wrapper, this.originalSelect.nextSibling);
            
            this.addEventListeners();
            this.updateButtonText();
            this.updateSelectedItemsDisplay();
        }
        
        addEventListeners() {
            // Toggle dropdown with improved handling
            this.button.addEventListener('mousedown', (e) => {
                e.preventDefault(); // Prevent focus issues
                this.toggleDropdown();
            });
            
            // Handle search
            this.searchInput.addEventListener('input', () => {
                this.filterAndRenderOptions();
            });
            
            // Handle keyboard navigation
            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeDropdown();
                }
            });
            
            // Prevent search input from closing dropdown
            this.searchInput.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });
            
            // Handle scroll
            this.optionsContainer.addEventListener('scroll', () => {
                this.renderVisibleOptions();
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('mousedown', (e) => {
                if (!this.wrapper.contains(e.target)) {
                    this.closeDropdown();
                }
            });
            
            // Prevent dropdown from closing when clicking inside
            this.dropdown.addEventListener('mousedown', (e) => {
                e.stopPropagation();
            });
        }
        
        toggleDropdown() {
            if (this.isOpen) {
                this.closeDropdown();
            } else {
                this.openDropdown();
            }
        }
        
        openDropdown() {
            this.isOpen = true;
            this.dropdown.style.display = 'block';
            this.searchInput.focus();
            this.updateSelectedItemsDisplay();
            this.filterAndRenderOptions();
        }
        
        closeDropdown() {
            this.isOpen = false;
            this.dropdown.style.display = 'none';
            this.searchInput.value = '';
        }
        
        filterAndRenderOptions() {
            const searchTerm = this.searchInput.value.toLowerCase();
            this.filteredOptions = this.allOptions.filter(option => 
                option.label.toLowerCase().includes(searchTerm)
            );
            
            // Reset scroll position
            this.optionsContainer.scrollTop = 0;
            
            // Handle empty state
            if (this.filteredOptions.length === 0) {
                this.virtualScroll.innerHTML = '<div class="empty-options">No options found</div>';
                return;
            }
            
            // Calculate the height based on the number of filtered options
            const height = Math.min(this.filteredOptions.length, this.maxVisibleItems) * this.itemHeight;
            this.optionsContainer.style.height = `${height}px`;
            this.virtualScroll.style.height = `${this.filteredOptions.length * this.itemHeight}px`;
            
            this.renderVisibleOptions();
        }
        
        renderVisibleOptions() {
            const scrollTop = this.optionsContainer.scrollTop;
            const startIndex = Math.floor(scrollTop / this.itemHeight);
            const endIndex = startIndex + this.maxVisibleItems + 2;
            
            this.virtualScroll.innerHTML = '';
            this.filteredOptions.slice(startIndex, endIndex).forEach((option, index) => {
                const optionEl = document.createElement('div');
                optionEl.className = 'optimized-select-option';
                if (this.selectedValues.has(option.value)) {
                    optionEl.classList.add('selected');
                }
                
                const labelEl = document.createElement('span');
                labelEl.textContent = option.label;
                optionEl.appendChild(labelEl);
                
                optionEl.style.position = 'absolute';
                optionEl.style.top = `${(startIndex + index) * this.itemHeight}px`;
                optionEl.style.height = `${this.itemHeight}px`;
                
                optionEl.addEventListener('mousedown', (e) => {
                    e.preventDefault(); // Prevent focus issues
                    this.toggleOption(option);
                });
                
                this.virtualScroll.appendChild(optionEl);
            });
        }
        
        toggleOption(option) {
            if (this.selectedValues.has(option.value)) {
                this.selectedValues.delete(option.value);
            } else {
                this.selectedValues.add(option.value);
            }
            
            this.updateOriginalSelect();
            this.updateSelectedItemsDisplay();
            this.updateButtonText();
            this.renderVisibleOptions(); // Re-render to update selected state
        }
        
        updateOriginalSelect() {
            // Update original select element
            Array.from(this.originalSelect.options).forEach(option => {
                option.selected = this.selectedValues.has(option.value);
            });
            
            // Dispatch change event
            this.originalSelect.dispatchEvent(new Event('change'));
        }
        
        updateSelectedItemsDisplay() {
            this.selectedItemsContainer.innerHTML = '';
            
            // Always show the container but hide when empty
            if (this.selectedValues.size === 0) {
                this.selectedItemsContainer.style.display = 'none';
                return;
            }
            
            this.selectedItemsContainer.style.display = 'flex';
            
            this.allOptions
                .filter(option => this.selectedValues.has(option.value))
                .forEach(option => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'selected-item';
                    
                    const labelEl = document.createElement('span');
                    labelEl.className = 'selected-item-label';
                    labelEl.textContent = option.label;
                    itemEl.appendChild(labelEl);
                    
                    const removeEl = document.createElement('span');
                    removeEl.className = 'selected-item-remove';
                    removeEl.innerHTML = '&times;'; // Cross mark
                    removeEl.setAttribute('role', 'button');
                    removeEl.setAttribute('aria-label', `Remove ${option.label}`);
                    removeEl.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.selectedValues.delete(option.value);
                        this.updateOriginalSelect();
                        this.updateSelectedItemsDisplay();
                        this.updateButtonText();
                        this.renderVisibleOptions();
                    });
                    
                    itemEl.appendChild(removeEl);
                    this.selectedItemsContainer.appendChild(itemEl);
                });
        }
        
        updateButtonText() {
            const selected = this.allOptions.filter(option => this.selectedValues.has(option.value));
            
            if (selected.length === 0) {
                this.selectedSummary.textContent = 'Choose options...';
            } else if (selected.length === 1) {
                this.selectedSummary.textContent = selected[0].label;
            } else {
                this.selectedSummary.textContent = `${selected.length} items selected`;
            }
        }
    }
    
    // Initialize the multi-select when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const spSelect = document.getElementById('sp-select');
        if (spSelect) {
            const multiSelect = new OptimizedMultiSelect(spSelect);
        }
    });
</script>

<script>
    // Initialize the multi-select when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const spSelect = document.getElementById('sp-select');
        const multiSelect = new OptimizedMultiSelect(spSelect);
        
        // Update the event listener for the SP select
        spSelect.addEventListener('change', function() {
            // Get all selected options
            const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
            // Filter out any empty values
            const spNames = selectedOptions.filter(name => name);
            
            const tableContainer = document.getElementById('table-container');

            if (spNames.length > 0) {
                // Add loading state
                tableContainer.classList.add('table-loading');

                // Create the URL with multiple sp_name parameters
                const params = new URLSearchParams();
                spNames.forEach(name => {
                    params.append('sp_name', name);
                });

                fetch(`/get_counts_new/?${params.toString()}`)
                    .then(response => response.json())
                    .then(data => {
                        // Remove loading state
                        tableContainer.classList.remove('table-loading');

                        // Rest of your code to populate the table
                        const tableBody = document.getElementById('table-body');
                        tableBody.innerHTML = '';
                        const tableHeaders = document.getElementById('table-headers');
                        tableHeaders.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
                        
                        if (data.length > 0) {
                            const teams = Object.keys(data[0]).filter(key => key !== 'Metrics');
                            teams.forEach((team, index) => {
                                const th = document.createElement('th');
                                th.setAttribute('id', `team-header-${index}`);
                                th.setAttribute('scope', 'col');
                                th.textContent = team;
                                tableHeaders.appendChild(th);
                            });
                            
                            data.forEach((row, rowIndex) => {
                                const tr = document.createElement('tr');
                                tr.setAttribute('id', `data-row-${rowIndex}`);
                                
                                const metricsTd = document.createElement('td');
                                metricsTd.setAttribute('id', `metrics-cell-${rowIndex}`);
                                metricsTd.textContent = row.Metrics;
                                metricsTd.className = 'metrics-cell';
                                tr.appendChild(metricsTd);
                                
                                teams.forEach((team, colIndex) => {
                                    const td = document.createElement('td');
                                    td.setAttribute('id', `data-cell-${rowIndex}-${colIndex}`);
                                    const value = row[team] !== undefined ? row[team] : '';
                                    td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                                    tr.appendChild(td);
                                });
                                
                                tableBody.appendChild(tr);
                            });
                        }
                    })
                    .catch(error => {
                        // Remove loading state
                        tableContainer.classList.remove('table-loading');

                        console.error('Error:', error);
                        addAlert('danger', `Error loading data. Please try again.`);
                    });
            } else {
                addAlert('danger', `Please select at least one SP to view metrics`);
            }
        });
    });
</script>
{% endblock %}

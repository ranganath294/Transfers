query = f"""
        WITH RankedResults AS (
            SELECT 
                p.*, 
                e.[Execution DUT],
                e.[Result],
                e.[Issues],
                e.[Execution Date],
                e.[Actual Tester Name],
                e.[Execution Build],
                e.[TC Added By] AS executedby, 
                e.[TC Added On] AS executedon, 
                ROW_NUMBER() OVER (PARTITION BY p.[SP Planning ID] ORDER BY e.[TC Added On] DESC) AS rn, 
                STUFF(
                    (
                        SELECT ', ' + e2.[Issues] 
                        FROM [QCABD].[wlanspbot].[tblSPExecutionResults_Production] AS e2 
                        WHERE e2.[SP_Planned_TCID] = p.[SP Planning ID] 
                        FOR XML PATH(''), TYPE
                    ).value('.', 'NVARCHAR(MAX)'), 1, 2, ''
                ) AS [All_Issues] 
            FROM 
                [QCABD].[wlanspbot].[tblSPPlanning_Production] AS p 
            LEFT JOIN 
                [QCABD].[wlanspbot].[tblSPExecutionResults_Production] AS e 
            ON 
                p.[SP Planning ID] = e.[SP_Planned_TCID] 
            {query_filter}
        ) 
        SELECT 
            * 
        FROM 
            RankedResults 
        WHERE 
            rn = 1 
        ORDER BY 
            executedon DESC;

        """

 query_filter = f"WHERE [SP Name] in ({sp_list})" if sp_list else ""

i want to optimise this query.

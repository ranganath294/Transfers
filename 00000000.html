import openpyxl
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from openpyxl.utils import get_column_letter

# Function to format percentage
def format_percentage(value):
    # return f"{value:.2f}%"
    return round(value, 2)

# Function to calculate row spans
def calculate_sp_rowspan(sp):
    return sum(calculate_team_rowspan(team) for team in sp['teams'])

def calculate_team_rowspan(team):
    return sum(calculate_phase_rowspan(phase) for phase in team['phases'])

def calculate_phase_rowspan(phase):
    return len(phase.get('coverage_types', [{}]))

# Function to write data to the worksheet
def write_data_to_worksheet(ws, data):
    row = 2
    for sp in data:
        sp_rowspan = calculate_sp_rowspan(sp)
        sp_start_row = row  # Track the starting row for SP
        for team in sp['teams']:
            team_rowspan = calculate_team_rowspan(team)
            team_start_row = row  # Track the starting row for Team
            for phase in team['phases']:
                phase_rowspan = calculate_phase_rowspan(phase)
                for i, coverage_type in enumerate(phase.get('coverage_types', [{}])):
                    # SP Name
                    if i == 0:
                        ws.cell(row=row, column=1, value=sp['sp_name']).border = Border(
                            left=Side(style='thin'), 
                            right=Side(style='thin'), 
                            top=Side(style='thin'), 
                            bottom=Side(style='thin')
                        )
                        ws.merge_cells(start_row=sp_start_row, start_column=1, end_row=sp_start_row + sp_rowspan - 1, end_column=1)
                    
                    # Team Name
                    if i == 0:
                        ws.cell(row=row, column=2, value=team['team_name']).border = Border(
                            left=Side(style='thin'), 
                            right=Side(style='thin'), 
                            top=Side(style='thin'), 
                            bottom=Side(style='thin')
                        )
                        ws.merge_cells(start_row=team_start_row, start_column=2, end_row=team_start_row + team_rowspan - 1, end_column=2)
                    
                    # Date
                    if i == 0:
                        ws.cell(row=row, column=3, value=phase['date']).border = Border(
                            left=Side(style='thin'), 
                            right=Side(style='thin'), 
                            top=Side(style='thin'), 
                            bottom=Side(style='thin')
                        )
                        ws.merge_cells(start_row=row, start_column=3, end_row=row + phase_rowspan - 1, end_column=3)
                    
                    # Phase
                    if i == 0:
                        ws.cell(row=row, column=4, value=phase['phase']).border = Border(
                            left=Side(style='thin'), 
                            right=Side(style='thin'), 
                            top=Side(style='thin'), 
                            bottom=Side(style='thin')
                        )
                        ws.merge_cells(start_row=row, start_column=4, end_row=row + phase_rowspan - 1, end_column=4)
                    
                    # Coverage Type
                    ws.cell(row=row, column=5, value=coverage_type.get('coverage_type', '')).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    
                    # Metrics
                    metrics = coverage_type.get('metrics', {})
                    ws.cell(row=row, column=6, value=metrics.get('total', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=7, value=metrics.get('coverage', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=8, value=format_percentage(metrics.get('coverage_percentage', 0))).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=9, value=metrics.get('passed', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=10, value=format_percentage(metrics.get('passed_percentage', 0))).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=11, value=metrics.get('failed', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=12, value=format_percentage(metrics.get('failed_percentage', 0))).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=13, value=metrics.get('blocked', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    ws.cell(row=row, column=14, value=format_percentage(metrics.get('blocked_percentage', 0))).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    # Unique Issues Issued
                    ws.cell(row=row, column=15, value=coverage_type.get('unique_issue_count', 0)).border = Border(
                        left=Side(style='thin'), 
                        right=Side(style='thin'), 
                        top=Side(style='thin'), 
                        bottom=Side(style='thin')
                    )
                    row += 1

# Create a new workbook and select the active worksheet
wb = openpyxl.Workbook()
ws = wb.active
ws.title = "Coverage Report"

# Define headers
headers = [
    "SP Name", "Test Team", "Date", "Phase", "Coverage Type",
    "Total TCs", "Coverage", "Coverage %", "Passed", "Pass %",
    "Failed", "Fail %", "Blocked", "Block %", "Unique Issues Issued"
]

# Write headers to the worksheet
for col_num, header in enumerate(headers, 1):
    cell = ws.cell(row=1, column=col_num, value=header)
    cell.font = Font(bold=True)
    cell.alignment = Alignment(horizontal='center')
    cell.fill = PatternFill(start_color="328AA4", end_color="328AA4", fill_type="solid")
    cell.border = Border(
        left=Side(style='thin'), 
        right=Side(style='thin'), 
        top=Side(style='thin'), 
        bottom=Side(style='thin')
    )

# Write data to the worksheet
write_data_to_worksheet(ws, data)

# Adjust column widths
for col in ws.columns:
    max_length = 0
    column = col[0].column_letter
    for cell in col:
        try:
            if len(str(cell.value)) > max_length:
                max_length = len(cell.value)
        except:
            pass
    adjusted_width = (max_length + 2) * 1.2
    ws.column_dimensions[column].width = adjusted_width

# Save the workbook
wb.save(r"C:\Dropbox\To Laptop\New folder\00000_coverage_report.xlsx")

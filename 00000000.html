{% extends 'base.html' %}
{% block content %}
<div class="container container-fluid">
    <!-- Previous header content remains the same until table -->
    <div class="table-responsive">
        <table id="activeSpsTable" class="table table-bordered table-hover">
            <thead class="thead-light">
                <tr>
                    <th rowspan="2">SP Name</th>
                    <th rowspan="2">Test Team</th>
                    <th rowspan="2">Date</th>
                    <th rowspan="2">Phase</th>
                    <th colspan="9">Legacy</th>
                    <th colspan="9">NewFR</th>
                </tr>
                <tr>
                    <!-- Legacy metrics -->
                    <th>Total TCs</th>
                    <th>Coverage</th>
                    <th>Coverage %</th>
                    <th>Passed</th>
                    <th>Pass %</th>
                    <th>Failed</th>
                    <th>Fail %</th>
                    <th>Blocked</th>
                    <th>Block %</th>
                    <!-- NewFR metrics -->
                    <th>Total TCs</th>
                    <th>Coverage</th>
                    <th>Coverage %</th>
                    <th>Passed</th>
                    <th>Pass %</th>
                    <th>Failed</th>
                    <th>Fail %</th>
                    <th>Blocked</th>
                    <th>Block %</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>
</div>

<style>
/* Previous styles remain the same */

.coverage-type-cells {
    background-color: rgba(0, 0, 0, 0.01);
}

.table thead tr:first-child th {
    background-color: #e9ecef;
    text-align: center;
    border-bottom: 2px solid #dee2e6;
}

/* Add border between coverage types */
.coverage-type-separator {
    border-left: 2px solid #dee2e6;
}

/* Make only the first four columns left-aligned */
.table th:nth-child(-n+4),
.table td:nth-child(-n+4) {
    text-align: left;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Previous initialization code remains the same

    function createMetricsCells(coverageInfo, coverageType, spName, teamName, phase) {
        const baseTooltip = `${spName} ${teamName} ${phase} ${coverageType}`;
        return `
            <td class="tooltip-cell metric-cell ${coverageType === 'NewFR' ? 'coverage-type-separator' : ''}">
                ${coverageInfo.metrics.total || 0}
                <span class="custom-tooltip">${baseTooltip} Total ${coverageInfo.metrics.total}</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${coverageInfo.metrics.coverage || 0}
                <span class="custom-tooltip">${baseTooltip} Coverage ${coverageInfo.metrics.coverage}</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${formatPercent(coverageInfo.metrics.coverage_percentage)}%
                <span class="custom-tooltip">${baseTooltip} Coverage ${formatPercent(coverageInfo.metrics.coverage_percentage)}%</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${coverageInfo.metrics.passed || 0}
                <span class="custom-tooltip">${baseTooltip} Passed ${coverageInfo.metrics.passed}</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${formatPercent(coverageInfo.metrics.passed_percentage)}%
                <span class="custom-tooltip">${baseTooltip} Pass ${formatPercent(coverageInfo.metrics.passed_percentage)}%</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${coverageInfo.metrics.failed || 0}
                <span class="custom-tooltip">${baseTooltip} Failed ${coverageInfo.metrics.failed}</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${formatPercent(coverageInfo.metrics.failed_percentage)}%
                <span class="custom-tooltip">${baseTooltip} Fail ${formatPercent(coverageInfo.metrics.failed_percentage)}%</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${coverageInfo.metrics.blocked || 0}
                <span class="custom-tooltip">${baseTooltip} Blocked ${coverageInfo.metrics.blocked}</span>
            </td>
            <td class="tooltip-cell metric-cell">
                ${formatPercent(coverageInfo.metrics.blocked_percentage)}%
                <span class="custom-tooltip">${baseTooltip} Block ${formatPercent(coverageInfo.metrics.blocked_percentage)}%</span>
            </td>
        `;
    }
    
    function renderTable() {
        if (!tableData) return;
        
        tableBody.innerHTML = '';
        let rowCounter = 0;
        
        tableData.forEach((spData, spIndex) => {
            let firstSpRow = true;
            const filteredTeams = spData.teams.filter(team => 
                selectedTeams.includes('all') || selectedTeams.includes(team.team_name)
            );
            
            filteredTeams.forEach((team, teamIndex) => {
                let firstTeamRow = true;
                
                team.phases.forEach((phase, phaseIndex) => {
                    let row = document.createElement('tr');
                    row.className = 'phase-row';
                    row.setAttribute('data-row-index', rowCounter++);
                    row.setAttribute('data-sp-index', spIndex);
                    row.setAttribute('data-team-index', teamIndex);
                    row.setAttribute('data-team', team.team_name);
                    row.setAttribute('data-phase', phase.phase);
                    row.setAttribute('data-sp-name', spData.sp_name);
                    
                    if (firstSpRow) {
                        let spCell = document.createElement('td');
                        spCell.rowSpan = filteredTeams.reduce((acc, t) => 
                            acc + t.phases.length, 0);
                        spCell.innerHTML = `
                            <a href="/sp-execution-data?sp=${spData.sp_name}" target="_blank">
                                ${spData.sp_name}
                            </a>
                        `;
                        spCell.setAttribute('data-sp-cell', 'true');
                        row.appendChild(spCell);
                        firstSpRow = false;
                    }
                    
                    if (firstTeamRow) {
                        let teamCell = document.createElement('td');
                        teamCell.rowSpan = team.phases.length;
                        teamCell.textContent = team.team_name;
                        teamCell.setAttribute('data-team-cell', 'true');
                        row.appendChild(teamCell);
                        firstTeamRow = false;
                    }
                    
                    // Add Date and Phase
                    row.insertAdjacentHTML('beforeend', `
                        <td>${phase.date}</td>
                        <td>${phase.phase}</td>
                    `);
                    
                    // Add metrics for each coverage type
                    phase.coverage_types.forEach(coverageType => {
                        row.insertAdjacentHTML(
                            'beforeend', 
                            createMetricsCells(
                                coverageType,
                                coverageType.coverage_type,
                                spData.sp_name,
                                team.team_name,
                                phase.phase
                            )
                        );
                    });
                    
                    tableBody.appendChild(row);
                });
            });
        });
        
        addRowHighlighting();
    }
    
    // Previous highlighting code remains the same
});
</script>
{% endblock %}
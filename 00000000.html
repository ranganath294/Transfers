function downloadReport(reportType) {
            const spSelect = document.getElementById('sp_name');
            const selectedSp = spSelect.value;
            if (!selectedSp) {
                addAlert('danger', 'Please select an SP first');
                return;
            }
            
            const params = new URLSearchParams();
            params.append('sp_name', selectedSp);
            params.append('reportType', reportType);

            if (reportType === 'sp_report') {
                const teamName = document.querySelector('input[name="team-filter"]:checked').value;
                const phaseName = document.querySelector('.sp-report-phase-filter.active').getAttribute('data-phase');
                if (!teamName || !phaseName) {
                    addAlert('danger', 'Please select a team and phase first');
                    return;
                }
                params.append('team_name', teamName);
                params.append('phase_name', phaseName);
            }
            
            fetch(`{% url 'cst_reporting_views:download_file' %}?${params.toString()}`)
                .then(response => {
                    // Check if response is JSON (error) or file (success)
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            throw new Error(data.error_msg || 'Download failed');
                        });
                    }
                    
                    if (!response.ok) {
                        throw new Error('Download failed with status: ' + response.status);
                    }
                    
                    // Extract filename from Content-Disposition header
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = '';
                    if (contentDisposition && contentDisposition.includes('filename=')) {
                        filename = contentDisposition.split('filename=')[1].replace(/['"]/g, '');
                    } else {
                        // Determine the file extension based on the content type
                        const contentTypeToExtensionMap = {
                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
                            'text/csv': 'csv',
                            'application/vnd.openxmlformats-officedocument.presentationml.presentation': 'pptx',
                            'image/png': 'png',
                            'image/jpeg': 'jpg',
                            'application/pdf': 'pdf',
                            // Add more mappings as needed
                        };
                        const extension = contentTypeToExtensionMap[contentType] || 'unknown';
                        filename = `${selectedSp}_${reportType}.${extension}`;
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                })
                .then(({ blob, filename }) => {
                    console.log("Blob type:", blob.type);
                    console.log("Blob size:", blob.size);
                    
                    // Double-check that we actually received a valid file
                    if (blob.size === 0) {
                        throw new Error("Received empty file");
                    }
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    addAlert('success', `${filename} downloaded successfully!`);
                })
                .catch(error => {
                    console.error("Download error:", error);
                    addAlert('danger', `Error: ${error.message}`);
                });
        }

// Update the validateInput function to handle SELECT elements
function validateInput(input) {
    // Handle SELECT elements specifically
    if (input.tagName === 'SELECT') {
        const validationMessage = document.getElementById(`${input.id}-validation`) || 
            createValidationMessage(input);
            
        if (!input.value) {
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
            validationMessage.textContent = 'Please select an option';
            validationMessage.style.display = 'block';
            
            // Also update the OptimizedSelect button styling
            const customButton = input.nextElementSibling.querySelector('.optimized-select-button');
            if (customButton) {
                customButton.classList.add('is-invalid');
                customButton.classList.remove('is-valid');
            }
            return false;
        }
        
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        validationMessage.style.display = 'none';
        
        // Update the OptimizedSelect button styling
        const customButton = input.nextElementSibling.querySelector('.optimized-select-button');
        if (customButton) {
            customButton.classList.remove('is-invalid');
            customButton.classList.add('is-valid');
        }
        return true;
    }

    // Rest of the existing validation logic for other input types
    if (!input.tagName || !['INPUT', 'TEXTAREA'].includes(input.tagName)) {
        return true;
    }
    // ... (rest of the existing validation code)
}

// Helper function to create validation message element
function createValidationMessage(input) {
    const validationMessage = document.createElement('div');
    validationMessage.className = 'invalid-feedback';
    validationMessage.id = `${input.id}-validation`;
    input.parentNode.appendChild(validationMessage);
    return validationMessage;
}

// Update the OptimizedSelect class to include validation
class OptimizedSelect {
    constructor(originalSelect, options = {}) {
        // ... (existing constructor code)
        
        // Add validation styling to button
        this.button.classList.add('form-select');
        
        // Add change event listener for validation
        this.originalSelect.addEventListener('change', () => {
            validateInput(this.originalSelect);
        });
    }

    // Update the selectOption method to trigger validation
    selectOption(option) {
        this.originalSelect.value = option.value;
        this.button.textContent = option.label;
        
        // Trigger change event for validation
        this.originalSelect.dispatchEvent(new Event('change'));
        
        this.closeDropdown();
    }

    // Add method to focus the select
    focus() {
        this.button.focus();
        this.openDropdown();
    }
}

// Add styles for invalid state
const style = document.createElement('style');
style.textContent = `
    .optimized-select-button.is-invalid {
        border-color: #dc3545;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }

    .optimized-select-button.is-valid {
        border-color: #198754;
        padding-right: calc(1.5em + 0.75rem);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
`;
document.head.appendChild(style);

// Update form submission handler
function handleFormSubmission(event) {
    event.preventDefault();

    const form = event.target;
    const formElements = Array.from(form.elements).filter(element => 
        element.name && 
        element.name !== 'csrfmiddlewaretoken' && 
        ['INPUT', 'TEXTAREA', 'SELECT'].includes(element.tagName)
    );

    let isValid = true;
    let firstInvalidInput = null;

    // Validate all inputs including selects
    formElements.forEach(element => {
        if (!validateInput(element)) {
            isValid = false;
            if (!firstInvalidInput) {
                firstInvalidInput = element;
            }
        }
    });

    if (!isValid) {
        // Focus the first invalid input
        if (firstInvalidInput.tagName === 'SELECT') {
            // Find the associated OptimizedSelect instance
            const wrapper = firstInvalidInput.nextElementSibling;
            const customSelect = wrapper.querySelector('.optimized-select-button');
            if (customSelect) {
                customSelect.focus();
            }
        } else {
            firstInvalidInput.focus();
        }
        return;
    }

    // Continue with form submission...
    // ... (rest of the existing submission code)
}

// Add real-time validation for dropdowns
document.addEventListener('DOMContentLoaded', function() {
    // Add validation event listeners for select elements
    document.querySelectorAll('select').forEach(select => {
        select.addEventListener('change', function() {
            validateInput(this);
        });
    });
});
// Modify renderCumulativeTable to properly handle card creation
function renderCumulativeTable(tableData, data, targetElementId) {
    const targetElement = document.getElementById(targetElementId);
    targetElement.innerHTML = ''; // Clear everything first

    // Create card element
    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'reportCard'; // Add an ID to easily reference this card

    // Create card body element
    const cardBody = document.createElement('div');
    cardBody.className = 'card-body';
    cardBody.id = 'reportCardBody'; // Add an ID to easily reference the card body

    // Create button container
    const buttonContainer = document.createElement('div');
    buttonContainer.id = 'cumulativeTableFilters';
    buttonContainer.className = 'mb-3';

    // Create button group
    const buttonGroup = document.createElement('div');
    buttonGroup.className = 'btn-group';
    buttonGroup.setAttribute('role', 'group');
    buttonGroup.setAttribute('aria-label', 'Report filters');

    // Create buttons (same as before)
    const completeReportInput = document.createElement('input');
    completeReportInput.type = 'radio';
    completeReportInput.className = 'btn-check team-filter';
    completeReportInput.name = 'report-filter';
    completeReportInput.id = 'complete-report';
    completeReportInput.value = 'complete-report';
    completeReportInput.checked = true;

    const completeReportLabel = document.createElement('label');
    completeReportLabel.className = 'btn btn-outline-primary';
    completeReportLabel.setAttribute('for', 'complete-report');
    completeReportLabel.textContent = 'Complete Report';

    const crVerificationInput = document.createElement('input');
    crVerificationInput.type = 'radio';
    crVerificationInput.className = 'btn-check team-filter';
    crVerificationInput.name = 'report-filter';
    crVerificationInput.id = 'cr-verification';
    crVerificationInput.value = 'cr-verification';

    const crVerificationLabel = document.createElement('label');
    crVerificationLabel.className = 'btn btn-outline-primary';
    crVerificationLabel.setAttribute('for', 'cr-verification');
    crVerificationLabel.textContent = 'CR Verification';

    // Append elements
    buttonGroup.appendChild(completeReportInput);
    buttonGroup.appendChild(completeReportLabel);
    buttonGroup.appendChild(crVerificationInput);
    buttonGroup.appendChild(crVerificationLabel);
    buttonContainer.appendChild(buttonGroup);
    cardBody.appendChild(buttonContainer);

    // Create a container for the table content
    const tableContainer = document.createElement('div');
    tableContainer.id = 'tableContainer';
    cardBody.appendChild(tableContainer);

    card.appendChild(cardBody);
    targetElement.appendChild(card);

    // Modify event listeners
    completeReportInput.addEventListener('change', () => {
        if (completeReportInput.checked) {
            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = ''; // Clear previous content
            renderCompleteReportInCumulativeTable(tableData, data, tableContainer);
        }
    });

    crVerificationInput.addEventListener('change', async () => {
        if (crVerificationInput.checked) {
            const spSelect = document.getElementById('sp_name');
            const selectedSp = spSelect.value;
            if (!selectedSp) {
                alert('Please select an SP first');
                return;
            }

            const tableContainer = document.getElementById('tableContainer');
            tableContainer.innerHTML = ''; // Clear previous content

            let columnNames;
            if (!crVerificationData) {
                const params = new URLSearchParams();
                params.append('sp_name', selectedSp);
                try {
                    const response = await fetch(`{% url 'cst_reporting_views:get_cr_verification_data' %}?${params.toString()}`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const responseData = await response.json();
                    crVerificationData = responseData["data"];
                    columnNames = responseData["column_names"];
                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('Error fetching data. Please try again.');
                    return;
                }
            } else {
                columnNames = Object.keys(crVerificationData[Object.keys(crVerificationData)[0]][Object.keys(crVerificationData[Object.keys(crVerificationData)[0]])[0]][0]);
            }

            renderCRVerificationInCumulativeTable(crVerificationData, columnNames, tableContainer);
        }
    });

    // Add event listeners for "more" links
    targetElement.addEventListener('click', (e) => {
        if (e.target.classList.contains('show-more-list')) {
            e.preventDefault();
            const title = e.target.getAttribute('data-title');
            const list = JSON.parse(decodeURIComponent(e.target.getAttribute('data-list')));
            createListModal(title, list);
        }
    });

    // Initial render of Complete Report
    renderCompleteReportInCumulativeTable(tableData, data, document.getElementById('tableContainer'));
}

// Modify renderCompleteReportInCumulativeTable and renderCRVerificationInCumulativeTable
function renderCompleteReportInCumulativeTable(tableData, data, targetElement) {
    targetElement.innerHTML = ''; // Clear existing content
    const table = document.createElement('table');
    table.className = 'coverage-table';
    // ... rest of the function remains the same ...
    targetElement.appendChild(table);
    adjustColumnWidths();
}

function renderCRVerificationInCumulativeTable(tableData, columnNames, targetElement) {
    targetElement.innerHTML = ''; // Clear existing content
    const table = document.createElement('table');
    table.className = 'coverage-table';
    // ... rest of the function remains the same ...
    targetElement.appendChild(table);
    adjustColumnWidths();
}
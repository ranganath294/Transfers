// First, update the renderTable function to add the necessary data attributes:

function renderTable() {
    if (!tableData) return;
    
    tableBody.innerHTML = '';
    let rowCounter = 0;
    
    tableData.forEach((spData, spIndex) => {
        let firstSpRow = true;
        const filteredTeams = spData.teams.filter(team => 
            selectedTeams.includes('all') || selectedTeams.includes(team.team_name)
        );
        
        filteredTeams.forEach((team, teamIndex) => {
            let firstTeamRow = true;
            
            team.phases.forEach((phase, phaseIndex) => {
                let row = document.createElement('tr');
                row.className = 'phase-row';
                row.setAttribute('data-row-index', rowCounter++);
                row.setAttribute('data-sp-index', spIndex);
                row.setAttribute('data-team-index', teamIndex);
                row.setAttribute('data-team', team.team_name);
                row.setAttribute('data-phase', phase.phase);
                row.setAttribute('data-sp-name', spData.sp_name);
                
                if (firstSpRow) {
                    let spCell = document.createElement('td');
                    spCell.rowSpan = filteredTeams.reduce((acc, t) => 
                        acc + t.phases.length, 0);
                    spCell.innerHTML = `
                        <a href="/sp-execution-data?sp=${spData.sp_name}" target="_blank">
                            ${spData.sp_name}
                        </a>
                    `;
                    spCell.setAttribute('data-sp-cell', 'true');
                    row.appendChild(spCell);
                    firstSpRow = false;
                }
                
                if (firstTeamRow) {
                    let teamCell = document.createElement('td');
                    teamCell.rowSpan = team.phases.length;
                    teamCell.textContent = team.team_name;
                    teamCell.setAttribute('data-team-cell', 'true');
                    row.appendChild(teamCell);
                    firstTeamRow = false;
                }
                
                // Rest of your row creation code remains the same...
                row.insertAdjacentHTML('beforeend', `
                    <td>${phase.phase}</td>
                    <td>${phase.date}</td>
                    ${createTooltipCell(
                        formatPercent(phase.metrics.coverage),
                        `${spData.sp_name} ${team.team_name} ${phase.phase} Coverage ${formatPercent(phase.metrics.coverage)}%`
                    )}
                    ${createTooltipCell(
                        formatPercent(phase.metrics.passed),
                        `${spData.sp_name} ${team.team_name} ${phase.phase} Pass ${formatPercent(phase.metrics.passed)}%`
                    )}
                    ${createTooltipCell(
                        formatPercent(phase.metrics.failed),
                        `${spData.sp_name} ${team.team_name} ${phase.phase} Fail ${formatPercent(phase.metrics.failed)}%`
                    )}
                    ${createTooltipCell(
                        formatPercent(phase.metrics.blocked),
                        `${spData.sp_name} ${team.team_name} ${phase.phase} Block ${formatPercent(phase.metrics.blocked)}%`
                    )}
                `);
                
                tableBody.appendChild(row);
            });
        });
    });
    
    addRowHighlighting();
}

// Then, replace your addRowHighlighting function with this updated version:

function addRowHighlighting() {
    const rows = document.querySelectorAll('.phase-row');
    
    rows.forEach(row => {
        row.addEventListener('mouseenter', () => {
            // Get the current row's SP and team
            const spName = row.getAttribute('data-sp-name');
            const team = row.getAttribute('data-team');
            const rowIndex = parseInt(row.getAttribute('data-row-index'));
            
            // Add highlight class to the current row
            row.classList.add('highlighted-team');
            
            // Find and highlight the corresponding SP cell
            const spCells = document.querySelectorAll('[data-sp-cell="true"]');
            spCells.forEach(spCell => {
                if (spCell.textContent.trim().includes(spName)) {
                    spCell.classList.add('highlighted-team');
                }
            });
            
            // Find and highlight the corresponding team cell
            const teamCells = document.querySelectorAll('[data-team-cell="true"]');
            teamCells.forEach(teamCell => {
                if (teamCell.textContent.trim() === team) {
                    const teamRow = teamCell.closest('tr');
                    const teamRowIndex = parseInt(teamRow.getAttribute('data-row-index'));
                    if (teamRowIndex <= rowIndex && 
                        teamRowIndex + parseInt(teamCell.rowSpan) > rowIndex) {
                        teamCell.classList.add('highlighted-team');
                    }
                }
            });
        });
        
        row.addEventListener('mouseleave', () => {
            // Remove highlight class from all cells
            document.querySelectorAll('.highlighted-team').forEach(el => {
                el.classList.remove('highlighted-team');
            });
        });
    });
}
from pptx import Presentation
from pptx.util import Inches, Pt
from pptx.dml.color import RGBColor

def add_table_to_slide(slide, data, merge_info, left, top, width, height):
    rows = len(data)
    cols = len(data[0])
    table_shape = slide.shapes.add_table(rows, cols, left, top, width, height)
    table = table_shape.table

    # Set column widths to fit slide width
    for col in table.columns:
        col.width = width // cols

    # Set row heights
    for row in table.rows:
        row.height = height // rows

    # Fill the table and apply merging
    for i, row_data in enumerate(data):
        for j, cell_data in enumerate(row_data):
            cell = table.cell(i, j)
            if cell.text == "":
                cell.text = str(cell_data)
            para = cell.text_frame.paragraphs[0]
            para.font.size = Pt(10)
            para.font.color.rgb = RGBColor(0, 0, 0)

    # Apply merging
    for merge in merge_info:
        start_row, end_row, col_idx = merge
        table.cell(start_row, col_idx).merge(table.cell(end_row, col_idx))

    return table

def prepare_table_data(teams):
    table_data = []
    merge_info = []

    header = [
        'Test Team', 'Date', 'Phase', 'Coverage Type', 'Total TCs',
        'Coverage', 'Coverage %', 'Passed', 'Pass %', 'Failed', 'Fail %',
        'Blocked', 'Block %', 'Unique Issues'
    ]
    table_data.append(header)

    current_row = 1  # since 0 is header
    for team in teams:
        team_name = team['team_name']
        team_start_row = current_row

        for phase in team['phases']:
            phase_name = phase['phase']
            phase_date = phase['date']
            coverage_types = phase['coverage_types']
            unique_issue_count = phase['unique_issue_count']

            phase_start_row = current_row
            for ct in coverage_types:
                ct_metrics = ct['metrics']
                row = [
                    team_name, phase_date, phase_name, ct['coverage_type'],
                    ct_metrics['total'], ct_metrics['coverage'], f"{ct_metrics['coverage_percentage']:.2f}%",
                    ct_metrics['passed'], f"{ct_metrics['passed_percentage']:.2f}%",
                    ct_metrics['failed'], f"{ct_metrics['failed_percentage']:.2f}%",
                    ct_metrics['blocked'], f"{ct_metrics['blocked_percentage']:.2f}%",
                    unique_issue_count
                ]
                table_data.append(row)
                current_row += 1

            # Merge phase columns
            merge_info.append((phase_start_row, current_row - 1, 1))  # Date
            merge_info.append((phase_start_row, current_row - 1, 2))  # Phase

        # Merge team column
        merge_info.append((team_start_row, current_row - 1, 0))

    return table_data, merge_info

def create_slides(prs, filtered_data):
    for sp in filtered_data:
        sp_name = sp['sp_name']
        teams = sp['teams']

        slide_layout = prs.slide_layouts[5]  # Blank slide
        slide = prs.slides.add_slide(slide_layout)

        # Add title manually
        title_shape = slide.shapes.add_textbox(Inches(0.5), Inches(0.3), Inches(11), Inches(0.5))
        title_frame = title_shape.text_frame
        title_frame.text = f"SP: {sp_name}"
        title_frame.paragraphs[0].font.size = Pt(20)

        # Prepare data
        table_data, merge_info = prepare_table_data(teams)

        # Table positioning and dimensions
        left = Inches(0.2)
        top = Inches(1.0)
        width = Inches(12.8 - 0.4)  # leaving 0.2 inch margin on each side
        height = Inches(0.4 * len(table_data))  # rough estimate per row

        add_table_to_slide(slide, table_data, merge_info, left, top, width, height)

def generate_ppt(filtered_data, output_filename='report.pptx'):
    prs = Presentation()
    create_slides(prs, filtered_data)
    prs.save(output_filename)

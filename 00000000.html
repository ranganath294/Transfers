{% extends 'base.html' %}
{% block content %}
<div class="alert-container px-5">
</div>
<div class="container container-fluid">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="page-title">Active SPs Report</h1>
        {% if last_refreshed_dt %}
            <div class="last-refreshed">
                Last Refreshed At: {{ last_refreshed_dt }} IST
            </div>
        {% endif %}
    </div>
    <div class="card mb-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="btn-group" role="group" aria-label="Test Team filters">
                    <button type="button" class="btn btn-outline-primary team-filter active" data-team="all">All Teams</button>
                    <button type="button" class="btn btn-outline-primary team-filter" data-team="BT">BT</button>
                    <button type="button" class="btn btn-outline-primary team-filter" data-team="WLAN">WLAN</button>
                </div>
                <div class="btn-group" role="group" aria-label="Phase filters">
                    <button type="button" class="btn btn-outline-primary phase-filter active" data-phase="all">All Phases</button>
                    <button type="button" class="btn btn-outline-primary phase-filter" data-phase="ES">ES</button>
                    <button type="button" class="btn btn-outline-primary phase-filter" data-phase="FC">FC</button>
                    <button type="button" class="btn btn-outline-primary phase-filter" data-phase="CS">CS</button>
                    <button type="button" class="btn btn-outline-primary phase-filter" data-phase="Post-CS">Post-CS</button>
                </div>
            </div>
            <div class="table-responsive">
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0">Preparing download...</p>
            </div>
        </div>
    </div>
</div>

<style>
.container {
    padding: 2rem;
    max-width: 100%;
}
.btn-group {
    margin-right: 10px;
}
.btn-group .btn {
    margin-right: 2px;
}
.coverage-table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    border: 1px solid black;
}
.coverage-table th,
.coverage-table td {
    border: 1px solid black;
    padding: 8px;
    text-align: left;
    font-size: 15px;
    color: black;
}
.coverage-table th {
    background-color: #328AA4;
    font-weight: bold;
    color: white;
}
.coverage-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}

/* Enhanced Details Links Styling - Compact Version */
.details-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
    width: fit-content;
    min-width: auto;
}

.phase-selector {
    width: fit-content;
    margin-bottom: 6px;
}

.phase-dropdown {
    position: relative;
    display: inline-block;
    width: fit-content;
}

.dropdown-button {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 13px;
    color: #495057;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: fit-content;
    min-width: 120px;
    transition: all 0.2s ease;
    min-height: 32px;
    white-space: nowrap;
}

.dropdown-button:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.dropdown-button.open {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

.dropdown-arrow {
    font-size: 10px;
    color: #6c757d;
    transition: transform 0.2s ease;
    margin-left: 8px;
}

.dropdown-button.open .dropdown-arrow {
    transform: rotate(180deg);
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    min-width: 100%;
    width: max-content;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.dropdown-menu.show {
    display: block;
}

.dropdown-item {
    padding: 8px 12px;
    font-size: 13px;
    color: #202326;
    cursor: pointer;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.15s ease;
    white-space: nowrap;
}

.dropdown-item:last-child {
    border-bottom: none;
}

.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item.selected {
    background-color: #007bff;
    color: white;
}

.details-links {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: flex-start;
    width: fit-content;
}

.details-links button {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    font-size: 13px;
    transition: all 0.2s ease;
    text-align: center;
    width: fit-content;
    white-space: nowrap;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    min-width: auto;
    border: none;
    cursor: pointer;
}

.excel-link {
    background: linear-gradient(135deg, #3b9f68, #2d7a50);
    color: white !important;
}

.ppt-link {
    background: linear-gradient(135deg, #3b9f68, #2d7a50);
    color: white !important;
}

.details-links button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.excel-link:hover:not(:disabled) {
    background: linear-gradient(135deg, #2d7a50, #245d3e);
}

.ppt-link:hover:not(:disabled) {
    background: linear-gradient(135deg, #2d7a50, #245d3e);
}

.details-links button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

/* Alert styles */
.alert {
    padding: 12px 16px;
    margin-bottom: 16px;
    border: 1px solid transparent;
    border-radius: 6px;
    font-size: 14px;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-dismissible {
    position: relative;
    padding-right: 48px;
}

.btn-close {
    position: absolute;
    top: 50%;
    right: 16px;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.5;
}

.btn-close:hover {
    opacity: 1;
}

/* Responsive Design */
@media (max-width: 768px) {
    .details-container {
        width: fit-content;
    }
    
    .details-links button {
        padding: 5px 10px;
        font-size: 12px;
    }
    
    .dropdown-button {
        padding: 4px 8px;
        font-size: 12px;
        min-width: 100px;
    }
    
    .dropdown-item {
        padding: 6px 10px;
        font-size: 12px;
    }
}
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentData = {{ table_data|safe }};
        let selectedTeam = 'all';
        let selectedPhase = 'all';
    
        // Helper functions from existing code
        function calculateSpRowspan(sp) {
            return sp.teams.reduce((acc, team) => {
                return acc + calculateTeamRowspan(team);
            }, 0);
        }
    
        function calculateTeamRowspan(team) {
            return team.phases.reduce((acc, phase) => {
                if (phase.coverage_types) {
                    return acc + phase.coverage_types.length;
                }
                return acc + 1;
            }, 0);
        }
    
        function formatPercentage(value) {
            return value ? value.toFixed(2) + '%' : '0.00%';
        }

        // Show alert function
        function showAlert(message, type = 'danger') {
            const alertContainer = document.querySelector('.alert-container');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${type} alert-dismissible`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="closeAlert('${alertId}')">&times;</button>
            `;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                closeAlert(alertId);
            }, 5000);
        }

        // Close alert function
        window.closeAlert = function(alertId) {
            const alertElement = document.getElementById(alertId);
            if (alertElement) {
                alertElement.remove();
            }
        };

        // Show/hide loading modal
        function showLoading() {
            const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
            modal.show();
        }

        function hideLoading() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('loadingModal'));
            if (modal) {
                modal.hide();
            }
        }

        // Enhanced download function with error handling
        async function downloadFile(url, filename, button) {
            try {
                // Disable button and show loading
                button.disabled = true;
                const originalText = button.textContent;
                button.textContent = 'Downloading...';
                showLoading();

                const response = await fetch(url);
                
                // Check if response is JSON (error case)
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/json')) {
                    // Handle JSON error response
                    const errorData = await response.json();
                    hideLoading();
                    
                    if (errorData.error) {
                        showAlert(errorData.error, 'warning');
                    } else if (errorData.message) {
                        showAlert(errorData.message, 'danger');
                    } else {
                        showAlert('File not available or an error occurred.', 'danger');
                    }
                } else if (response.ok) {
                    // Handle successful file download
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    
                    // Create temporary download link
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename || 'download';
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);
                    hideLoading();
                    
                    showAlert('File downloaded successfully!', 'success');
                } else {
                    hideLoading();
                    showAlert(`Download failed: ${response.status} ${response.statusText}`, 'danger');
                }
            } catch (error) {
                hideLoading();
                console.error('Download error:', error);
                showAlert('Network error occurred while downloading the file.', 'danger');
            } finally {
                // Re-enable button
                button.disabled = false;
                button.textContent = originalText;
            }
        }
    
        // Filter data based on selected team and phase
        function filterData(data, team, phase) {
            return data.map(sp => ({
                ...sp,
                teams: sp.teams
                    .filter(t => team === 'all' || t.team_name === team)
                    .map(t => ({
                        ...t,
                        phases: t.phases.filter(p => phase === 'all' || p.phase === phase)
                    }))
                    .filter(t => t.phases.length > 0)
            })).filter(sp => sp.teams.length > 0);
        }
    
        // Add click handlers for team filters
        document.querySelectorAll('.team-filter').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.team-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                selectedTeam = this.getAttribute('data-team');
                const filteredData = filterData(currentData, selectedTeam, selectedPhase);
                renderCoverageTable(filteredData, 'tableContainer');
            });
        });
    
        // Add click handlers for phase filters
        document.querySelectorAll('.phase-filter').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.phase-filter').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                selectedPhase = this.getAttribute('data-phase');
                const filteredData = filterData(currentData, selectedTeam, selectedPhase);
                renderCoverageTable(filteredData, 'tableContainer');
            });
        });

        // Create phase dropdown
        function createPhaseDropdown(spName, teamName, phases, containerId) {
            const container = document.createElement('div');
            container.className = 'phase-selector';
            
            const dropdown = document.createElement('div');
            dropdown.className = 'phase-dropdown';
            
            const button = document.createElement('div');
            button.className = 'dropdown-button';
            button.innerHTML = `
                <span class="selected-text">Select Phase</span>
                <span class="dropdown-arrow">▼</span>
            `;
            
            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';
            
            // Add phase options
            phases.forEach(phase => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = phase.phase;
                item.setAttribute('data-phase', phase.phase);
                menu.appendChild(item);
            });
            
            dropdown.appendChild(button);
            dropdown.appendChild(menu);
            container.appendChild(dropdown);
            
            // Toggle dropdown
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Close other dropdowns
                document.querySelectorAll('.dropdown-button.open').forEach(btn => {
                    if (btn !== button) {
                        btn.classList.remove('open');
                        btn.nextElementSibling.classList.remove('show');
                    }
                });
                
                button.classList.toggle('open');
                menu.classList.toggle('show');
            });
            
            // Handle phase selection
            menu.addEventListener('click', function(e) {
                if (e.target.classList.contains('dropdown-item')) {
                    const selectedPhase = e.target.getAttribute('data-phase');
                    const selectedText = e.target.textContent;
                    
                    // Update button text
                    button.querySelector('.selected-text').textContent = selectedText;
                    
                    // Update selected state
                    menu.querySelectorAll('.dropdown-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    
                    // Close dropdown
                    button.classList.remove('open');
                    menu.classList.remove('show');
                    
                    // Update download links
                    updateDownloadLinks(containerId, spName, teamName, selectedPhase);
                }
            });
            
            return container;
        }
        
        // Update download links with selected phase
        function updateDownloadLinks(containerId, spName, teamName, selectedPhase) {
            const container = document.getElementById(containerId);
            const excelButton = container.querySelector('.excel-link');
            const pptButton = container.querySelector('.ppt-link');
            
            if (excelButton && pptButton) {
                // Update button text
                excelButton.textContent = `${selectedPhase} Scrum Sheet`;
                pptButton.textContent = `${selectedPhase} Coverage Report`;
                
                // Update data attributes for URLs
                const baseExcelUrl = `/download_file/?sp_name=${encodeURIComponent(spName)}&team_name=${encodeURIComponent(teamName)}&reportType=scrum_sheet&tab=active_sps`;
                const basePptUrl = `/download_file/?sp_name=${encodeURIComponent(spName)}&team_name=${encodeURIComponent(teamName)}&reportType=coverage_report&tab=active_sps`;
                
                excelButton.setAttribute('data-url', `${baseExcelUrl}&phase_name=${encodeURIComponent(selectedPhase)}`);
                pptButton.setAttribute('data-url', `${basePptUrl}&phase_name=${encodeURIComponent(selectedPhase)}`);
                
                excelButton.setAttribute('data-filename', `${spName}_${teamName}_${selectedPhase}_scrum_sheet.xlsx`);
                pptButton.setAttribute('data-filename', `${spName}_${teamName}_${selectedPhase}_coverage_report.pptx`);
            }
        }
    
        function renderCoverageTable(data, targetElementId) {
            const table = document.createElement('table');
            table.className = 'coverage-table';
    
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = [
                'SP Name',
                'Test Team',
                'Coverage Details',
                'Phase',
                'Date',
                'Projected Coverage %',
                'Coverage %',
                'Pass %',
                'Fail %',
                'Block %'
            ];
    
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
    
            // Create table body
            const tbody = document.createElement('tbody');
            let rowCounter = 0;
            
            data.forEach(sp => {
                const spRowspan = calculateSpRowspan(sp);
                let isFirstSpRow = true;
    
                sp.teams.forEach(team => {
                    const teamRowspan = calculateTeamRowspan(team);
                    let isFirstTeamRow = true;
    
                    team.phases.forEach(phase => {
                        const tr = document.createElement('tr');
                        const currentRowId = `row-${rowCounter++}`;
    
                        if (isFirstSpRow) {
                            const tdSp = document.createElement('td');
                            tdSp.textContent = sp.sp_name;
                            tdSp.rowSpan = spRowspan;
                            tr.appendChild(tdSp);
                            isFirstSpRow = false;
                        }
    
                        if (isFirstTeamRow) {
                            const tdTeam = document.createElement('td');
                            tdTeam.textContent = team.team_name;
                            tdTeam.rowSpan = teamRowspan;
                            tr.appendChild(tdTeam);

                            const tdDetails = document.createElement('td');
                            tdDetails.rowSpan = teamRowspan;
                            tdDetails.id = currentRowId;
                            
                            const detailsContainer = document.createElement('div');
                            detailsContainer.className = 'details-container';
                            
                            // Create phase dropdown
                            const phaseDropdown = createPhaseDropdown(sp.sp_name, team.team_name, team.phases, currentRowId);
                            detailsContainer.appendChild(phaseDropdown);
                            
                            // Create download links container
                            const linksDiv = document.createElement('div');
                            linksDiv.className = 'details-links';
                            
                            // Create Excel button
                            const excelButton = document.createElement('button');
                            excelButton.className = 'excel-link';
                            excelButton.textContent = 'Scrum Sheet';
                            excelButton.setAttribute('data-url', `/download_file/?sp_name=${encodeURIComponent(sp.sp_name)}&team_name=${encodeURIComponent(team.team_name)}&reportType=scrum_sheet&tab=active_sps&phase_name=${encodeURIComponent(phase.phase)}`);
                            excelButton.setAttribute('data-filename', `${sp.sp_name}_${team.team_name}_${phase.phase}_scrum_sheet.xlsx`);
                            
                            excelButton.addEventListener('click', function() {
                                const url = this.getAttribute('data-url');
                                const filename = this.getAttribute('data-filename');
                                downloadFile(url, filename, this);
                            });
                            
                            linksDiv.appendChild(excelButton);
                            
                            // Create PPT button
                            const pptButton = document.createElement('button');
                            pptButton.className = 'ppt-link';
                            pptButton.textContent = 'Coverage Report';
                            pptButton.setAttribute('data-url', `/download_file/?sp_name=${encodeURIComponent(sp.sp_name)}&team_name=${encodeURIComponent(team.team_name)}&reportType=coverage_report&tab=active_sps&phase_name=${encodeURIComponent(phase.phase)}`);
                            pptButton.setAttribute('data-filename', `${sp.sp_name}_${team.team_name}_${phase.phase}_coverage_report.pptx`);
                            
                            pptButton.addEventListener('click', function() {
                                const url = this.getAttribute('data-url');
                                const filename = this.getAttribute('data-filename');
                                downloadFile(url, filename, this);
                            });
                            
                            linksDiv.appendChild(pptButton);
                            
                            detailsContainer.appendChild(linksDiv);
                            tdDetails.appendChild(detailsContainer);
                            tr.appendChild(tdDetails);

                            isFirstTeamRow = false;
                        }
    
                        const cells = [
                            phase.phase,
                            phase.date,
                            phase.expected_cov_percentage,
                            formatPercentage(phase.metrics.coverage_percentage),
                            formatPercentage(phase.metrics.passed_percentage),
                            formatPercentage(phase.metrics.failed_percentage),
                            formatPercentage(phase.metrics.blocked_percentage)
                        ];
    
                        cells.forEach(cellData => {
                            const td = document.createElement('td');
                            td.textContent = cellData;
                            tr.appendChild(td);
                        });
    
                        tbody.appendChild(tr);
                    });
                });
            });
    
            table.appendChild(tbody);
    
            const targetElement = document.getElementById(targetElementId);
            targetElement.innerHTML = '';
            targetElement.appendChild(table);
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.dropdown-button.open').forEach(button => {
                button.classList.remove('open');
                button.nextElementSibling.classList.remove('show');
            });
        });
    
        // Initial render with unfiltered data
        if (currentData) {
            renderCoverageTable(currentData, 'tableContainer');
        }
    });
    
</script>
{% endblock %}
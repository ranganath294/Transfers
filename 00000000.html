// Update the event listener for the SP select
spSelect.addEventListener('change', function() {
    // Get all selected options
    const selectedOptions = Array.from(this.selectedOptions).map(option => option.value);
    // Filter out any empty values
    const spNames = selectedOptions.filter(name => name);
    
    const tableContainer = document.getElementById('table-container');

    if (spNames.length > 0) {
        // Add loading state
        tableContainer.classList.add('table-loading');

        // Create the URL with multiple sp_name parameters
        const params = new URLSearchParams();
        spNames.forEach(name => {
            params.append('sp_name', name);
        });

        fetch(`/get_counts_new/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');

                // Reset table
                const tableBody = document.getElementById('table-body');
                tableBody.innerHTML = '';
                const tableHeaders = document.getElementById('table-headers');
                tableHeaders.innerHTML = '<th id="metrics-header" scope="col" class="metrics-cell">Metrics</th>';
                
                // Get all metrics (keys of the data object)
                const metrics = Object.keys(data);
                
                if (metrics.length > 0) {
                    // Collect all SPs and their teams
                    const spTeams = {};
                    metrics.forEach(metric => {
                        Object.keys(data[metric]).forEach(sp => {
                            if (!spTeams[sp]) {
                                spTeams[sp] = new Set();
                            }
                            Object.keys(data[metric][sp]).forEach(team => {
                                spTeams[sp].add(team);
                            });
                        });
                    });
                    
                    // Create header row with SP groups
                    Object.keys(spTeams).forEach(sp => {
                        const teams = Array.from(spTeams[sp]);
                        
                        // Create a colspan header for the SP if it has multiple teams
                        if (teams.length > 1) {
                            const spHeader = document.createElement('th');
                            spHeader.setAttribute('colspan', teams.length);
                            spHeader.setAttribute('scope', 'colgroup');
                            spHeader.textContent = sp;
                            spHeader.style.borderBottom = '2px solid #dee2e6';
                            tableHeaders.appendChild(spHeader);
                        } else {
                            // Single team case - just create the team header with SP name
                            const teamHeader = document.createElement('th');
                            teamHeader.setAttribute('scope', 'col');
                            teamHeader.textContent = sp;
                            tableHeaders.appendChild(teamHeader);
                        }
                    });
                    
                    // Create second header row for teams if needed
                    let hasMultipleTeams = false;
                    Object.values(spTeams).forEach(teams => {
                        if (teams.size > 1) hasMultipleTeams = true;
                    });
                    
                    if (hasMultipleTeams) {
                        const teamHeaderRow = document.createElement('tr');
                        teamHeaderRow.innerHTML = '<th class="metrics-cell"></th>'; // Empty cell above metrics
                        
                        Object.keys(spTeams).forEach(sp => {
                            const teams = Array.from(spTeams[sp]);
                            teams.forEach(team => {
                                const teamHeader = document.createElement('th');
                                teamHeader.setAttribute('scope', 'col');
                                teamHeader.textContent = team;
                                teamHeaderRow.appendChild(teamHeader);
                            });
                        });
                        
                        tableHeaders.parentNode.insertBefore(teamHeaderRow, tableHeaders.nextSibling);
                    }
                    
                    // Create data rows
                    metrics.forEach((metric, rowIndex) => {
                        const tr = document.createElement('tr');
                        tr.setAttribute('id', `data-row-${rowIndex}`);
                        
                        const metricsTd = document.createElement('td');
                        metricsTd.setAttribute('id', `metrics-cell-${rowIndex}`);
                        metricsTd.textContent = metric;
                        metricsTd.className = 'metrics-cell';
                        tr.appendChild(metricsTd);
                        
                        // Add cells for each SP and team
                        Object.keys(spTeams).forEach(sp => {
                            const teams = Array.from(spTeams[sp]);
                            teams.forEach(team => {
                                const td = document.createElement('td');
                                const value = data[metric][sp]?.[team] ?? '';
                                td.textContent = value === 0 ? '0' : value; // Ensure '0' is displayed
                                tr.appendChild(td);
                            });
                        });
                        
                        tableBody.appendChild(tr);
                    });
                }
            })
            .catch(error => {
                // Remove loading state
                tableContainer.classList.remove('table-loading');

                console.error('Error:', error);
                addAlert('danger', `Error loading data. Please try again.`);
            });
    } else {
        addAlert('warning', `Please select at least one SP to view metrics`);
    }
});

// Helper function to show alerts
function addAlert(type, message) {
    const alertContainer = document.getElementById('alert-container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.role = 'alert';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
    }, 5000);
}
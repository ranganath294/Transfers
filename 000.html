document.addEventListener('DOMContentLoaded', function() {
    const getDataBtn = document.getElementById('getDataBtn');
    const teamFilters = document.querySelectorAll('.team-filter');
    const teamFiltersContainer = document.getElementById('teamFilters');
    let selectedTeams = ['all'];
    let tableData = null;

    // Add a new function to render coverage type details
    function renderCoverageTypeDetails(phaseData, coverageTypes) {
        const detailsTable = document.createElement('table');
        detailsTable.className = 'coverage-type-details-table';
        detailsTable.style.cssText = `
            width: 100%;
            margin-left: 40px;
            border-collapse: collapse;
            background-color: #f9f9f9;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        `;

        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            'Coverage Type', 
            'Total TCs',
            'Coverage', 'Coverage %',
            'Passed', 'Pass %',
            'Failed', 'Fail %',
            'Blocked', 'Block %',
            'Unique CRs',
            'Unique JIRAs'
        ];
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            th.style.cssText = `
                background-color: #4a8f9b;
                color: white;
                padding: 8px;
                border: 1px solid #ddd;
                text-align: left;
            `;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        detailsTable.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');
        coverageTypes.forEach(coverageType => {
            const tr = document.createElement('tr');
            tr.style.cssText = `
                transition: background-color 0.3s ease;
            `;
            
            const cells = [
                coverageType.coverage_type,
                coverageType.metrics.total || '0',
                coverageType.metrics.coverage || '0',
                formatPercentage(coverageType.metrics.coverage_percentage),
                coverageType.metrics.passed || '0',
                formatPercentage(coverageType.metrics.passed_percentage),
                coverageType.metrics.failed || '0',
                formatPercentage(coverageType.metrics.failed_percentage),
                coverageType.metrics.blocked || '0',
                formatPercentage(coverageType.metrics.blocked_percentage)
            ];

            cells.forEach(cellData => {
                const td = document.createElement('td');
                td.textContent = cellData;
                td.style.cssText = `
                    padding: 8px;
                    border: 1px solid #ddd;
                `;
                tr.appendChild(td);
            });

            // Add Unique CRs column
            const crTd = document.createElement('td');
            crTd.innerHTML = formatLongList(coverageType.unique_cr_list || [], coverageType.unique_cr_count || 0);
            crTd.style.cssText = `
                padding: 8px;
                border: 1px solid #ddd;
            `;
            tr.appendChild(crTd);

            // Add Unique JIRAs column
            const jiraTd = document.createElement('td');
            jiraTd.innerHTML = formatLongList(coverageType.unique_jira_list || [], coverageType.unique_jira_count || 0);
            jiraTd.style.cssText = `
                padding: 8px;
                border: 1px solid #ddd;
            `;
            tr.appendChild(jiraTd);

            tbody.appendChild(tr);
        });

        detailsTable.appendChild(tbody);
        return detailsTable;
    }

    // Modify the renderCoverageTable function to add expand/collapse functionality
    function renderCoverageTable(data, targetElementId) {
        const table = document.createElement('table');
        table.className = 'coverage-table';

        // Create header (same as before)
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            '', // New column for expand/collapse icon
            'SP Name', 'Test Team', 'Date', 'Phase', 'Coverage Type',
            'Total TCs', 'Coverage', 'Coverage %', 'Passed', 'Pass %',
            'Failed', 'Fail %', 'Blocked', 'Block %', 'Unique Issues Issued'
        ];
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create table body (modify existing rendering logic)
        const tbody = document.createElement('tbody');
        data.forEach(sp => {
            const spRowspan = calculateSpRowspan(sp);
            let isFirstSpRow = true;
            sp.teams.forEach(team => {
                const teamRowspan = calculateTeamRowspan(team);
                let isFirstTeamRow = true;
                team.phases.forEach(phase => {
                    if (phase.coverage_types) {
                        // Handle multiple coverage types
                        phase.coverage_types.forEach((coverageType, ctIndex) => {
                            const tr = document.createElement('tr');
                            
                            // Expand/Collapse column
                            if (ctIndex === 0 && phase.coverage_types.length > 1) {
                                const expandTd = document.createElement('td');
                                const expandIcon = document.createElement('span');
                                expandIcon.innerHTML = '➕';
                                expandIcon.style.cssText = `
                                    cursor: pointer;
                                    user-select: none;
                                    font-weight: bold;
                                    color: #328AA4;
                                `;
                                expandIcon.setAttribute('data-phase', JSON.stringify(phase));
                                expandIcon.classList.add('expand-phase-details');
                                expandTd.appendChild(expandIcon);
                                tr.appendChild(expandTd);
                            } else {
                                const emptyTd = document.createElement('td');
                                tr.appendChild(emptyTd);
                            }

                            // Rest of the existing rendering logic remains the same
                            // ... (previous code for rendering SP, Team, Date, Phase, etc.)
                        });
                    } else {
                        // Handle single coverage type (similar modification)
                        const tr = document.createElement('tr');
                        const emptyTd = document.createElement('td');
                        tr.appendChild(emptyTd);
                        // ... (rest of the existing single coverage type rendering)
                    }
                });
            });
        });

        table.appendChild(tbody);

        // Render the table
        const targetElement = document.getElementById(targetElementId);
        targetElement.innerHTML = '';
        targetElement.appendChild(table);

        // Add event listener for expand/collapse
        targetElement.addEventListener('click', (e) => {
            const expandIcon = e.target.closest('.expand-phase-details');
            if (expandIcon) {
                // Toggle icon and details
                const isExpanded = expandIcon.innerHTML === '➖';
                const existingDetailsRow = expandIcon.closest('tr').nextElementSibling;
                
                if (isExpanded) {
                    // Collapse
                    expandIcon.innerHTML = '➕';
                    if (existingDetailsRow && existingDetailsRow.classList.contains('phase-details-row')) {
                        existingDetailsRow.remove();
                    }
                } else {
                    // Expand
                    expandIcon.innerHTML = '➖';
                    
                    // Parse the phase data
                    const phaseData = JSON.parse(expandIcon.getAttribute('data-phase'));
                    
                    // Create a new row for details
                    const detailsRow = document.createElement('tr');
                    detailsRow.classList.add('phase-details-row');
                    
                    const detailsTd = document.createElement('td');
                    detailsTd.setAttribute('colspan', '15');
                    
                    // Create and append the details table
                    const detailsTable = renderCoverageTypeDetails(phaseData, phaseData.coverage_types);
                    detailsTd.appendChild(detailsTable);
                    
                    detailsRow.appendChild(detailsTd);
                    
                    // Insert the new row right after the current row
                    expandIcon.closest('tr').insertAdjacentElement('afterend', detailsRow);
                }
            }
        });

        // Adjust column widths
        adjustColumnWidths();
    }

    // Rest of the existing code remains the same...
});
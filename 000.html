document.addEventListener('DOMContentLoaded', function() {
    let currentData = {{ table_data|safe }};
    let selectedTeam = 'all';
    let selectedPhase = 'all';

    // Helper functions from existing code
    function calculateSpRowspan(sp) {
        return sp.teams.reduce((acc, team) => {
            return acc + calculateTeamRowspan(team);
        }, 0);
    }

    function calculateTeamRowspan(team) {
        return team.phases.reduce((acc, phase) => {
            if (phase.coverage_types) {
                return acc + phase.coverage_types.length;
            }
            return acc + 1;
        }, 0);
    }

    function formatPercentage(value) {
        return value ? value.toFixed(2) + '%' : '0.00%';
    }

    // Filter data based on selected team and phase
    function filterData(data, team, phase) {
        return data.map(sp => ({
            ...sp,
            teams: sp.teams
                .filter(t => team === 'all' || t.team_name === team)
                .map(t => ({
                    ...t,
                    phases: t.phases.filter(p => phase === 'all' || p.phase === phase)
                }))
                .filter(t => t.phases.length > 0)
        })).filter(sp => sp.teams.length > 0);
    }

    // Add click handlers for team filters
    document.querySelectorAll('.team-filter').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all team buttons
            document.querySelectorAll('.team-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            
            selectedTeam = this.getAttribute('data-team');
            const filteredData = filterData(currentData, selectedTeam, selectedPhase);
            renderCoverageTable(filteredData, 'tableContainer');
        });
    });

    // Add click handlers for phase filters
    document.querySelectorAll('.phase-filter').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all phase buttons
            document.querySelectorAll('.phase-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            this.classList.add('active');
            
            selectedPhase = this.getAttribute('data-phase');
            const filteredData = filterData(currentData, selectedTeam, selectedPhase);
            renderCoverageTable(filteredData, 'tableContainer');
        });
    });

    function renderCoverageTable(data, targetElementId) {
        const table = document.createElement('table');
        table.className = 'coverage-table';

        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            'SP Name',
            'Test Team',
            'Phase',
            'Date',
            'Coverage %',
            'Pass %',
            'Fail %',
            'Block %'
        ];

        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');
        data.forEach(sp => {
            const spRowspan = calculateSpRowspan(sp);
            let isFirstSpRow = true;

            sp.teams.forEach(team => {
                const teamRowspan = calculateTeamRowspan(team);
                let isFirstTeamRow = true;

                team.phases.forEach(phase => {
                    const tr = document.createElement('tr');

                    if (isFirstSpRow) {
                        const tdSp = document.createElement('td');
                        tdSp.textContent = sp.sp_name;
                        tdSp.rowSpan = spRowspan;
                        tr.appendChild(tdSp);
                        isFirstSpRow = false;
                    }

                    if (isFirstTeamRow) {
                        const tdTeam = document.createElement('td');
                        tdTeam.textContent = team.team_name;
                        tdTeam.rowSpan = teamRowspan;
                        tr.appendChild(tdTeam);
                        isFirstTeamRow = false;
                    }

                    const cells = [
                        phase.phase,
                        phase.date,
                        formatPercentage(phase.metrics.coverage_percentage),
                        formatPercentage(phase.metrics.passed_percentage),
                        formatPercentage(phase.metrics.failed_percentage),
                        formatPercentage(phase.metrics.blocked_percentage)
                    ];

                    cells.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        });

        table.appendChild(tbody);

        // Add styles
        const style = document.createElement('style');
        style.textContent = `
            .coverage-table {
                border-collapse: collapse;
                width: 100%;
                margin: 20px 0;
            }
            .coverage-table th,
            .coverage-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .coverage-table th {
                background-color: #f5f5f5;
                font-weight: bold;
            }
            .coverage-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
        `;
        document.head.appendChild(style);

        const targetElement = document.getElementById(targetElementId);
        targetElement.innerHTML = '';
        targetElement.appendChild(table);
    }

    // Initial render with unfiltered data
    if (currentData) {
        renderCoverageTable(currentData, 'tableContainer');
    }
});
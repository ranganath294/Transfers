{% extends 'base.html' %}
{% block content %}
<div class="container container-fluid">
    <h1 class="page-title">Coverage Report</h1>
    <div class="card mb-3">
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="sp_name" class="form-label">Select SP:</label>
                        <div class="input-group">
                            <select id="sp_name" name="sp_name" class="form-select">
                                <option value="">--No SP Selected--</option>
                                {% for sp_name in sp_names %}
                                    <option value="{{ sp_name }}" {% if sp_name == selected_sp %}selected{% endif %}>{{ sp_name }}</option>
                                {% endfor %}
                            </select>
                            <button id="getDataBtn" class="btn btn-primary">Get Data</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="teamFilters" style="display: none;" class="mb-3">
                <div class="btn-group" role="group" aria-label="Test Team filters">
                    <input type="radio" class="btn-check team-filter" name="team-filter" id="all" value="all" checked>
                    <label class="btn btn-outline-primary" for="all">All Teams</label>
                    <input type="radio" class="btn-check team-filter" name="team-filter" id="bt" value="BT">
                    <label class="btn btn-outline-primary" for="bt">BT</label>
                    <input type="radio" class="btn-check team-filter" name="team-filter" id="wlan" value="WLAN">
                    <label class="btn btn-outline-primary" for="wlan">WLAN</label>
                </div>
            </div>
            <div id="tableContainer" class="table-responsive">
                <!-- Table will be rendered here -->
            </div>
        </div>
    </div>
</div>
<style>
.container {
    padding: 2rem;
    max-width: 1500px;
}
.btn-group {
    margin-right: 10px;
}
.btn-group .btn {
    margin-right: 2px;
}
.coverage-table {
    border-collapse: collapse;
    width: 100%;
    margin: 20px 0;
    table-layout: auto;  /* Allow columns to size based on content */
    border: 1px solid black; /* Solid black border for the table */
}
.coverage-table th,
.coverage-table td {
    border: 1px solid black; /* Solid black borders for table cells */
    padding: 8px;
    text-align: left;
    font-size: 15px; /* Set font size to 15px */
    color: black; /* Set text color to black */
    white-space: nowrap;  /* Prevent wrapping in data cells */
}
.coverage-table th {
    background-color: #328AA4; /* Set background color for headers */
    font-weight: bold;
    color: white; /* Set text color for headers to white */
    position: relative;
    white-space: normal;  /* Allow header text to wrap */
    word-wrap: break-word;  /* Break long words if necessary */
    min-width: 50px;  /* Minimum width for columns */
    max-width: 150px;  /* Maximum width for headers */
    overflow: hidden;
    text-overflow: ellipsis;  /* Show ellipsis for overflowing header text */
}
.coverage-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}
/* Add horizontal scrolling for the table container if needed */
.table-responsive {
    overflow-x: auto;
    max-width: 100%;
}
</style>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const getDataBtn = document.getElementById('getDataBtn');
        const teamFilters = document.querySelectorAll('.team-filter');
        const teamFiltersContainer = document.getElementById('teamFilters');
        let selectedTeams = ['all'];
        let tableData = null;

        function adjustColumnWidths() {
            const table = document.querySelector('.coverage-table');
            if (!table) return;
        
            // Reset any previously set widths
            const cells = table.querySelectorAll('th, td');
            cells.forEach(cell => cell.style.width = '');
        
            // Let the browser render the table first
            setTimeout(() => {
                const headerCells = table.querySelectorAll('th');
                const bodyCells = Array.from(table.querySelectorAll('tbody tr:first-child td'));
        
                // Calculate maximum width needed for data cells in each column
                bodyCells.forEach((cell, index) => {
                    const columnCells = Array.from(table.querySelectorAll(`tbody td:nth-child(${index + 1})`));
                    const maxWidth = Math.max(...columnCells.map(cell => cell.offsetWidth));
                    
                    // Set width based on data content
                    columnCells.forEach(cell => cell.style.width = `${maxWidth}px`);
                    if (headerCells[index]) {
                        headerCells[index].style.width = `${maxWidth}px`;
                    }
                });
            }, 0);
        }
    
        // Handle team filter changes
        teamFilters.forEach(filter => {
            filter.addEventListener('change', (e) => {
                const selectedValue = e.target.value;
                if (selectedValue === 'all') {
                    selectedTeams = ['all'];
                    if (tableData) {
                        renderCoverageTable(filterData(tableData, selectedTeams), 'tableContainer');
                    }
                } else {
                    selectedTeams = [selectedValue];
                    if (tableData) {
                        const cumulativeData = calculateCumulativeMetrics(tableData, selectedValue);
                        renderCumulativeTable(cumulativeData, 'tableContainer');
                    }
                }
            });
        });
    
        function setLoadingState(isLoading) {
            getDataBtn.disabled = isLoading;
            getDataBtn.innerHTML = isLoading ? 'Loading...' : 'Get Data';
        }
    
        // Handle Get Data button click
        getDataBtn.addEventListener('click', async function() {
            const spSelect = document.getElementById('sp_name');
            const selectedSp = spSelect.value;
            if (!selectedSp) {
                alert('Please select an SP first');
                return;
            }
            setLoadingState(true);
            const params = new URLSearchParams();
            params.append('sp_name', selectedSp);
            if (selectedTeams.includes('all')) {
                params.append('teams', 'all');
            } else {
                selectedTeams.forEach(team => params.append('teams', team));
            }
            try {
                const response = await fetch(`{% url 'cst_reporting_views:coverage_report' %}?${params.toString()}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const responseData = await response.json();
                tableData = responseData["table_data"];
                console.log(tableData);
                teamFiltersContainer.style.display = 'block';
                renderCoverageTable(tableData, 'tableContainer');
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Error fetching data. Please try again.');
            } finally {
                setLoadingState(false);
            }
        });
    
        // Helper function to filter data based on selected teams
        function filterData(data, selectedTeams) {
            if (selectedTeams.includes('all')) {
                return data;
            }
            return data.map(sp => ({
                ...sp,
                teams: sp.teams.filter(team => selectedTeams.includes(team.team_name))
            })).filter(sp => sp.teams.length > 0);
        }
    
        // Helper functions
        function calculateSpRowspan(sp) {
            return sp.teams.reduce((acc, team) => {
                return acc + calculateTeamRowspan(team);
            }, 0);
        }
    
        function calculateTeamRowspan(team) {
            return team.phases.reduce((acc, phase) => {
                if (phase.coverage_types) {
                    return acc + phase.coverage_types.length;
                }
                return acc + 1;
            }, 0);
        }
    
        function formatPercentage(value) {
            return value ? value.toFixed(2) + '%' : '0.00%';
        }
    
        // Function to render the coverage table
        function renderCoverageTable(data, targetElementId) {
            const table = document.createElement('table');
            table.className = 'coverage-table';
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = [
                'SP Name', 'Test Team', 'Date', 'Phase', 'Coverage Type',
                'Total TCs', 'Coverage', 'Coverage %', 'Passed', 'Pass %',
                'Failed', 'Fail %', 'Blocked', 'Block %', 'Unique Issues Issued'
            ];
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            // Create table body
            const tbody = document.createElement('tbody');
            data.forEach(sp => {
                const spRowspan = calculateSpRowspan(sp);
                let isFirstSpRow = true;
                sp.teams.forEach(team => {
                    const teamRowspan = calculateTeamRowspan(team);
                    let isFirstTeamRow = true;
                    team.phases.forEach(phase => {
                        if (phase.coverage_types) {
                            // Handle multiple coverage types
                            phase.coverage_types.forEach((coverageType, ctIndex) => {
                                const tr = document.createElement('tr');
                                // SP Name column
                                if (isFirstSpRow) {
                                    const tdSp = document.createElement('td');
                                    tdSp.textContent = sp.sp_name;
                                    tdSp.rowSpan = spRowspan;
                                    tr.appendChild(tdSp);
                                    isFirstSpRow = false;
                                }
                                // Team Name column
                                if (isFirstTeamRow) {
                                    const tdTeam = document.createElement('td');
                                    tdTeam.textContent = team.team_name;
                                    tdTeam.rowSpan = teamRowspan;
                                    tr.appendChild(tdTeam);
                                    isFirstTeamRow = false;
                                }
                                // Phase date
                                if (ctIndex === 0) {
                                    const tdDate = document.createElement('td');
                                    tdDate.textContent = phase.date;
                                    tdDate.rowSpan = phase.coverage_types.length;
                                    tr.appendChild(tdDate);
                                    const tdPhase = document.createElement('td');
                                    tdPhase.textContent = phase.phase;
                                    tdPhase.rowSpan = phase.coverage_types.length;
                                    tr.appendChild(tdPhase);
                                }
                                // Coverage type and metrics
                                const cells = [
                                    coverageType.coverage_type,
                                    coverageType.metrics.total || '0',
                                    coverageType.metrics.coverage || '0',
                                    formatPercentage(coverageType.metrics.coverage_percentage),
                                    coverageType.metrics.passed || '0',
                                    formatPercentage(coverageType.metrics.passed_percentage),
                                    coverageType.metrics.failed || '0',
                                    formatPercentage(coverageType.metrics.failed_percentage),
                                    coverageType.metrics.blocked || '0',
                                    formatPercentage(coverageType.metrics.blocked_percentage),
                                    coverageType.unique_issue_count
                                ];
                                cells.forEach(cellData => {
                                    const td = document.createElement('td');
                                    td.textContent = cellData;
                                    tr.appendChild(td);
                                });
                                tbody.appendChild(tr);
                            });
                        } else {
                            // Handle single coverage type
                            const tr = document.createElement('tr');
                            if (isFirstSpRow) {
                                const tdSp = document.createElement('td');
                                tdSp.textContent = sp.sp_name;
                                tdSp.rowSpan = spRowspan;
                                tr.appendChild(tdSp);
                                isFirstSpRow = false;
                            }
                            if (isFirstTeamRow) {
                                const tdTeam = document.createElement('td');
                                tdTeam.textContent = team.team_name;
                                tdTeam.rowSpan = teamRowspan;
                                tr.appendChild(tdTeam);
                                isFirstTeamRow = false;
                            }
                            const cells = [
                                phase.date,
                                phase.phase,
                                'All',
                                phase.metrics.total || '0',
                                phase.metrics.coverage || '0',
                                formatPercentage(phase.metrics.coverage_percentage),
                                phase.metrics.passed || '0',
                                formatPercentage(phase.metrics.passed_percentage),
                                phase.metrics.failed || '0',
                                formatPercentage(phase.metrics.failed_percentage),
                                phase.metrics.blocked || '0',
                                formatPercentage(phase.metrics.blocked_percentage),
                                phase.unique_issue_count
                            ];
                            cells.forEach(cellData => {
                                const td = document.createElement('td');
                                td.textContent = cellData;
                                tr.appendChild(td);
                            });
                            tbody.appendChild(tr);
                        }
                    });
                });
            });
            table.appendChild(tbody);
            // Add basic styles
            const style = document.createElement('style');
            style.textContent = `
            .coverage-table {
                border-collapse: collapse;
                width: 100%;
                margin: 20px 0;
            }
            .coverage-table th, .coverage-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .coverage-table th {
                background-color: #f5f5f5;
                font-weight: bold;
            }
            .coverage-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            `;
            document.head.appendChild(style);
            // Render the table
            const targetElement = document.getElementById(targetElementId);
            targetElement.innerHTML = '';
            targetElement.appendChild(table);

            // Adjust column widths
            adjustColumnWidths();
        }

        // Configuration for list display
        const LIST_THRESHOLD = 15;

        // Function to create a modal for displaying full lists
        function formatLongList(list, count) {
            // Create a wrapper div
            const wrapper = document.createElement('div');
            wrapper.style.cssText = `
                display: flex;
                flex-direction: column;
                max-width: 300px;
            `;
        
            // Total count display
            const totalCountEl = document.createElement('div');
            totalCountEl.textContent = `Total: ${count}`;
            totalCountEl.style.cssText = `
                font-weight: 500;
                margin-bottom: 5px;
                text-align: left;
            `;
            wrapper.appendChild(totalCountEl);
        
            // List display logic remains similar to previous implementation
            if (count <= LIST_THRESHOLD) {
                const listContainer = document.createElement('div');
                listContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 5px;
                    max-width: 420px;
                    max-height: 200px;
                    overflow-y: auto;
                `;
        
                list.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.textContent = item;
                    itemEl.style.cssText = `
                        border: 1px solid #eee;
                        padding: 2px;
                        font-size: 0.8em;
                        word-break: break-all;
                        background-color: #d4e4e6;
                        border-radius: 3px;
                    `;
                    listContainer.appendChild(itemEl);
                });
        
                wrapper.appendChild(listContainer);
        
                // Add more link if needed
                if (count > LIST_THRESHOLD) {
                    const moreLink = document.createElement('a');
                    moreLink.href = '#';
                    moreLink.textContent = 'more...';
                    moreLink.className = 'show-more-list';
                    moreLink.setAttribute('data-title', `Full List (${count} items)`);
                    moreLink.setAttribute('data-list', encodeURIComponent(JSON.stringify(list)));
                    moreLink.style.cssText = `
                        display: block;
                        text-align: center;
                        margin-top: 5px;
                    `;
                    wrapper.appendChild(moreLink);
                }
            } else {
                const displayList = list.slice(0, LIST_THRESHOLD);
                const listContainer = document.createElement('div');
                listContainer.style.cssText = `
                    display: grid;
                    grid-template-columns: repeat(3, 1fr);
                    gap: 5px;
                    max-width: 420px;
                    max-height: 200px;
                    overflow-y: auto;
                `;
        
                displayList.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.textContent = item;
                    itemEl.style.cssText = `
                        border: 1px solid #eee;
                        padding: 2px;
                        font-size: 0.8em;
                        word-break: break-all;
                        background-color: #d4e4e6;
                        border-radius: 3px;
                    `;
                    listContainer.appendChild(itemEl);
                });
        
                wrapper.appendChild(listContainer);
        
                // More link
                const moreLink = document.createElement('a');
                moreLink.href = '#';
                moreLink.textContent = `more... (${count} total)`;
                moreLink.className = 'show-more-list';
                moreLink.setAttribute('data-title', `Full List (${count} items)`);
                moreLink.setAttribute('data-list', encodeURIComponent(JSON.stringify(list)));
                moreLink.style.cssText = `
                    display: block;
                    text-align: center;
                    margin-top: 5px;
                `;
                wrapper.appendChild(moreLink);
            }
        
            return wrapper.innerHTML;
        }
        
        function createListModal(title, list) {
            // Create modal container
            const modal = document.createElement('div');
            modal.className = 'list-modal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                border: 1px solid #ccc;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                width: 80vw;
                max-width: 1000px;
                max-height: 70vh;
                overflow: hidden;
                z-index: 1000;
                border-radius: 8px;
            `;
        
            // Modified header to include total count
            const header = document.createElement('div');
            header.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px;
                border-bottom: 1px solid #eee;
                background-color: #328AA4;
                color: white;
            `;
            
            // Create title with total count
            const titleEl = document.createElement('h3');
            titleEl.textContent = `Full List (${list.length} items)`;
            titleEl.style.margin = '0';
        
            // Close button
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '✕';
            closeBtn.style.cssText = `
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: white;
            `;
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
        
            header.appendChild(titleEl);
            header.appendChild(closeBtn);
        
            // Modal content (scrollable list)
            const content = document.createElement('div');
            content.style.cssText = `
                max-height: 50vh;
                overflow-y: auto;
                padding: 10px;
            `;
        
            // Create grid-like layout for list items
            const listContainer = document.createElement('div');
            listContainer.style.cssText = `
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 10px;
                padding: 10px;
            `;
        
            list.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.textContent = item;
                itemEl.style.cssText = `
                    border: 1px solid #eee;
                    padding: 5px;
                    background-color: #d4e4e6;
                    border-radius: 4px;
                    word-break: break-all;
                `;
                listContainer.appendChild(itemEl);
            });
        
            content.appendChild(listContainer);
        
            // Overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            `;
            overlay.addEventListener('click', () => {
                document.body.removeChild(modal);
                document.body.removeChild(overlay);
            });
        
            modal.appendChild(header);
            modal.appendChild(content);
        
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }

        // Modify calculateCumulativeMetrics to merge unique lists
        function calculateCumulativeMetrics(data, selectedTeam) {
            return data
                .filter(sp => sp.teams.some(team => team.team_name === selectedTeam))
                .map(sp => {
                    const teamData = sp.teams.find(team => team.team_name === selectedTeam);
                    if (!teamData) return null;

                    const processedPhases = teamData.phases.reduce((accumPhases, phase) => {
                        // Cumulative metrics calculation (similar to previous implementation)
                        let totalTCs = 0;
                        let totalCoverage = 0;
                        let totalPassed = 0;
                        let totalFailed = 0;
                        let totalBlocked = 0;
                        
                        // Merged lists for unique CRs and JIRAs
                        const mergedUniqueCRs = new Set();
                        const mergedUniqueJiras = new Set();

                        if (phase.coverage_types) {
                            phase.coverage_types.forEach(ct => {
                                // Metrics calculation
                                totalTCs += parseInt(ct.metrics.total || 0);
                                totalCoverage += parseInt(ct.metrics.coverage || 0);
                                totalPassed += parseInt(ct.metrics.passed || 0);
                                totalFailed += parseInt(ct.metrics.failed || 0);
                                totalBlocked += parseInt(ct.metrics.blocked || 0);

                                // Merge unique lists
                                ct.unique_cr_list.forEach(cr => mergedUniqueCRs.add(cr));
                                ct.unique_jira_list.forEach(jira => mergedUniqueJiras.add(jira));
                            });
                        } else {
                            // Similar metrics calculation for non-coverage type phase
                            totalTCs = parseInt(phase.metrics.total || 0);
                            totalCoverage = parseInt(phase.metrics.coverage || 0);
                            totalPassed = parseInt(phase.metrics.passed || 0);
                            totalFailed = parseInt(phase.metrics.failed || 0);
                            totalBlocked = parseInt(phase.metrics.blocked || 0);

                            // Merge unique lists directly from phase
                            (phase.unique_cr_list || []).forEach(cr => mergedUniqueCRs.add(cr));
                            (phase.unique_jira_list || []).forEach(jira => mergedUniqueJiras.add(jira));
                        }

                        const coveragePercentage = totalTCs > 0 ? (totalCoverage / totalTCs) * 100 : 0;
                        const passPercentage = totalTCs > 0 ? (totalPassed / totalTCs) * 100 : 0;
                        const failPercentage = totalTCs > 0 ? (totalFailed / totalTCs) * 100 : 0;
                        const blockPercentage = totalTCs > 0 ? (totalBlocked / totalTCs) * 100 : 0;

                        // Convert sets to sorted arrays
                        const uniqueCRList = Array.from(mergedUniqueCRs).sort();
                        const uniqueJiraList = Array.from(mergedUniqueJiras).sort();

                        accumPhases.push({
                            phase: phase.phase,
                            metrics: {
                                total: totalTCs,
                                coverage: totalCoverage,
                                coverage_percentage: coveragePercentage,
                                passed: totalPassed,
                                passed_percentage: passPercentage,
                                failed: totalFailed,
                                failed_percentage: failPercentage,
                                blocked: totalBlocked,
                                blocked_percentage: blockPercentage
                            },
                            unique_cr_list: uniqueCRList,
                            unique_cr_count: uniqueCRList.length,
                            unique_jira_list: uniqueJiraList,
                            unique_jira_count: uniqueJiraList.length
                        });

                        return accumPhases;
                    }, []);

                    return {
                        phases: processedPhases
                    };
                })
                .filter(Boolean);
        }

        // Modify renderCumulativeTable to include new columns and list formatting
        function renderCumulativeTable(data, targetElementId) {
            const table = document.createElement('table');
            table.className = 'coverage-table';

            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const headers = [
                'Phase', 
                'Total TCs',
                'Coverage', 'Coverage %',
                'Passed', 'Pass %',
                'Failed', 'Fail %',
                'Blocked', 'Block %',
                'Unique CRs',
                'Unique JIRAs'
            ];
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            data.forEach(sp => {
                sp.phases.forEach(phase => {
                    const tr = document.createElement('tr');
                    const cells = [
                        phase.phase,
                        phase.metrics.total,
                        phase.metrics.coverage,
                        formatPercentage(phase.metrics.coverage_percentage),
                        phase.metrics.passed,
                        formatPercentage(phase.metrics.passed_percentage),
                        phase.metrics.failed,
                        formatPercentage(phase.metrics.failed_percentage),
                        phase.metrics.blocked,
                        formatPercentage(phase.metrics.blocked_percentage)
                    ];

                    cells.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });

                    // Add Unique CRs column
                    const crTd = document.createElement('td');
                    crTd.innerHTML = formatLongList(phase.unique_cr_list, phase.unique_cr_count);
                    tr.appendChild(crTd);

                    // Add Unique JIRAs column
                    const jiraTd = document.createElement('td');
                    jiraTd.innerHTML = formatLongList(phase.unique_jira_list, phase.unique_jira_count);
                    tr.appendChild(jiraTd);

                    tbody.appendChild(tr);
                });
            });
            table.appendChild(tbody);

            // Render the table
            const targetElement = document.getElementById(targetElementId);
            targetElement.innerHTML = '';
            targetElement.appendChild(table);

            // Add event listeners for "more" links
            targetElement.addEventListener('click', (e) => {
                if (e.target.classList.contains('show-more-list')) {
                    e.preventDefault();
                    const title = e.target.getAttribute('data-title');
                    const list = JSON.parse(decodeURIComponent(e.target.getAttribute('data-list')));
                    createListModal(title, list);
                }
            });

            // Adjust column widths
            adjustColumnWidths();
        }
    });
    
</script>
{% endblock %}

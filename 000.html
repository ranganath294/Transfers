document.addEventListener('DOMContentLoaded', function() {
    // Helper functions
    function calculateSpRowspan(sp) {
        return sp.teams.reduce((acc, team) => {
            return acc + calculateTeamRowspan(team);
        }, 0);
    }

    function calculateTeamRowspan(team) {
        return team.phases.reduce((acc, phase) => {
            if (phase.coverage_types) {
                return acc + phase.coverage_types.length;
            }
            return acc + 1;
        }, 0);
    }

    function formatPercentage(value) {
        return value ? value.toFixed(2) + '%' : '0.00%';
    }

    function renderCoverageTable(data, targetElementId) {
        const table = document.createElement('table');
        table.className = 'coverage-table';

        // Create header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = [
            'SP Name',
            'Test Team',
            'Phase',
            'Date',
            'Coverage %',
            'Pass %',
            'Fail %',
            'Block %'
        ];

        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');
        data.forEach(sp => {
            const spRowspan = calculateSpRowspan(sp);
            let isFirstSpRow = true;

            sp.teams.forEach(team => {
                const teamRowspan = calculateTeamRowspan(team);
                let isFirstTeamRow = true;

                team.phases.forEach(phase => {
                    const tr = document.createElement('tr');

                    // SP Name column (with rowspan)
                    if (isFirstSpRow) {
                        const tdSp = document.createElement('td');
                        tdSp.textContent = sp.sp_name;
                        tdSp.rowSpan = spRowspan;
                        tr.appendChild(tdSp);
                        isFirstSpRow = false;
                    }

                    // Team Name column (with rowspan)
                    if (isFirstTeamRow) {
                        const tdTeam = document.createElement('td');
                        tdTeam.textContent = team.team_name;
                        tdTeam.rowSpan = teamRowspan;
                        tr.appendChild(tdTeam);
                        isFirstTeamRow = false;
                    }

                    // Phase and metrics
                    const cells = [
                        phase.phase,
                        phase.date,
                        formatPercentage(phase.metrics.coverage_percentage),
                        formatPercentage(phase.metrics.passed_percentage),
                        formatPercentage(phase.metrics.failed_percentage),
                        formatPercentage(phase.metrics.blocked_percentage)
                    ];

                    cells.forEach(cellData => {
                        const td = document.createElement('td');
                        td.textContent = cellData;
                        tr.appendChild(td);
                    });

                    tbody.appendChild(tr);
                });
            });
        });

        table.appendChild(tbody);

        // Add basic styles
        const style = document.createElement('style');
        style.textContent = `
            .coverage-table {
                border-collapse: collapse;
                width: 100%;
                margin: 20px 0;
            }
            .coverage-table th, 
            .coverage-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            .coverage-table th {
                background-color: #f5f5f5;
                font-weight: bold;
            }
            .coverage-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }
        `;
        document.head.appendChild(style);

        // Render the table
        const targetElement = document.getElementById(targetElementId);
        targetElement.innerHTML = '';
        targetElement.appendChild(table);
    }

    // Initial render if data is available
    if (typeof initialData !== 'undefined') {
        renderCoverageTable(initialData, 'tableContainer');
    }
});
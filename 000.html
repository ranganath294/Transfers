function renderSpTable(data, targetElementId) {
    const table = document.createElement('table');
    table.className = 'table table-bordered table-hover';
    
    // Create header
    const thead = document.createElement('thead');
    thead.className = 'thead-light';
    const headerRow = document.createElement('tr');
    const headers = [
        'SP Name', 'Test Team', 'Phase', 'Date', 
        'Coverage %', 'Pass %', 'Fail %', 'Block %'
    ];
    
    headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        th.style.backgroundColor = '#f8f9fa';
        th.style.position = 'sticky';
        th.style.top = '0';
        th.style.zIndex = '1';
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    data.forEach((sp, spIndex) => {
        const spRowspan = calculateSpRowspan(sp);
        let isFirstSpRow = true;
        
        sp.teams.forEach((team, teamIndex) => {
            const teamRowspan = calculateTeamRowspan(team);
            let isFirstTeamRow = true;
            
            team.phases.forEach((phase, phaseIndex) => {
                const tr = document.createElement('tr');
                tr.className = 'phase-row';
                tr.setAttribute('data-row-index', `${spIndex}-${teamIndex}-${phaseIndex}`);
                tr.setAttribute('data-team', team.team_name);
                tr.setAttribute('data-phase', phase.phase);
                tr.setAttribute('data-sp-name', sp.sp_name);
                
                // SP Name column with rowspan
                if (isFirstSpRow) {
                    const tdSp = document.createElement('td');
                    tdSp.innerHTML = `<a href="/sp-execution-data?sp=${sp.sp_name}" target="_blank">${sp.sp_name}</a>`;
                    tdSp.rowSpan = spRowspan;
                    tdSp.setAttribute('data-sp-cell', 'true');
                    tr.appendChild(tdSp);
                    isFirstSpRow = false;
                }
                
                // Team Name column with rowspan
                if (isFirstTeamRow) {
                    const tdTeam = document.createElement('td');
                    tdTeam.textContent = team.team_name;
                    tdTeam.rowSpan = teamRowspan;
                    tdTeam.setAttribute('data-team-cell', 'true');
                    tr.appendChild(tdTeam);
                    isFirstTeamRow = false;
                }
                
                // Add other cells
                appendMetricCell(tr, phase.phase);
                appendMetricCell(tr, phase.date);
                appendTooltipCell(tr, phase.metrics.coverage_percentage, 
                    `${sp.sp_name} ${team.team_name} ${phase.phase} Coverage`);
                appendTooltipCell(tr, phase.metrics.passed_percentage,
                    `${sp.sp_name} ${team.team_name} ${phase.phase} Pass`);
                appendTooltipCell(tr, phase.metrics.failed_percentage,
                    `${sp.sp_name} ${team.team_name} ${phase.phase} Fail`);
                appendTooltipCell(tr, phase.metrics.blocked_percentage,
                    `${sp.sp_name} ${team.team_name} ${phase.phase} Block`);
                
                tbody.appendChild(tr);
            });
        });
    });
    
    table.appendChild(tbody);
    
    // Add styles
    const style = document.createElement('style');
    style.textContent = `
        .tooltip-cell {
            position: relative;
            cursor: default;
        }
        
        .custom-tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        
        .tooltip-cell:hover .custom-tooltip {
            visibility: visible;
        }
        
        .phase-row:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        .highlighted-team {
            background-color: rgba(0, 123, 255, 0.1) !important;
        }
    `;
    document.head.appendChild(style);
    
    // Add highlighting behavior
    addRowHighlighting(tbody);
    
    // Render the table
    const targetElement = document.getElementById(targetElementId);
    targetElement.innerHTML = '';
    targetElement.appendChild(table);
}

// Helper functions
function calculateSpRowspan(sp) {
    return sp.teams.reduce((acc, team) => {
        return acc + calculateTeamRowspan(team);
    }, 0);
}

function calculateTeamRowspan(team) {
    return team.phases.length;
}

function formatPercent(value) {
    return typeof value === 'number' ? value.toFixed(1) : 'NA';
}

function appendMetricCell(row, content) {
    const td = document.createElement('td');
    td.textContent = content;
    row.appendChild(td);
}

function appendTooltipCell(row, value, tooltipText) {
    const td = document.createElement('td');
    td.className = 'tooltip-cell metric-cell';
    td.innerHTML = `
        ${formatPercent(value)}%
        <span class="custom-tooltip">${tooltipText}: ${formatPercent(value)}%</span>
    `;
    row.appendChild(td);
}

function addRowHighlighting(tbody) {
    const rows = tbody.querySelectorAll('.phase-row');
    
    rows.forEach(row => {
        row.addEventListener('mouseenter', () => {
            const spName = row.getAttribute('data-sp-name');
            const team = row.getAttribute('data-team');
            const rowIndex = row.getAttribute('data-row-index');
            
            row.classList.add('highlighted-team');
            
            document.querySelectorAll('[data-sp-cell="true"]').forEach(spCell => {
                if (spCell.textContent.trim().includes(spName)) {
                    spCell.classList.add('highlighted-team');
                }
            });
            
            document.querySelectorAll('[data-team-cell="true"]').forEach(teamCell => {
                if (teamCell.textContent.trim() === team) {
                    const teamRow = teamCell.closest('tr');
                    if (teamRow.getAttribute('data-row-index').startsWith(rowIndex.split('-')[0])) {
                        teamCell.classList.add('highlighted-team');
                    }
                }
            });
        });
        
        row.addEventListener('mouseleave', () => {
            document.querySelectorAll('.highlighted-team').forEach(el => {
                el.classList.remove('highlighted-team');
            });
        });
    });
}





document.addEventListener('DOMContentLoaded', function() {
    const tableData = {{ table_data|safe }};  // Your data from the server
    renderSpTable(tableData, 'targetElementId');
});
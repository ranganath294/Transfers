<table id="activeSpsTable" class="table table-bordered table-hover">
    <thead class="thead-light">
        <tr>
            <th>SP Name</th>
            <th>Test Team</th>
            <th>Date</th>
            <th>Phase</th>
            <th>Coverage Type</th>
            <th>Total TCs</th>
            <th>Coverage</th>
            <th>Coverage %</th>
            <th>Passed</th>
            <th>Pass %</th>
            <th>Failed</th>
            <th>Fail %</th>
            <th>Blocked</th>
            <th>Block %</th>
        </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>






function renderTable() {
    if (!tableData) return;
    
    tableBody.innerHTML = '';
    let rowCounter = 0;
    
    tableData.forEach((spData, spIndex) => {
        let firstSpRow = true;
        const filteredTeams = spData.teams.filter(team => 
            selectedTeams.includes('all') || selectedTeams.includes(team.team_name)
        );
        
        // Calculate total rows for SP
        const spTotalRows = filteredTeams.reduce((acc, team) => {
            return acc + team.phases.reduce((phaseAcc, phase) => {
                return phaseAcc + (phase.coverage_types ? phase.coverage_types.length : 1);
            }, 0);
        }, 0);
        
        filteredTeams.forEach((team, teamIndex) => {
            let firstTeamRow = true;
            
            // Calculate total rows for team
            const teamTotalRows = team.phases.reduce((acc, phase) => {
                return acc + (phase.coverage_types ? phase.coverage_types.length : 1);
            }, 0);
            
            team.phases.forEach((phase, phaseIndex) => {
                const coverageTypes = phase.coverage_types || [{
                    coverage_type: '',
                    metrics: phase.metrics
                }];
                
                coverageTypes.forEach((coverageData, typeIndex) => {
                    let row = document.createElement('tr');
                    row.className = 'phase-row';
                    row.setAttribute('data-row-index', rowCounter++);
                    row.setAttribute('data-sp-index', spIndex);
                    row.setAttribute('data-team-index', teamIndex);
                    row.setAttribute('data-team', team.team_name);
                    row.setAttribute('data-phase', phase.phase);
                    row.setAttribute('data-sp-name', spData.sp_name);
                    
                    // Add SP Name cell with appropriate rowspan
                    if (firstSpRow) {
                        let spCell = document.createElement('td');
                        spCell.rowSpan = spTotalRows;
                        spCell.innerHTML = `
                            <a href="/sp-execution-data?sp=${spData.sp_name}" target="_blank">
                                ${spData.sp_name}
                            </a>
                        `;
                        spCell.setAttribute('data-sp-cell', 'true');
                        row.appendChild(spCell);
                        firstSpRow = false;
                    }
                    
                    // Add Team Name cell with appropriate rowspan
                    if (firstTeamRow) {
                        let teamCell = document.createElement('td');
                        teamCell.rowSpan = teamTotalRows;
                        teamCell.textContent = team.team_name;
                        teamCell.setAttribute('data-team-cell', 'true');
                        row.appendChild(teamCell);
                        firstTeamRow = false;
                    }
                    
                    // Add Date cell
                    row.insertAdjacentHTML('beforeend', `<td>${phase.date}</td>`);
                    
                    // Add Phase cell with appropriate rowspan if first coverage type
                    if (typeIndex === 0) {
                        let phaseCell = document.createElement('td');
                        phaseCell.rowSpan = coverageTypes.length;
                        phaseCell.textContent = phase.phase;
                        row.appendChild(phaseCell);
                    }
                    
                    // Add Coverage Type and metrics
                    row.insertAdjacentHTML('beforeend', `
                        <td>${coverageData.coverage_type}</td>
                        ${createValueCell(coverageData.metrics.total, `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Total ${coverageData.metrics.total}`)}
                        ${createValueCell(coverageData.metrics.coverage, `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Coverage ${coverageData.metrics.coverage}`)}
                        ${createPercentageCell(
                            coverageData.metrics.coverage_percentage,
                            `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Coverage ${formatPercent(coverageData.metrics.coverage_percentage)}%`
                        )}
                        ${createValueCell(coverageData.metrics.passed, `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Passed ${coverageData.metrics.passed}`)}
                        ${createPercentageCell(
                            coverageData.metrics.passed_percentage,
                            `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Pass ${formatPercent(coverageData.metrics.passed_percentage)}%`
                        )}
                        ${createValueCell(coverageData.metrics.failed, `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Failed ${coverageData.metrics.failed}`)}
                        ${createPercentageCell(
                            coverageData.metrics.failed_percentage,
                            `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Fail ${formatPercent(coverageData.metrics.failed_percentage)}%`
                        )}
                        ${createValueCell(coverageData.metrics.blocked, `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Blocked ${coverageData.metrics.blocked}`)}
                        ${createPercentageCell(
                            coverageData.metrics.blocked_percentage,
                            `${spData.sp_name} ${team.team_name} ${phase.phase} ${coverageData.coverage_type} Block ${formatPercent(coverageData.metrics.blocked_percentage)}%`
                        )}
                    `);
                    
                    tableBody.appendChild(row);
                });
            });
        });
    });
    
    addRowHighlighting();
}






/* Update the left-aligned columns */
.table th:nth-child(-n+5),
.table td:nth-child(-n+5) {
    text-align: left;
}

/* Add some styling for coverage type column */
td:nth-child(5) {
    font-style: italic;
    color: #666;
}

{% block results_div %}
{% if devices %}
<!-- Your existing table code remains the same until the scripts -->

<!-- Add this modal HTML after your table div but before scripts -->
<div class="modal fade" id="userAssignmentModal" tabindex="-1" aria-labelledby="userAssignmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userAssignmentModalLabel">Assign User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="userSelect" class="form-label">Select User</label>
                    <select class="form-select" id="userSelect">
                        <option value="">Choose...</option>
                        {% for username in usernames %}
                            <option value="{{ username }}">{{ username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Your existing table styles remain the same */

    /* Add these new styles */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
    }

    .current-user-cell {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .current-user-text {
        flex-grow: 1;
    }

    .current-user-edit-icon {
        color: #6c757d;
        cursor: pointer;
        transition: color 0.2s ease;
    }

    .current-user-edit-icon:hover {
        color: #0d6efd;
    }
</style>

<script id="devices-data" type="application/json">
    {{ devices|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const devicesData = JSON.parse(document.getElementById('devices-data').textContent);
    const tableBody = document.getElementById('results-table-body');
    
    devicesData.forEach(device => {
        const row = document.createElement('tr');
        for (const key in device) {
            const cell = document.createElement('td');

            if (key === "current_user__username") {
                const container = document.createElement('div');
                container.className = 'current-user-cell';

                const userText = document.createElement('span');
                userText.className = 'current-user-text';
                userText.textContent = device[key] || '';
                container.appendChild(userText);

                const editIcon = document.createElement('i');
                editIcon.className = 'fas fa-edit current-user-edit-icon';
                editIcon.setAttribute('title', 'Edit User Assignment');

                editIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Pre-select current user if exists
                    const userSelect = document.getElementById('userSelect');
                    if (device[key]) {
                        userSelect.value = device[key];
                    } else {
                        userSelect.selectedIndex = 0;
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('userAssignmentModal'));
                    modal.show();
                });

                container.appendChild(editIcon);
                cell.appendChild(container);
            } else {
                cell.textContent = device[key];
            }

            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });
});
</script>
{% endif %}
{% endblock %}
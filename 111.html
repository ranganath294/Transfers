{% extends "generate_config/base.html" %}
{% load static %}

{% block content %}

<div class="mb-3">
    <label class="form-label" for="config-select">Select Config</label>
    <select name="config" class="config-select optimized-select" id="config-select" data-modal>
        <option value="default" selected>Select</option>
        {% for config in configs_list %}
        <option value="{{ config.name }}">{{ config.name }}</option>
        {% endfor %}
    </select>
</div>

<style>
    .optimized-select-wrapper {
        position: relative;
        width: 100%;
    }

    .optimized-select-button {
        width: 100%;
        text-align: left;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .optimized-select-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1000;
        margin-top: 0.25rem;
    }

    .optimized-select-search {
        width: 100%;
        padding: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.375rem 0.375rem 0 0;
    }

    .optimized-select-options {
        overflow-y: auto;
        max-height: 250px;
        position: relative;
        border-radius: 0 0 0.375rem 0.375rem;
    }

    .optimized-select-option {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }

    .optimized-select-option:hover {
        background-color: #f8f9fa;
    }

    .optimized-select-option.selected {
        background-color: #e9ecef;
    }

    .dropdown-toggle::after {
        margin-left: 0.5rem;
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .optimized-select-dropdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
    }

    /* Custom scrollbar */
    .optimized-select-options::-webkit-scrollbar {
        width: 6px;
    }

    .optimized-select-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .optimized-select-options::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .optimized-select-options::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>


<script>
    class OptimizedSelect {
        constructor(originalSelect, options = {}) {
            if (originalSelect.dataset.initialized) return;

            this.originalSelect = originalSelect;
            this.options = {
                searchPlaceholder: 'Search...',
                noResultsText: 'No results found',
                ...options
            };

            this.elementId = originalSelect.id;
            this.itemHeight = 40;
            this.visibleItems = 8;
            this.isOpen = false;

            this.allOptions = Array.from(originalSelect.options)
                .filter(opt => opt.value !== 'default')
                .map(opt => ({
                    value: opt.value,
                    label: opt.text
                }));

            originalSelect.dataset.initialized = 'true';
            this.init();
        }

        init() {
            this.createWrapper();
            this.createButton();
            this.createDropdown();
            this.createSearchInput();
            this.createOptionsContainer();

            this.originalSelect.style.display = 'none';
            this.originalSelect.parentNode.insertBefore(this.wrapper, this.originalSelect.nextSibling);

            this.addEventListeners();
            this.updateButtonText();
        }

        createWrapper() {
            this.wrapper = document.createElement('div');
            this.wrapper.className = 'optimized-select-wrapper';
            this.wrapper.id = `${this.elementId}-wrapper`;
        }

        createButton() {
            this.button = document.createElement('button');
            this.button.className = 'optimized-select-button form-select dropdown-toggle';
            this.button.id = `${this.elementId}-button`;
            this.button.type = 'button';
            this.wrapper.appendChild(this.button);
        }

        createDropdown() {
            this.dropdown = document.createElement('div');
            this.dropdown.className = 'optimized-select-dropdown';
            this.dropdown.id = `${this.elementId}-dropdown`;
            this.wrapper.appendChild(this.dropdown);
        }

        createSearchInput() {
            this.searchInput = document.createElement('input');
            this.searchInput.className = 'optimized-select-search form-control';
            this.searchInput.id = `${this.elementId}-search`;
            this.searchInput.placeholder = this.options.searchPlaceholder;
            this.dropdown.appendChild(this.searchInput);
        }

        createOptionsContainer() {
            this.optionsContainer = document.createElement('div');
            this.optionsContainer.className = 'optimized-select-options';
            this.optionsContainer.id = `${this.elementId}-options`;
            this.dropdown.appendChild(this.optionsContainer);
        }

        addEventListeners() {
            this.button.addEventListener('click', () => this.toggleDropdown());

            this.searchInput.addEventListener('input', () => this.filterOptions());

            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') this.closeDropdown();
            });

            document.addEventListener('mousedown', (e) => {
                if (!this.wrapper.contains(e.target)) {
                    this.closeDropdown();
                }
            });
        }

        toggleDropdown() {
            this.isOpen ? this.closeDropdown() : this.openDropdown();
        }

        openDropdown() {
            this.isOpen = true;
            this.dropdown.style.display = 'block';
            this.searchInput.value = '';
            this.searchInput.focus();
            this.filterOptions();
        }

        closeDropdown() {
            this.isOpen = false;
            this.dropdown.style.display = 'none';
        }

        filterOptions() {
            const searchTerm = this.searchInput.value.toLowerCase();
            const filteredOptions = this.allOptions.filter(option => 
                option.label.toLowerCase().includes(searchTerm)
            );

            this.renderOptions(filteredOptions);
        }

        renderOptions(options) {
            this.optionsContainer.innerHTML = '';

            if (options.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'optimized-select-option text-muted text-center p-2';
                noResults.textContent = this.options.noResultsText;
                this.optionsContainer.appendChild(noResults);
                return;
            }

            options.forEach(option => {
                const optionEl = document.createElement('div');
                optionEl.className = 'optimized-select-option';
                optionEl.textContent = option.label;
                
                if (option.value === this.originalSelect.value) {
                    optionEl.classList.add('selected');
                }

                optionEl.addEventListener('click', () => {
                    this.selectOption(option);
                });

                this.optionsContainer.appendChild(optionEl);
            });
        }

        selectOption(option) {
            this.originalSelect.value = option.value;
            this.originalSelect.dispatchEvent(new Event('change'));
            this.updateButtonText(option);
            this.closeDropdown();
        }

        updateButtonText(selectedOption = null) {
            const selectedOpt = selectedOption || 
                this.allOptions.find(opt => opt.value === this.originalSelect.value) || 
                { label: 'Select' };
            
            this.button.textContent = selectedOpt.label;
        }

        // Static method to initialize all selects with class 'optimized-select'
        static initializeAll() {
            document.querySelectorAll('.optimized-select').forEach(select => {
                new OptimizedSelect(select);
            });
        }
    }

    // Initialize on DOM load
    document.addEventListener('DOMContentLoaded', () => {
        OptimizedSelect.initializeAll();
    });
</script>

{% endblock %}

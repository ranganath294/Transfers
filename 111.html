class ConfigInputHandler {
    constructor(containerSelector) {
        this.container = document.querySelector(containerSelector);
        this.inputTypes = {
            STRING: 'string',
            ARRAY: 'array',
            OBJECT: 'object',
            BOOLEAN: 'boolean',
            NUMBER: 'number'
        };
    }

    // Create card wrapper for inputs
    createCardWrapper(title, content) {
        const card = document.createElement('div');
        card.className = 'card mb-3 shadow-sm';

        const cardHeader = document.createElement('div');
        cardHeader.className = 'card-header bg-light d-flex justify-content-between align-items-center';
        cardHeader.textContent = title;

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        cardBody.appendChild(content);

        card.appendChild(cardHeader);
        card.appendChild(cardBody);

        return card;
    }

    // Create reorderable list
    createArrayInput(defaultValue, onChangeCallback) {
        const container = document.createElement('div');
        container.className = 'reorderable-list-container';

        // List to store array values
        const arrayValues = Array.isArray(defaultValue) ? [...defaultValue] : [];

        // Function to render array items
        const renderArrayItems = () => {
            container.innerHTML = ''; // Clear existing items
            
            arrayValues.forEach((value, index) => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'input-group mb-2 align-items-center';

                // Move up button
                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'btn btn-outline-secondary me-1';
                moveUpBtn.innerHTML = '↑';
                moveUpBtn.type = 'button';
                moveUpBtn.disabled = index === 0;
                moveUpBtn.addEventListener('click', () => {
                    // Swap current item with the one above
                    [arrayValues[index], arrayValues[index-1]] = [arrayValues[index-1], arrayValues[index]];
                    renderArrayItems();
                    onChangeCallback(arrayValues);
                });

                // Move down button
                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'btn btn-outline-secondary me-2';
                moveDownBtn.innerHTML = '↓';
                moveDownBtn.type = 'button';
                moveDownBtn.disabled = index === arrayValues.length - 1;
                moveDownBtn.addEventListener('click', () => {
                    // Swap current item with the one below
                    [arrayValues[index], arrayValues[index+1]] = [arrayValues[index+1], arrayValues[index]];
                    renderArrayItems();
                    onChangeCallback(arrayValues);
                });

                // Input for list item
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.value = value?.toString() || '';

                // Update value in arrayValues
                input.addEventListener('input', (e) => {
                    arrayValues[index] = e.target.value;
                    onChangeCallback(arrayValues);
                });

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger ms-2';
                removeBtn.innerHTML = '&times;';
                removeBtn.type = 'button';
                removeBtn.addEventListener('click', () => {
                    arrayValues.splice(index, 1);
                    renderArrayItems();
                    onChangeCallback(arrayValues);
                });

                // Assemble item
                itemWrapper.appendChild(moveUpBtn);
                itemWrapper.appendChild(moveDownBtn);
                itemWrapper.appendChild(input);
                itemWrapper.appendChild(removeBtn);

                container.appendChild(itemWrapper);
            });

            // Add new item button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary mt-2';
            addBtn.textContent = 'Add Item';
            addBtn.type = 'button';
            addBtn.addEventListener('click', () => {
                arrayValues.push('');
                renderArrayItems();
                onChangeCallback(arrayValues);
            });

            container.appendChild(addBtn);
        };

        renderArrayItems();
        return container;
    }

    // Existing methods for other input types (simplified)
    createInputTypeSelector(currentType, onChangeCallback) {
        const select = document.createElement('select');
        select.className = 'form-select mb-2';

        Object.values(this.inputTypes).forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            if (type === currentType) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            onChangeCallback(e.target.value);
        });

        return select;
    }

    // Simplified methods for other input types
    createStringInput(defaultValue, onChangeCallback) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = defaultValue?.toString() || '';
        input.addEventListener('input', (e) => {
            onChangeCallback(e.target.value);
        });
        return input;
    }

    createBooleanInput(defaultValue, onChangeCallback) {
        const select = document.createElement('select');
        select.className = 'form-select';

        ['true', 'false'].forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value.charAt(0).toUpperCase() + value.slice(1);
            if (value === defaultValue.toString()) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            onChangeCallback(e.target.value === 'true');
        });

        return select;
    }

    createNumberInput(defaultValue, onChangeCallback) {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.value = defaultValue || 0;
        input.addEventListener('input', (e) => {
            onChangeCallback(Number(e.target.value));
        });
        return input;
    }

    createObjectInput(defaultValue, onChangeCallback) {
        const container = document.createElement('div');
        const objectValues = typeof defaultValue === 'object' && defaultValue !== null 
            ? Object.entries(defaultValue).map(([k, v]) => ({ key: k, value: v })) 
            : [];

        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.className = 'form-control mb-2';
        keyInput.placeholder = 'Key';

        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.className = 'form-control mb-2';
        valueInput.placeholder = 'Value';

        const addBtn = document.createElement('button');
        addBtn.className = 'btn btn-primary';
        addBtn.textContent = 'Add Key-Value Pair';
        addBtn.type = 'button';

        // More implementation needed for object input
        return container;
    }

    // Detect input type based on default value
    detectInputType(defaultValue) {
        if (Array.isArray(defaultValue)) return this.inputTypes.ARRAY;
        if (typeof defaultValue === 'object' && defaultValue !== null) return this.inputTypes.OBJECT;
        if (typeof defaultValue === 'boolean') return this.inputTypes.BOOLEAN;
        if (typeof defaultValue === 'number') return this.inputTypes.NUMBER;
        return this.inputTypes.STRING;
    }

    // Create input based on type
    createInputBasedOnType(type, defaultValue) {
        const onChangeCallback = (value) => {
            console.log('Value changed:', value);
        };

        switch(type) {
            case this.inputTypes.STRING:
                return this.createStringInput(defaultValue, onChangeCallback);
            case this.inputTypes.ARRAY:
                return this.createArrayInput(defaultValue, onChangeCallback);
            case this.inputTypes.OBJECT:
                return this.createObjectInput(defaultValue, onChangeCallback);
            case this.inputTypes.BOOLEAN:
                return this.createBooleanInput(defaultValue, onChangeCallback);
            case this.inputTypes.NUMBER:
                return this.createNumberInput(defaultValue, onChangeCallback);
            default:
                return this.createStringInput(defaultValue, onChangeCallback);
        }
    }

    // Create dynamic input with card wrapper
    createDynamicInput(fieldName, fieldConfig) {
        const { default: defaultValue, required, ui_displayed_name, example } = fieldConfig;
        
        // Container for the entire input
        const container = document.createElement('div');
        container.className = 'dynamic-input-wrapper';

        // Label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${required !== false ? 'required-label' : ''}`;
        label.textContent = `${ui_displayed_name} ${required !== false ? '(required)' : '(optional)'}`;

        // Current input type
        let currentInputType = this.detectInputType(defaultValue);
        let currentInputElement;

        // Input type selector
        const typeSelector = this.createInputTypeSelector(currentInputType, (newType) => {
            // Remove existing input
            if (currentInputElement) {
                container.removeChild(currentInputElement);
            }

            // Create new input based on selected type
            currentInputType = newType;
            currentInputElement = this.createInputBasedOnType(newType, defaultValue);
            container.appendChild(currentInputElement);
        });

        // Initial input
        currentInputElement = this.createInputBasedOnType(currentInputType, defaultValue);

        // Combine elements
        container.appendChild(label);
        container.appendChild(typeSelector);
        container.appendChild(currentInputElement);

        // Wrap in a card
        return this.createCardWrapper(ui_displayed_name, container);
    }
}

// Modify the renderConfigurationForm function to use this new handler
function renderConfigurationForm(configData) {
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    dynamicFieldsContainer.innerHTML = ''; // Clear existing fields

    // Create input handler
    const inputHandler = new ConfigInputHandler('#dynamicFields');

    // Render fields based on config data
    Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
        if (fieldConfig.show) {
            const dynamicInput = inputHandler.createDynamicInput(fieldName, fieldConfig);
            dynamicFieldsContainer.appendChild(dynamicInput);
        }
    });

    // Show the form container
    document.getElementById('configFormContainer').style.display = 'block';
}
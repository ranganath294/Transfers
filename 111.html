// Configuration Input Type Handler
class ConfigInputHandler {
    constructor(containerSelector) {
        this.container = document.querySelector(containerSelector);
        this.inputTypes = {
            STRING: 'string',
            ARRAY: 'array',
            OBJECT: 'object',
            BOOLEAN: 'boolean',
            NUMBER: 'number'
        };
    }

    // Detect input type based on default value
    detectInputType(defaultValue) {
        if (Array.isArray(defaultValue)) return this.inputTypes.ARRAY;
        if (typeof defaultValue === 'object' && defaultValue !== null) return this.inputTypes.OBJECT;
        if (typeof defaultValue === 'boolean') return this.inputTypes.BOOLEAN;
        if (typeof defaultValue === 'number') return this.inputTypes.NUMBER;
        return this.inputTypes.STRING;
    }

    // Create input type selector
    createInputTypeSelector(currentType, onChangeCallback) {
        const select = document.createElement('select');
        select.className = 'form-select mb-2';

        Object.values(this.inputTypes).forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type.charAt(0).toUpperCase() + type.slice(1);
            if (type === currentType) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            onChangeCallback(e.target.value);
        });

        return select;
    }

    // Create input for string type
    createStringInput(defaultValue, onChangeCallback) {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'form-control';
        input.value = defaultValue?.toString() || '';
        input.placeholder = 'Enter string value';
        
        input.addEventListener('input', (e) => {
            onChangeCallback(e.target.value);
        });

        return input;
    }

    // Create input for array type
    createArrayInput(defaultValue, onChangeCallback) {
        const container = document.createElement('div');
        container.className = 'array-input-container';

        // List to store array values
        const arrayValues = Array.isArray(defaultValue) ? [...defaultValue] : [];

        // Function to render array items
        const renderArrayItems = () => {
            container.innerHTML = ''; // Clear existing items
            
            arrayValues.forEach((value, index) => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'input-group mb-2';

                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'form-control';
                input.value = value;

                // Update value in arrayValues
                input.addEventListener('input', (e) => {
                    arrayValues[index] = e.target.value;
                    onChangeCallback(arrayValues);
                });

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', () => {
                    arrayValues.splice(index, 1);
                    renderArrayItems();
                    onChangeCallback(arrayValues);
                });

                itemWrapper.appendChild(input);
                itemWrapper.appendChild(removeBtn);
                container.appendChild(itemWrapper);
            });

            // Add new item button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary mt-2';
            addBtn.textContent = 'Add Item';
            addBtn.addEventListener('click', () => {
                arrayValues.push('');
                renderArrayItems();
            });

            container.appendChild(addBtn);
        };

        renderArrayItems();
        return container;
    }

    // Create input for object type
    createObjectInput(defaultValue, onChangeCallback) {
        const container = document.createElement('div');
        container.className = 'object-input-container';

        // List to store object key-value pairs
        const objectValues = typeof defaultValue === 'object' && defaultValue !== null 
            ? Object.entries(defaultValue).map(([k, v]) => ({ key: k, value: v })) 
            : [];

        // Function to render object items
        const renderObjectItems = () => {
            container.innerHTML = ''; // Clear existing items
            
            objectValues.forEach((item, index) => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'input-group mb-2';

                // Key input
                const keyInput = document.createElement('input');
                keyInput.type = 'text';
                keyInput.className = 'form-control';
                keyInput.placeholder = 'Key';
                keyInput.value = item.key;

                // Value input
                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.className = 'form-control';
                valueInput.placeholder = 'Value';
                valueInput.value = item.value?.toString() || '';

                // Update key
                keyInput.addEventListener('input', (e) => {
                    objectValues[index].key = e.target.value;
                    onChangeCallback(objectValues.reduce((acc, curr) => {
                        if (curr.key) acc[curr.key] = curr.value;
                        return acc;
                    }, {}));
                });

                // Update value
                valueInput.addEventListener('input', (e) => {
                    objectValues[index].value = e.target.value;
                    onChangeCallback(objectValues.reduce((acc, curr) => {
                        if (curr.key) acc[curr.key] = curr.value;
                        return acc;
                    }, {}));
                });

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger';
                removeBtn.innerHTML = '&times;';
                removeBtn.addEventListener('click', () => {
                    objectValues.splice(index, 1);
                    renderObjectItems();
                    onChangeCallback(objectValues.reduce((acc, curr) => {
                        if (curr.key) acc[curr.key] = curr.value;
                        return acc;
                    }, {}));
                });

                itemWrapper.appendChild(keyInput);
                itemWrapper.appendChild(valueInput);
                itemWrapper.appendChild(removeBtn);
                container.appendChild(itemWrapper);
            });

            // Add new item button
            const addBtn = document.createElement('button');
            addBtn.className = 'btn btn-primary mt-2';
            addBtn.textContent = 'Add Key-Value Pair';
            addBtn.addEventListener('click', () => {
                objectValues.push({ key: '', value: '' });
                renderObjectItems();
            });

            container.appendChild(addBtn);
        };

        renderObjectItems();
        return container;
    }

    // Create input for boolean type
    createBooleanInput(defaultValue, onChangeCallback) {
        const select = document.createElement('select');
        select.className = 'form-select';

        ['true', 'false'].forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = value.charAt(0).toUpperCase() + value.slice(1);
            if (value === defaultValue.toString()) option.selected = true;
            select.appendChild(option);
        });

        select.addEventListener('change', (e) => {
            onChangeCallback(e.target.value === 'true');
        });

        return select;
    }

    // Create input for number type
    createNumberInput(defaultValue, onChangeCallback) {
        const input = document.createElement('input');
        input.type = 'number';
        input.className = 'form-control';
        input.value = defaultValue || 0;
        input.placeholder = 'Enter number value';
        
        input.addEventListener('input', (e) => {
            onChangeCallback(Number(e.target.value));
        });

        return input;
    }

    // Main method to create dynamic input
    createDynamicInput(fieldName, fieldConfig) {
        const { default: defaultValue, required, ui_displayed_name, example } = fieldConfig;
        
        // Container for the entire input
        const container = document.createElement('div');
        container.className = 'dynamic-input-wrapper';

        // Label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${required !== false ? 'required-label' : ''}`;
        label.textContent = `${ui_displayed_name} ${required !== false ? '(required)' : '(optional)'}`;
        container.appendChild(label);

        // Current input type
        let currentInputType = this.detectInputType(defaultValue);
        let currentInputElement;

        // Input type selector
        const typeSelector = this.createInputTypeSelector(currentInputType, (newType) => {
            // Remove existing input
            if (currentInputElement) {
                container.removeChild(currentInputElement);
            }

            // Create new input based on selected type
            currentInputType = newType;
            currentInputElement = this.createInputBasedOnType(newType, defaultValue);
            container.appendChild(currentInputElement);
        });
        container.appendChild(typeSelector);

        // Initial input
        currentInputElement = this.createInputBasedOnType(currentInputType, defaultValue);
        container.appendChild(currentInputElement);

        return container;
    }

    // Helper method to create input based on type
    createInputBasedOnType(type, defaultValue) {
        const onChangeCallback = (value) => {
            // You can add additional logic here if needed
            console.log('Value changed:', value);
        };

        switch(type) {
            case this.inputTypes.STRING:
                return this.createStringInput(defaultValue, onChangeCallback);
            case this.inputTypes.ARRAY:
                return this.createArrayInput(defaultValue, onChangeCallback);
            case this.inputTypes.OBJECT:
                return this.createObjectInput(defaultValue, onChangeCallback);
            case this.inputTypes.BOOLEAN:
                return this.createBooleanInput(defaultValue, onChangeCallback);
            case this.inputTypes.NUMBER:
                return this.createNumberInput(defaultValue, onChangeCallback);
            default:
                return this.createStringInput(defaultValue, onChangeCallback);
        }
    }
}

// Modify the renderConfigurationForm function to use this new handler
function renderConfigurationForm(configData) {
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    dynamicFieldsContainer.innerHTML = ''; // Clear existing fields

    // Create input handler
    const inputHandler = new ConfigInputHandler('#dynamicFields');

    // Render fields based on config data
    Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
        if (fieldConfig.show) {
            const dynamicInput = inputHandler.createDynamicInput(fieldName, fieldConfig);
            dynamicFieldsContainer.appendChild(dynamicInput);
        }
    });

    // Show the form container
    document.getElementById('configFormContainer').style.display = 'block';
}
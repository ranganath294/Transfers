document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const parsedData = {};
    const dynamicFields = document.getElementById('dynamicFields');
    const inputs = dynamicFields.querySelectorAll('input, select');

    // Add the selected configuration type to parsedData
    const selectedConfig = document.getElementById('configDropdown').value;
    parsedData['config_name'] = selectedConfig;

    inputs.forEach(input => {
        const fieldName = input.getAttribute('name') || input.id;
        
        if (fieldName) {
            let value;

            // Handle different input types and structures
            if (input.closest('.nested-array-container')) {
                // Handle nested array inputs
                const arrayContainer = input.closest('.nested-array-container');
                value = parseNestedArrayInput(arrayContainer);
            } else if (input.closest('.nested-object-container')) {
                // Handle nested object inputs
                const objectContainer = input.closest('.nested-object-container');
                value = parseNestedObjectInput(objectContainer);
            } else {
                // Standard input parsing
                value = parseInputValue(input);
            }

            parsedData[fieldName] = value;
        }
    });

    console.log('Parsed Configuration Data:', parsedData);

    // Optionally, add AJAX submission here
});

// Helper function to parse input values
function parseInputValue(input) {
    const value = input.value.trim();

    // Boolean parsing
    if (value.toLowerCase() === 'true') return true;
    if (value.toLowerCase() === 'false') return false;

    // Number parsing
    if (!isNaN(value) && value !== '') {
        return Number(value);
    }

    // JSON parsing for arrays and objects
    try {
        if ((value.startsWith('[') && value.endsWith(']')) || 
            (value.startsWith('{') && value.endsWith('}'))) {
            return JSON.parse(value);
        }
    } catch (error) {
        console.warn(`Could not parse JSON for input: ${input.name}`, error);
    }

    // Default to string
    return value;
}

// Function to parse nested array inputs
function parseNestedArrayInput(arrayContainer) {
    const items = arrayContainer.querySelectorAll('.nested-array-item');
    const parsedArray = [];

    items.forEach(item => {
        const input = item.querySelector('input, select');
        if (input) {
            parsedArray.push(parseInputValue(input));
        }
    });

    return parsedArray;
}

// Function to parse nested object inputs
function parseNestedObjectInput(objectContainer) {
    const items = objectContainer.querySelectorAll('.nested-object-item');
    const parsedObject = {};

    items.forEach(item => {
        const keyInput = item.querySelector('input[placeholder="Key"]');
        const valueInput = item.querySelector('input:not([placeholder="Key"]), select');

        if (keyInput && valueInput) {
            const key = keyInput.value.trim();
            const value = parseInputValue(valueInput);

            if (key) {
                parsedObject[key] = value;
            }
        }
    });

    return parsedObject;
}
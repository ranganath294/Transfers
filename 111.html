{% extends "generate_config/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid p-3">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">Generate Configuration</h2>
            <form id="configGenerationForm" method="POST" action="{% url 'generate_config:generate_config' %}">
                {% csrf_token %}
                <div class="row g-3" id="dynamicFields">
                    <!-- Fields will be dynamically inserted here -->
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Generate Config</button>
                    <button type="reset" class="btn btn-secondary ms-2">Reset</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .required-label::after {
        content: " *";
        color: red;
    }
    @media (max-width: 768px) {
        .form-label {
            font-size: 0.9rem;
        }
        .form-control {
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration data passed from Django context
    const configData = {{ config_json|safe }};

    // Function to render input based on data type
    function renderInput(fieldName, fieldConfig) {
        // Create column wrapper for responsiveness
        const colWrapper = document.createElement('div');
        colWrapper.className = 'col-12 col-md-6 col-lg-4 mb-3';

        // Create input group
        const inputGroup = document.createElement('div');

        // Create label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
        label.textContent = `${fieldName} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
        inputGroup.appendChild(label);

        // Create input or textarea
        let inputElement;
        if (Array.isArray(fieldConfig.default) || 
            (typeof fieldConfig.default === 'object' && fieldConfig.default !== null)) {
            // Textarea for arrays and objects
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
            inputElement.rows = 3;
        } else {
            // Standard text input
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = fieldConfig.default;
        }

        inputElement.id = fieldName;
        inputElement.name = fieldName;
        inputElement.className = 'form-control';
        inputElement.placeholder = `Enter ${fieldName}`;
        
        if (fieldConfig.required !== false) {
            inputElement.required = true;
        }

        inputGroup.appendChild(inputElement);

        // Example text
        const exampleText = document.createElement('small');
        exampleText.className = 'form-text text-muted';
        exampleText.textContent = `Example: ${JSON.stringify(fieldConfig.default)}`;
        inputGroup.appendChild(exampleText);

        // Add to column wrapper
        colWrapper.appendChild(inputGroup);

        return colWrapper;
    }

    // Render dynamic fields
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
        if (fieldConfig.show) {
            dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
        }
    });

    // Form submission handler
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    const value = element.value.trim();
                    
                    if (value.startsWith('[') || value.startsWith('{')) {
                        // Parse JSON for arrays and objects
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        // Parse boolean
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        // Parse number
                        parsedData[element.name] = Number(value);
                    } else {
                        // Keep as string
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        // Submit via AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === 'success') {
                alert('Config generated successfully!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
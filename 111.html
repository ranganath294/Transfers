document.addEventListener('DOMContentLoaded', function() {
    // Initialize optimized selects
    document.querySelectorAll('.optimized-select:not([data-modal])').forEach(select => {
        new OptimizedSelect(select);
    });

    // Handle config selection form submission
    document.getElementById('configSelectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const configType = document.getElementById('configDropdown').value;
        if (!configType) return;

        // Show loading state if desired
        const submitButton = this.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';

        // Fetch config data
        fetch(`{% url 'generate_config:generate_config' %}?config_type=${encodeURIComponent(configType)}`, {
            headers: {
                'Accept': 'application/json'
            }
        })
        .then(response => response.json())
        .then(configData => {
            // Reset button state
            submitButton.disabled = false;
            submitButton.innerHTML = 'Show Configuration <i class="bi bi-arrow-right-circle ms-2"></i>';

            // Render the config form
            renderConfigForm(configData);
        })
        .catch(error => {
            console.error('Error:', error);
            submitButton.disabled = false;
            submitButton.innerHTML = 'Show Configuration <i class="bi bi-arrow-right-circle ms-2"></i>';
            alert('Error fetching configuration data');
        });
    });

    function renderConfigForm(configData) {
        const dynamicFieldsContainer = document.getElementById('dynamicFields');
        dynamicFieldsContainer.innerHTML = ''; // Clear existing fields
        
        Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
            if (fieldConfig.show) {
                dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
            }
        });

        // Show the form container
        document.getElementById('configFormContainer').style.display = 'block';
    }

    function renderInput(fieldName, fieldConfig) {
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'col-md-6 mb-3';

        // Create label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
        label.textContent = `${fieldConfig.ui_displayed_name} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
        inputWrapper.appendChild(label);

        // Create input or textarea based on value type
        let inputElement;
        if (Array.isArray(fieldConfig.default) || 
            (typeof fieldConfig.default === 'object' && fieldConfig.default !== null)) {
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = fieldConfig.default;
        }

        inputElement.id = fieldName;
        inputElement.name = fieldName;
        inputElement.className = 'form-control';
        inputElement.placeholder = JSON.stringify(fieldConfig.default);
        
        if (fieldConfig.required !== false) {
            inputElement.required = true;
        }

        inputWrapper.appendChild(inputElement);

        // Add example text
        const exampleText = document.createElement('small');
        exampleText.className = 'form-text text-muted';
        let defaultValue = fieldConfig.default;
        if (Array.isArray(defaultValue) && defaultValue.length > 3) {
            defaultValue = defaultValue.slice(0, 3);
        } else if (typeof defaultValue === 'object' && defaultValue !== null) {
            const keys = Object.keys(defaultValue);
            if (keys.length > 3) {
                defaultValue = keys.slice(0, 3).reduce((obj, key) => {
                    obj[key] = defaultValue[key];
                    return obj;
                }, {});
            }
        }
        exampleText.textContent = `Example: ${JSON.stringify(defaultValue)}`;
        inputWrapper.appendChild(exampleText);

        return inputWrapper;
    }

    // Handle config generation form submission
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    const value = element.value.trim();
                    if (value.startsWith('[') || value.startsWith('{')) {
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        parsedData[element.name] = Number(value);
                    } else {
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        fetch('{% url "generate_config:generate_config" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Config generated successfully!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating configuration');
        });
    });
});
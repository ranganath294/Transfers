<!-- Edit Device Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDeviceModalLabel">Edit Device</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="edit-device-form" class="row g-3">
          <input type="hidden" id="edit-device-id">
          
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="edit-device-type">Device Type</label>
              <select name="device_type" class="form-select optimized-select" id="edit-device-type">
                <option value="Headset">Headset</option>
                <option value="Speaker">Speaker</option>
                <option value="Earbud">Earbud</option>
                <option value="Earbud - LEA">Earbud - LEA</option>
                <option value="HID Mouse">HID Mouse</option>
                <option value="HID Keyboard">HID Keyboard</option>
                <option value="HID Gamepad">HID Gamepad</option>
                <option value="HOGP Mouse">HOGP Mouse</option>
                <option value="HOGP Keyboard">HOGP Keyboard</option>
                <option value="HOGP Gamepad">HOGP Gamepad</option>
                <option value="Carkit">Carkit</option>
                <option value="Smart Watch">Smart Watch</option>
                <option value="Fitness band">Fitness band</option>
                <option value="Heart rate monitor">Heart rate monitor</option>
                <option value="LE tracker">LE tracker</option>
                <option value="Phone">Phone</option>
                <option value="Smart ring">Smart ring</option>
                <option value="Health device">Health device</option>
                <option value="Smart bulb">Smart bulb</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="edit-model-number">Model Number</label>
              <select name="model_number" class="form-select optimized-select" id="edit-model-number">
                <option value="">Select Model Number</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="edit-chipset-manufacturer">Chipset Manufacturer</label>
              <select name="chipset_manufacturer" class="form-select optimized-select" id="edit-chipset-manufacturer">
                <option value="">Select Manufacturer</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Procured Date</label>
              <input type="date" name="procured_date" class="form-control" id="edit-procured-date">
            </div>

            <div class="mb-3">
              <label class="form-label">Availability</label>
              <select name="availability" class="form-select" id="edit-availability">
                <option value="Available">Available</option>
                <option value="In Use">In Use</option>
              </select>
            </div>
          </div>

          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="edit-manufacturer">Manufacturer</label>
              <select name="manufacturer" class="form-select optimized-select" id="edit-manufacturer">
                <option value="">Select Manufacturer</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Model Year</label>
              <input type="number" name="model_year" class="form-control" id="edit-model-year">
            </div>

            <div class="mb-3">
              <label class="form-label">Device Status</label>
              <select name="device_status" class="form-select" id="edit-device-status">
                <option value="Active">Active</option>
                <option value="Missing">Missing</option>
                <option value="Retired">Retired</option>
                <option value="Damaged">Damaged</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Geo Location</label>
              <select name="geo_location" class="form-select" id="edit-geo-location">
                <option value="SD">SD</option>
                <option value="SDC">SDC</option>
                <option value="QIPL">QIPL</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="edit-current-user">Current User</label>
              <select name="current_user" class="form-select optimized-select" id="edit-current-user">
                <option value="">Select User</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveDeviceChanges">Save changes</button>
      </div>
    </div>
  </div>
</div>














// Initialize the edit modal functionality
document.addEventListener('DOMContentLoaded', function() {
    // Store select instances
    const selectInstances = {};
    
    // Function to initialize all optimized selects in the modal
    function initializeModalSelects() {
        const selectElements = document.querySelectorAll('#editDeviceModal .optimized-select');
        selectElements.forEach(select => {
            if (!selectInstances[select.id]) {
                selectInstances[select.id] = new OptimizedSelect(select);
            }
        });
    }

    // Function to populate the modal with device data
    function populateEditModal(deviceData) {
        document.getElementById('edit-device-id').value = deviceData.id;
        
        // Populate regular inputs
        document.getElementById('edit-procured-date').value = deviceData.procured_date || '';
        document.getElementById('edit-model-year').value = deviceData.model_year || '';
        
        // Populate regular selects
        document.getElementById('edit-availability').value = deviceData.availability || 'Available';
        document.getElementById('edit-device-status').value = deviceData.device_status || 'Active';
        document.getElementById('edit-geo-location').value = deviceData.geo_location || 'SD';
        
        // Populate optimized selects
        const selectMappings = {
            'edit-device-type': deviceData.device_type,
            'edit-model-number': deviceData.model_number,
            'edit-chipset-manufacturer': deviceData.chipset_manufacturer,
            'edit-manufacturer': deviceData.manufacturer,
            'edit-current-user': deviceData.current_user__username
        };

        for (const [selectId, value] of Object.entries(selectMappings)) {
            const select = document.getElementById(selectId);
            if (select && selectInstances[selectId]) {
                selectInstances[selectId].selectOption({
                    value: value || '',
                    label: value || 'Select...'
                });
            }
        }
    }

    // Add click handler to all edit icons
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('fa-edit')) {
            const rowId = e.target.closest('tr').getAttribute('data-id');
            const rowData = getRowData(rowId);
            
            // Initialize selects if not already initialized
            initializeModalSelects();
            
            // Populate modal with data
            populateEditModal(rowData);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
            modal.show();
        }
    });

    // Function to get row data
    function getRowData(rowId) {
        const row = document.querySelector(`tr[data-id="${rowId}"]`);
        const cells = row.getElementsByTagName('td');
        const columnNames = Array.from(document.querySelectorAll('#results-header-row th'))
            .map(th => th.textContent.toLowerCase().replace(/\s+/g, '_'));
        
        const deviceData = { id: rowId };
        columnNames.forEach((colName, index) => {
            deviceData[colName] = cells[index].textContent.trim();
        });
        
        return deviceData;
    }

    // Handle save changes
    document.getElementById('saveDeviceChanges').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('edit-device-form'));
        const deviceId = document.getElementById('edit-device-id').value;
        
        const data = {
            id: deviceId,
            device_type: formData.get('device_type'),
            model_number: formData.get('model_number'),
            chipset_manufacturer: formData.get('chipset_manufacturer'),
            manufacturer: formData.get('manufacturer'),
            model_year: formData.get('model_year'),
            procured_date: formData.get('procured_date'),
            availability: formData.get('availability'),
            device_status: formData.get('device_status'),
            geo_location: formData.get('geo_location'),
            current_user: formData.get('current_user')
        };

        // Send update request
        fetch("{% url 'iot_catalogue:update_device' %}", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the row in the table
                updateTableRow(deviceId, data.device);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
                modal.hide();
            } else {
                alert('Error updating device: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating device');
        });
    });

    // Function to update table row
    function updateTableRow(deviceId, deviceData) {
        const row = document.querySelector(`tr[data-id="${deviceId}"]`);
        const cells = row.getElementsByTagName('td');
        const columnNames = Array.from(document.querySelectorAll('#results-header-row th'))
            .map(th => th.textContent.toLowerCase().replace(/\s+/g, '_'));
        
        columnNames.forEach((colName, index) => {
            if (colName === 'current_user__username') {
                const userText = cells[index].querySelector('.current-user-text');
                userText.textContent = deviceData[colName] || '';
            } else {
                cells[index].textContent = deviceData[colName] || '';
            }
        });
    }
});

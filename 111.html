{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Configuration Selection Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Select Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="configSelectionForm">
                        <div class="mb-3">
                            <label for="configDropdown" class="form-label">Choose Configuration</label>
                            <select class="form-select" id="configDropdown" name="config_type" required>
                                <option value="">Select Configuration Type</option>
                                {% for config in available_configs %}
                                <option value="{{ config.id }}">{{ config.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                Show Configuration
                                <i class="bi bi-arrow-right-circle ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dynamic Configuration Fields Card -->
            <div id="dynamicConfigSection" class="card shadow-sm" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Configuration Details</h5>
                </div>
                <div class="card-body">
                    <form id="configGenerationForm" method="POST">
                        {% csrf_token %}
                        <input type="hidden" id="selectedConfigType" name="config_type">
                        
                        <div id="dynamicFields" class="row g-3">
                            <!-- Dynamic fields will be inserted here by JavaScript -->
                        </div>
                        
                        <div class="d-grid mt-3">
                            <button type="submit" class="btn btn-success">
                                Save Configuration
                                <i class="bi bi-save ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const configSelectionForm = document.getElementById('configSelectionForm');
    const dynamicConfigSection = document.getElementById('dynamicConfigSection');
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    const selectedConfigTypeInput = document.getElementById('selectedConfigType');

    // Configuration Selection Form Submit
    configSelectionForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const selectedConfigType = document.getElementById('configDropdown').value;
        
        // Fetch dynamic fields for the selected configuration
        fetch(`/get-config-fields/${selectedConfigType}/`)
            .then(response => response.json())
            .then(configData => {
                // Clear previous dynamic fields
                dynamicFieldsContainer.innerHTML = '';
                
                // Render new dynamic fields
                Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
                    if (fieldConfig.show) {
                        dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
                    }
                });

                // Show configuration section
                dynamicConfigSection.style.display = 'block';
                selectedConfigTypeInput.value = selectedConfigType;
            })
            .catch(error => {
                console.error('Error fetching config fields:', error);
                alert('Unable to load configuration fields');
            });
    });

    // Dynamic Input Rendering Function
    function renderInput(fieldName, fieldConfig) {
        const formGroup = document.createElement('div');
        formGroup.className = 'col-12 col-md-6';

        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = 'form-label';
        label.textContent = fieldConfig.label || fieldName;

        const input = document.createElement('input');
        input.id = fieldName;
        input.name = fieldName;
        input.className = 'form-control';
        
        // Set input type and attributes based on field config
        switch(fieldConfig.type) {
            case 'boolean':
                input.type = 'checkbox';
                input.className = 'form-check-input';
                formGroup.classList.add('form-check');
                break;
            case 'number':
                input.type = 'number';
                break;
            case 'select':
                const select = document.createElement('select');
                select.id = fieldName;
                select.name = fieldName;
                select.className = 'form-select';
                
                fieldConfig.options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.label;
                    select.appendChild(optionEl);
                });

                formGroup.appendChild(label);
                formGroup.appendChild(select);
                return formGroup;
            default:
                input.type = 'text';
        }

        // Set placeholder and default value if provided
        if (fieldConfig.placeholder) input.placeholder = fieldConfig.placeholder;
        if (fieldConfig.default !== undefined) input.value = fieldConfig.default;

        formGroup.appendChild(label);
        formGroup.appendChild(input);

        return formGroup;
    }

    // Configuration Submission Handler
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    const value = element.type === 'checkbox' ? element.checked : 
                                  element.value.trim();

                    if (value === '') continue;

                    if (value.startsWith('[') || value.startsWith('{')) {
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        parsedData[element.name] = Number(value);
                    } else {
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        // Submit via AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Configuration generated successfully!'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to generate configuration'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Unable to submit configuration'
            });
        });
    });
});
</script>

<!-- Add these in your base template or include separately -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
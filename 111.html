@method_decorator(csrf_protect, name='dispatch')
class UpdateDeviceView(View):
    def patch(self, request, *args, **kwargs):
        data = json.loads(request.body)
        device_id = data.get('id')
        
        try:
            device = Device.objects.get(id=device_id)
            
            # Update fields
            device.device_type = data.get('device_type', device.device_type)
            device.model_number = data.get('model_number', device.model_number)
            device.chipset_manufacturer = data.get('chipset_manufacturer', device.chipset_manufacturer)
            device.manufacturer = data.get('manufacturer', device.manufacturer)
            device.procured_date = data.get('procured_date', device.procured_date)
            device.model_year = data.get('model_year', device.model_year)
            device.availability = data.get('availability', device.availability)
            device.device_status = data.get('device_status', device.device_status)
            device.geo_location = data.get('geo_location', device.geo_location)
            
            # Handle user assignment
            user = data.get('current_user')
            if user:
                user_obj = User.objects.get(username=user)
                device.current_user = user_obj
                device.assigned_date = timezone.now()
            else:
                device.current_user = None
                device.assigned_date = None
            
            device.save()
            
            return JsonResponse({
                'status': 'success',
                'message': 'Device updated successfully'
            })
        
        except Device.DoesNotExist:
            return JsonResponse({
                'status': 'error',
                'message': 'Device not found'
            }, status=404)
        except User.DoesNotExist:
            return JsonResponse({
                'status': 'error',
                'message': 'User not found'
            }, status=404)
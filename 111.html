// Helper function to get data type rules
function getDataTypeRules(datatype) {
    const rules = {
        'str': 'Enter text without quotes, or use "" for empty string',
        'list': 'Enter comma-separated values without quotes/brackets, or use "" for empty list',
        'dict': 'Enter a valid JSON object, use {} for empty object',
        'bool': 'Enter true or false',
        'int': 'Enter a whole number, or use "" for null',
        'float': 'Enter a decimal number, or use "" for null'
    };
    return `Rules: ${rules[datatype] || 'Enter a valid value'}`;
}

// Improved validation function
function validateInput(input) {
    if (!input || !input.value) return false;
    
    const value = input.value.trim();
    const datatype = input.dataset.datatype;
    
    // Handle empty value case
    if (value === '""') return true;
    if (!value) return false;

    try {
        switch (datatype) {
            case 'str':
                return !(value.includes('"') || value.includes("'"));
                
            case 'list':
                if (value === '') return true;
                // Allow simple comma-separated values
                return !(/["'\[\]]/.test(value));
                
            case 'dict':
                if (value === '{}') return true;
                JSON.parse(value);
                return true;
                
            case 'bool':
                return ['true', 'false'].includes(value.toLowerCase());
                
            case 'int':
                return Number.isInteger(Number(value));
                
            case 'float':
                return !isNaN(Number(value));
                
            default:
                return true;
        }
    } catch (error) {
        return false;
    }
}

// Improved parse function
function parseValue(value, datatype) {
    if (!value) return null;
    
    const trimmedValue = value.trim();
    
    // Handle explicitly empty values
    if (trimmedValue === '""') {
        switch (datatype) {
            case 'str': return '';
            case 'list': return [];
            case 'dict': return {};
            case 'int': return null;
            case 'float': return null;
            default: return '';
        }
    }

    try {
        switch (datatype) {
            case 'str':
                return trimmedValue;
                
            case 'list':
                if (trimmedValue === '') return [];
                return trimmedValue.split(',').map(item => item.trim());
                
            case 'dict':
                if (trimmedValue === '{}') return {};
                return JSON.parse(trimmedValue);
                
            case 'bool':
                return trimmedValue.toLowerCase() === 'true';
                
            case 'int':
                return parseInt(trimmedValue, 10);
                
            case 'float':
                return parseFloat(trimmedValue);
                
            default:
                return trimmedValue;
        }
    } catch (error) {
        console.error(`Error parsing ${datatype}:`, error);
        return trimmedValue;
    }
}

// Main form submission handler
function handleFormSubmission(form) {
    const parsedData = {};
    let isValid = true;
    let firstInvalidInput = null;

    // Add the selected configuration
    const selectedConfig = document.getElementById('configDropdown')?.value;
    if (selectedConfig) {
        parsedData['config_name'] = selectedConfig;
    }

    // Validate and collect form data
    for (let element of form.elements) {
        if (element.name && element.name !== 'csrfmiddlewaretoken') {
            // Validate
            if (!validateInput(element)) {
                isValid = false;
                if (!firstInvalidInput) {
                    firstInvalidInput = element;
                }
                
                // Add validation feedback
                const validationMessage = document.getElementById(`${element.name}-validation`) 
                    || document.createElement('div');
                validationMessage.className = 'invalid-feedback';
                validationMessage.id = `${element.name}-validation`;
                validationMessage.textContent = getDataTypeRules(element.dataset.datatype);
                validationMessage.style.display = 'block';
                
                element.classList.add('is-invalid');
                element.classList.remove('is-valid');
                
                if (!document.getElementById(`${element.name}-validation`)) {
                    element.parentNode.insertBefore(validationMessage, element.nextSibling);
                }
            } else {
                element.classList.remove('is-invalid');
                element.classList.add('is-valid');
                const validationMessage = document.getElementById(`${element.name}-validation`);
                if (validationMessage) {
                    validationMessage.style.display = 'none';
                }
            }
        }
    }

    if (!isValid) {
        firstInvalidInput?.focus();
        return null;
    }

    // Parse valid form data
    for (let element of form.elements) {
        if (element.name && element.name !== 'csrfmiddlewaretoken') {
            parsedData[element.name] = parseValue(element.value, element.dataset.datatype);
        }
    }

    return parsedData;
}
{% extends "generate_config/base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid px-4 mt-5">
    <h2 class="mb-4">Generate Configuration</h2>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Select Configuration</h5>
        </div>
        <div class="card-body">
            <form id="configSelectionForm" method="GET" action="{% url 'generate_config:generate_config' %}">
                <div class="mb-4">
                    <label for="configDropdown" class="form-label">Choose Existing Configuration</label>
                    <select class="form-select optimized-select" id="configDropdown" name="config_type">
                        <option value="">Select Configuration Type</option>
                        {% for config in configs_list %}
                        <option value="{{ config.name }}">{{ config.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="row g-2">
                    <div class="col-12 col-md-4 mb-2">
                        <button type="submit" id="showConfigBtn" class="btn btn-primary w-100">
                            <i class="bi bi-arrow-right-circle me-2"></i>
                            Load existing config
                        </button>
                    </div>
                    <div class="col-12 col-md-4 mb-2">
                        <button type="button" id="newConfigBtn" class="btn btn-primary w-100">
                            <i class="bi bi-plus-circle me-2"></i>
                            Create new config
                        </button>
                    </div>
                    <div class="col-12 col-md-4 mb-2">
                        <button type="button" id="newFromExistingBtn" class="btn btn-primary w-100">
                            <i class="bi bi-files me-2"></i>
                            New from existing
                        </button>
                    </div>
                </div>
            </form>

            <!-- Add loading spinner -->
            <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-primary">Loading configuration...</p>
            </div>
        </div>
    </div>

    <!-- Rest of the existing HTML code remains the same -->
    <!-- ... -->

</div>

<!-- Add this to your existing script section -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // ... (keep existing DOMContentLoaded code)

        // Add handler for the new "New from existing" button
        document.getElementById('newFromExistingBtn').addEventListener('click', function(e) {
            const configDropdown = document.getElementById('configDropdown');
            const selectedConfig = configDropdown.value;

            if (!selectedConfig) {
                alert('Please select an existing configuration to use as reference.');
                return;
            }

            handleConfigSubmission(true, true);
        });

        // Modify the handleConfigSubmission function to handle the new parameter
        function handleConfigSubmission(isNewConfig, loadExisting = false) {
            const configDropdown = document.getElementById('configDropdown');
            let configType;
            
            if (isNewConfig && !loadExisting) {
                configType = 'default';
                // Reset the dropdown both visually and in value
                configDropdown.value = '';
                const customButton = document.querySelector('.optimized-select-button');
                if (customButton) {
                    customButton.textContent = 'Select Configuration Type';
                }
            } else {
                configType = configDropdown.value;
            }

            // Validate dropdown for existing config scenario
            if (!isNewConfig && configType === '') {
                alert('Please select a configuration type.');
                return;
            }

            // Build URL with parameters
            const params = new URLSearchParams({
                config_type: configType
            });
            
            if (loadExisting) {
                params.append('load_existing', 'true');
            }

            const url = `{% url 'generate_config:generate_config' %}?${params.toString()}`;

            // Show full-screen loading
            showFullScreenLoading("Loading Configuration...");

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        let alertMessage = 'An error occurred while fetching the configuration.\n';
                        if (data.error_msg) {
                            alertMessage += data.error_msg;
                        }
                        alert(alertMessage);
                        hideFullScreenLoading();
                    } else {
                        renderConfigurationForm(data);

                        // Show default config alert if it's a new config
                        const defaultConfigAlert = document.getElementById('defaultConfigAlert');
                        if (isNewConfig) {
                            defaultConfigAlert.style.display = 'block';
                            if (loadExisting) {
                                defaultConfigAlert.querySelector('strong').textContent = 'Configuration Loaded from Existing';
                                defaultConfigAlert.querySelector('p').textContent = 
                                    'Values have been loaded from the selected configuration. You can modify these values to create a new configuration.';
                            } else {
                                defaultConfigAlert.querySelector('strong').textContent = 'Default Configuration Loaded';
                                defaultConfigAlert.querySelector('p').textContent = 
                                    'These are default values. Please review and modify each field according to your requirements before generating the configuration.';
                            }
                            // Scroll to the alert
                            defaultConfigAlert.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        } else {
                            defaultConfigAlert.style.display = 'none';
                        }

                        hideFullScreenLoading();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideFullScreenLoading();
                });
        }

        // ... (keep rest of the existing code)
    });
</script>

{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-md-8 col-lg-6">
            <!-- Configuration Selection Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Select Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="configSelectionForm">
                        <div class="mb-3">
                            <label for="configDropdown" class="form-label">Choose Configuration</label>
                            <select class="form-select" id="configDropdown" name="config_type" required>
                                <option value="">Select Configuration Type</option>
                                {% for config in available_configs %}
                                <option value="{{ config.id }}">{{ config.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                Show Configuration
                                <i class="bi bi-arrow-right-circle ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Dynamic Configuration Generator Section -->
            <div id="configGeneratorSection" style="display: none;">
                <div class="container-fluid px-4">
                    <h2 class="mb-4">Generate Configuration</h2>
                    <form id="configGenerationForm" method="POST" action="{% url 'generate_config:generate_config' %}">
                        {% csrf_token %}
                        <div id="dynamicFields" class="row g-3"></div>
                        <input type="hidden" id="parsedData" name="parsedData">
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">Generate Config</button>
                            <button type="reset" class="btn btn-secondary ms-2">Reset</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .required-label::after {
        content: " *";
        color: red;
    }
    .form-text.text-muted {
        color: #6c757d !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        width: 100%;
        display: block;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
        
        #dynamicFields .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .btn {
            margin-bottom: 10px;
            width: 100%;
        }
        
        .btn:not(:first-child) {
            margin-left: 0 !important;
        }
        
        h2 {
            font-size: 1.5rem;
        }
        
        .form-control {
            font-size: 14px;
        }
        
        .form-text.text-muted {
            font-size: 12px;
        }
    }

    /* Ensure textarea and inputs are consistent */
    textarea.form-control, input.form-control {
        min-height: 38px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const configSelectionForm = document.getElementById('configSelectionForm');
    const configGeneratorSection = document.getElementById('configGeneratorSection');
    const dynamicFieldsContainer = document.getElementById('dynamicFields');

    // Configuration Selection Form Submit
    configSelectionForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const selectedConfigType = document.getElementById('configDropdown').value;
        
        // Fetch dynamic fields for the selected configuration
        fetch(`/get-config-fields/${selectedConfigType}/`)
            .then(response => response.json())
            .then(configData => {
                // Clear previous dynamic fields
                dynamicFieldsContainer.innerHTML = '';
                
                // Render new fields using the renderInput function
                Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
                    if (fieldConfig.show) {
                        dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
                    }
                });

                // Show configuration generator section
                configGeneratorSection.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching config fields:', error);
                alert('Unable to load configuration fields');
            });
    });

    // Function to render input based on data type
    function renderInput(fieldName, fieldConfig) {
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'col-md-6 mb-3';

        // Create label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
        label.textContent = `${fieldConfig.ui_displayed_name} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
        inputWrapper.appendChild(label);

        // Create input or textarea based on value type
        let inputElement;
        if (Array.isArray(fieldConfig.default) || 
            (typeof fieldConfig.default === 'object' && fieldConfig.default !== null)) {
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else {
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = fieldConfig.default;
        }

        inputElement.id = fieldName;
        inputElement.name = fieldName;
        inputElement.className = 'form-control';
        inputElement.placeholder = JSON.stringify(fieldConfig.default);
        
        if (fieldConfig.required !== false) {
            inputElement.required = true;
        }

        inputWrapper.appendChild(inputElement);

        // Example text
        const exampleText = document.createElement('small');
        exampleText.className = 'form-text text-muted';
        let defaultValue = fieldConfig.default;

        if (Array.isArray(defaultValue) && defaultValue.length > 3) {
            defaultValue = defaultValue.slice(0, 3);
        } else if (typeof defaultValue === 'object' && defaultValue !== null) {
            const keys = Object.keys(defaultValue);
            if (keys.length > 3) {
                defaultValue = keys.slice(0, 3).reduce((obj, key) => {
                    obj[key] = defaultValue[key];
                    return obj;
                }, {});
            }
        }

        exampleText.textContent = `Example: ${JSON.stringify(defaultValue)}`;
        inputWrapper.appendChild(exampleText);

        return inputWrapper;
    }

    // Form submission handler
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    const value = element.value.trim();
                    
                    if (value.startsWith('[') || value.startsWith('{')) {
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        parsedData[element.name] = Number(value);
                    } else {
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        // Submit via AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: 'Success!',
                    text: 'Configuration generated successfully!'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Failed to generate configuration'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Network Error',
                text: 'Unable to submit configuration'
            });
        });
    });
});
</script>

<!-- Add these in your base template or include separately -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}
document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
    event.preventDefault();

    const parsedData = {};
    const selectedConfig = document.getElementById('configDropdown').value;
    parsedData['config_name'] = selectedConfig;

    // Select all dynamically generated inputs and containers
    const dynamicFields = document.getElementById('dynamicFields');
    
    // Traverse through card wrappers
    const cards = dynamicFields.querySelectorAll('.card');
    
    cards.forEach(card => {
        // Get the card title (used as the field name)
        const cardTitle = card.querySelector('.card-header').textContent.trim();
        
        // Find the input elements within this card
        const inputs = card.querySelectorAll('input, select');
        
        // Special handling for different input types
        if (inputs.length > 0) {
            const typeSelector = card.querySelector('.form-select');
            const selectedType = typeSelector ? typeSelector.value : 'string';
            
            let value;
            
            switch(selectedType) {
                case 'array':
                    // Handle array inputs
                    value = handleArrayInput(card);
                    break;
                case 'object':
                    // Handle object inputs
                    value = handleObjectInput(card);
                    break;
                case 'boolean':
                    value = inputs[0].value === 'true';
                    break;
                case 'number':
                    value = Number(inputs[0].value);
                    break;
                default: // string
                    value = inputs[0].value.trim();
            }
            
            // Use card title as key, removing any "(required)" or "(optional)" text
            const cleanedKey = cardTitle.replace(/\s*\(.*\)$/, '').toLowerCase().replace(/\s+/g, '_');
            
            parsedData[cleanedKey] = value;
        }
    });

    console.log('Parsed Configuration Data:', parsedData);
    console.log('Parsed Data JSON:', JSON.stringify(parsedData, null, 2));

    // Uncomment when ready for submission
    /*
    fetch(this.action, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(parsedData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Configuration generated successfully!');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
    */
});

// Helper function to handle array inputs
function handleArrayInput(card) {
    const arrayContainer = card.querySelector('.nested-array-container');
    if (!arrayContainer) return [];

    const arrayItems = arrayContainer.querySelectorAll('.nested-array-item');
    return Array.from(arrayItems).map(item => {
        const input = item.querySelector('input, select');
        return input ? parseValue(input.value) : null;
    }).filter(item => item !== null);
}

// Helper function to handle object inputs
function handleObjectInput(card) {
    const objectContainer = card.querySelector('.nested-object-container');
    if (!objectContainer) return {};

    const objectItems = objectContainer.querySelectorAll('.nested-object-item');
    const result = {};

    objectItems.forEach(item => {
        const keyInput = item.querySelector('input[placeholder="Key"]');
        const valueInput = item.querySelector('input:not([placeholder="Key"]), select');

        if (keyInput && valueInput) {
            const key = keyInput.value.trim();
            const value = parseValue(valueInput.value);
            if (key) result[key] = value;
        }
    });

    return result;
}

// Value parsing helper
function parseValue(value) {
    // Trim the value
    value = value.trim();

    // Parse boolean
    if (value.toLowerCase() === 'true') return true;
    if (value.toLowerCase() === 'false') return false;

    // Parse number
    if (!isNaN(value) && value !== '') {
        return Number(value);
    }

    // Try JSON parsing
    try {
        if ((value.startsWith('[') && value.endsWith(']')) || 
            (value.startsWith('{') && value.endsWith('}'))) {
            return JSON.parse(value);
        }
    } catch {}

    // Return as string
    return value;
}
{% extends 'iot_catalogue/base.html' %}
{% load static %}

{% block content_div %}
<form method="post" action="{% url 'iot_catalogue:search' %}" class="row g-3">
    {% csrf_token %}
    <div class="col-md-6">
        <div class="mb-3">
            <label class="form-label" for="device-type-select">Device Type</label>
            <select name="device_type" class="form-select optimized-select" id="device-type-select">
                <option value="default" selected>-- All --</option>
                <option value="Headset">Headset</option>
                <option value="Speaker">Speaker</option>
                <!-- ... rest of the device types ... -->
            </select>
        </div>

        <!-- ... rest of the left column form fields ... -->
    </div>

    <div class="col-md-6">
        <!-- ... right column form fields ... -->
    </div>
    
    <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>Search
        </button>
        <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-2"></i>Reset
        </button>
    </div>
</form>

<!-- Edit Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDeviceModalLabel">Edit Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-device-form" class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" for="edit-device-type">Device Type</label>
                            <select name="device_type" class="form-select optimized-select" id="edit-device-type">
                                <option value="Headset">Headset</option>
                                <option value="Speaker">Speaker</option>
                                <!-- ... rest of device types ... -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-model-number">Model Number</label>
                            <select name="model_number" class="form-select optimized-select" id="edit-model-number">
                                {% for model_number in model_numbers %}
                                <option value="{{ model_number }}">{{ model_number }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-manufacturer">Manufacturer</label>
                            <select name="manufacturer" class="form-select optimized-select" id="edit-manufacturer">
                                {% for manufacturer in manufacturers %}
                                <option value="{{ manufacturer }}">{{ manufacturer }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-chipset-manufacturer">Chipset Manufacturer</label>
                            <select name="chipset_manufacturer" class="form-select optimized-select" id="edit-chipset-manufacturer">
                                {% for chipset_manufacturer in chipset_manufacturers %}
                                <option value="{{ chipset_manufacturer }}">{{ chipset_manufacturer }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label" for="edit-model-year">Model Year</label>
                            <input type="number" name="model_year" class="form-control" id="edit-model-year">
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-device-status">Device Status</label>
                            <select name="device_status" class="form-select" id="edit-device-status">
                                <option value="Active">Active</option>
                                <option value="Missing">Missing</option>
                                <option value="Retired">Retired</option>
                                <option value="Damaged">Damaged</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-geo-location">Geo Location</label>
                            <select name="geo_location" class="form-select" id="edit-geo-location">
                                <option value="SD">SD</option>
                                <option value="SDC">SDC</option>
                                <option value="QIPL">QIPL</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label" for="edit-current-user">Current User</label>
                            <select name="current_user" class="form-select optimized-select" id="edit-current-user">
                                <option value="">None</option>
                                {% for username in usernames %}
                                    <option value="{{ username }}">{{ username }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveDeviceChanges">Save changes</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block results_div %}
{% if devices %}
<div class="card-body">
    <div class="table-shadow">
        <div class="table-container">
            <table class="table table-hover table-sticky mb-0">
                <thead>
                    <tr class="bg-light">
                        {% for col_name in column_names %}
                            <th class="fw-semibold">{{ col_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="results-table-body">
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script id="devices-data" type="application/json">
    {{ devices|safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const devicesData = JSON.parse(document.getElementById('devices-data').textContent);
    const tableBody = document.getElementById('results-table-body');
    
    devicesData.forEach(device => {
        const row = document.createElement('tr');
        row.setAttribute('data-id', device.id);
        
        for (const key in device) {
            const cell = document.createElement('td');
            
            if (key === "current_user__username") {
                const container = document.createElement('div');
                container.className = 'current-user-cell';
                
                const userText = document.createElement('span');
                userText.textContent = device[key] || '';
                container.appendChild(userText);
                
                const editIcon = document.createElement('i');
                editIcon.className = 'fas fa-edit ms-2';
                editIcon.setAttribute('title', 'Edit Device');
                
                editIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditModal(device);
                });
                
                container.appendChild(editIcon);
                cell.appendChild(container);
            } else {
                cell.textContent = device[key];
            }
            
            row.appendChild(cell);
        }
        tableBody.appendChild(row);
    });

    function openEditModal(device) {
        // Populate the edit form with device data
        document.getElementById('edit-device-type').value = device.device_type;
        document.getElementById('edit-model-number').value = device.model_number;
        document.getElementById('edit-manufacturer').value = device.manufacturer;
        document.getElementById('edit-chipset-manufacturer').value = device.chipset_manufacturer;
        document.getElementById('edit-model-year').value = device.model_year;
        document.getElementById('edit-device-status').value = device.device_status;
        document.getElementById('edit-geo-location').value = device.geo_location;
        document.getElementById('edit-current-user').value = device.current_user__username || '';

        // Store the device ID for the save operation
        document.getElementById('edit-device-form').setAttribute('data-device-id', device.id);

        // Initialize or refresh optimized selects in the modal
        document.querySelectorAll('#editDeviceModal .optimized-select').forEach(select => {
            if (!select.optimizedSelect) {
                new OptimizedSelect(select);
            }
        });

        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
        modal.show();
    }

    // Handle save changes
    document.getElementById('saveDeviceChanges').addEventListener('click', function() {
        const form = document.getElementById('edit-device-form');
        const deviceId = form.getAttribute('data-device-id');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        fetch(`/api/devices/${deviceId}/`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(updatedDevice => {
            // Update the table row with new data
            updateTableRow(deviceId, updatedDevice);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
            modal.hide();
        })
        .catch(error => console.error('Error:', error));
    });

    function updateTableRow(deviceId, updatedDevice) {
        const row = document.querySelector(`tr[data-id="${deviceId}"]`);
        if (row) {
            // Update each cell with the new data
            Array.from(row.children).forEach((cell, index) => {
                const key = Object.keys(updatedDevice)[index];
                if (key === "current_user__username") {
                    const userText = cell.querySelector('span');
                    userText.textContent = updatedDevice[key] || '';
                } else {
                    cell.textContent = updatedDevice[key];
                }
            });
        }
    }
});
</script>
{% endif %}
{% endblock %}
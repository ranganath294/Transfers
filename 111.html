import requests

class SharePointClient:
    def __init__(self, client_id, client_secret, tenant_id, site_url):
        self.client_id = client_id
        self.client_secret = client_secret
        self.tenant_id = tenant_id
        self.site_url = site_url
        self.token = None

    def authenticate(self):
        url = f"https://login.microsoftonline.com/{self.tenant_id}/oauth2/v2.0/token"
        data = {
            'grant_type': 'client_credentials',
            'client_id': self.client_id,
            'client_secret': self.client_secret,
            'scope': 'https://graph.microsoft.com/.default',
        }
        response = requests.post(url, data=data)
        response.raise_for_status()
        self.token = response.json().get('access_token')

    def get_headers(self):
        if not self.token:
            self.authenticate()
        return {
            'Authorization': f'Bearer {self.token}',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }

    def list_files(self, folder_path):
        url = f"{self.site_url}/_api/web/GetFolderByServerRelativeUrl('{folder_path}')/Files"
        headers = self.get_headers()
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.json()

    def read_file(self, file_path):
        url = f"{self.site_url}/_api/web/GetFileByServerRelativeUrl('{file_path}')/$value"
        headers = self.get_headers()
        response = requests.get(url, headers=headers)
        response.raise_for_status()
        return response.content

    def write_file(self, file_path, content):
        url = f"{self.site_url}/_api/web/GetFolderByServerRelativeUrl('{file_path}')/Files/add(overwrite=true, url='{file_path}')"
        headers = self.get_headers()
        response = requests.post(url, headers=headers, data=content)
        response.raise_for_status()
        return response.json()

    def download_file(self, file_path, local_path):
        file_content = self.read_file(file_path)
        with open(local_path, 'wb') as file:
            file.write(file_content)

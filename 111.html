{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid px-4 mt-5">
    <h2 class="mb-4">Configuration Generator</h2>
    
    <!-- Config Selection Section -->
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Select Configuration</h5>
                    
                    <!-- Dropdown Rendered by Django -->
                    <div class="mb-3">
                        <label class="form-label" for="config-select">Available Configurations</label>
                        <select name="config" class="form-select" id="config-select">
                            <option value="" selected>Select Configuration</option>
                            {% for config in configs_list %}
                            <option value="{{ config.name }}">{{ config.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <button id="show-config-btn" class="btn btn-primary">
                        Show Configuration
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Config Generation Form -->
    <div id="config-form-container" class="mt-4" style="display:none;">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Configuration Details</h5>
                <form id="configGenerationForm" method="POST">
                    {% csrf_token %}
                    <div id="dynamicFields" class="row g-3"></div>
                    <input type="hidden" id="parsedData" name="parsedData">
                    <div class="mt-4 d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-success">Generate Config</button>
                            <button type="reset" class="btn btn-secondary ms-2">Reset</button>
                        </div>
                        <button id="back-to-select" type="button" class="btn btn-outline-secondary">
                            Back to Selection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const configSelect = document.getElementById('config-select');
    const showConfigBtn = document.getElementById('show-config-btn');
    const configFormContainer = document.getElementById('config-form-container');
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    const backToSelectBtn = document.getElementById('back-to-select');

    // Function to render input based on data type
    function renderInput(fieldName, fieldConfig) {
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'col-md-6 mb-3';

        // Create label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
        label.textContent = `${fieldConfig.ui_displayed_name} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
        inputWrapper.appendChild(label);

        // Create input or textarea based on value type
        let inputElement;
        if (Array.isArray(fieldConfig.default)) {
            // Array input (textarea for easier editing)
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else if (typeof fieldConfig.default === 'object' && fieldConfig.default !== null) {
            // Object input (textarea for JSON)
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else {
            // Standard text input
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = fieldConfig.default;
        }

        inputElement.id = fieldName;
        inputElement.name = fieldName;
        inputElement.className = 'form-control';
        inputElement.placeholder = JSON.stringify(fieldConfig.default);

        if (fieldConfig.required !== false) {
            inputElement.required = true;
        }

        inputWrapper.appendChild(inputElement);

        // Example text
        const exampleText = document.createElement('small');
        exampleText.className = 'form-text text-muted';

        let defaultValue = fieldConfig.default;

        if (Array.isArray(defaultValue) && defaultValue.length > 3) {
            defaultValue = defaultValue.slice(0, 3);
        } else if (typeof defaultValue === 'object' && defaultValue !== null) {
            const keys = Object.keys(defaultValue);
            if (keys.length > 3) {
                defaultValue = keys.slice(0, 3).reduce((obj, key) => {
                    obj[key] = defaultValue[key];
                    return obj;
                }, {});
            }
        }

        exampleText.textContent = `Example: ${JSON.stringify(defaultValue)}`;
        inputWrapper.appendChild(exampleText);

        return inputWrapper;
    }

    // Show Configuration Button Click
    showConfigBtn.addEventListener('click', function() {
        const selectedConfig = configSelect.value;
        if (!selectedConfig) {
            alert('Please select a configuration');
            return;
        }

        // Fetch configuration details via AJAX
        fetch(`{% url 'generate_config:get_config_details' %}?config=${selectedConfig}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(configData => {
                // Clear previous fields
                dynamicFieldsContainer.innerHTML = '';

                // Render dynamic fields
                Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
                    if (fieldConfig.show) {
                        dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
                    }
                });

                // Show config form, hide selection
                configFormContainer.style.display = 'block';
            })
            .catch(error => {
                console.error('Error fetching config details:', error);
                alert('Failed to load configuration details');
            });
    });

    // Back to Selection Button
    backToSelectBtn.addEventListener('click', function() {
        configFormContainer.style.display = 'none';
    });

    // Form submission handler
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    // Attempt to parse the input value
                    const value = element.value.trim();

                    if (value.startsWith('[') || value.startsWith('{')) {
                        // Parse JSON for arrays and objects
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        // Parse boolean
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        // Parse number
                        parsedData[element.name] = Number(value);
                    } else {
                        // Keep as string
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        // Submit via AJAX
        fetch('{% url 'generate_config:generate_config' %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === 'success') {
                alert('Config generated successfully!');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating the config');
        });
    });
});
</script>
{% endblock %}

<style>
.required-label::after {
    content: " *";
    color: red;
}

.form-text.text-muted {
    color: #6c757d !important;
    word-wrap: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    width: 100%;
    display: block;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 10px !important;
        padding-right: 10px !important;
    }

    #dynamicFields .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }

    .btn {
        margin-bottom: 10px;
        width: 100%;
    }

    .btn:not(:first-child) {
        margin-left: 0 !important;
    }

    h2 {
        font-size: 1.5rem;
    }

    .form-control {
        font-size: 14px;
    }

    .form-text.text-muted {
        font-size: 12px;
    }
}
</style>
{% endblock %}
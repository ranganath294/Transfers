<!-- Replace the existing modal HTML with this enhanced version -->
<div class="modal fade" id="userAssignmentModal" tabindex="-1" aria-labelledby="userAssignmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userAssignmentModalLabel">Edit Device Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="device-edit-form" class="row g-3">
          <!-- Left Column -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="modal-device-type">Device Type</label>
              <select name="device_type" class="form-select optimized-select" id="modal-device-type">
                <option value="default">-- All --</option>
                <option value="Headset">Headset</option>
                <option value="Speaker">Speaker</option>
                <option value="Earbud">Earbud</option>
                <option value="Earbud - LEA">Earbud - LEA</option>
                <option value="HID Mouse">HID Mouse</option>
                <option value="HID Keyboard">HID Keyboard</option>
                <option value="HID Gamepad">HID Gamepad</option>
                <option value="HOGP Mouse">HOGP Mouse</option>
                <option value="HOGP Keyboard">HOGP Keyboard</option>
                <option value="HOGP Gamepad">HOGP Gamepad</option>
                <option value="Carkit">Carkit</option>
                <option value="Smart Watch">Smart Watch</option>
                <option value="Fitness band">Fitness band</option>
                <option value="Heart rate monitor">Heart rate monitor</option>
                <option value="LE tracker">LE tracker</option>
                <option value="Phone">Phone</option>
                <option value="Smart ring">Smart ring</option>
                <option value="Health device">Health device</option>
                <option value="Smart bulb">Smart bulb</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="modal-model-number">Model Number</label>
              <select name="model_number" class="form-select optimized-select" id="modal-model-number">
                <option value="default">-- All --</option>
                {% for model_number in model_numbers %}
                <option value="{{ model_number }}">{{ model_number }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="modal-chipset-manufacturer">Chipset Manufacturer</label>
              <select name="chipset_manufacturer" class="form-select optimized-select" id="modal-chipset-manufacturer">
                <option value="default">-- All --</option>
                {% for chipset_manufacturer in chipset_manufacturers %}
                <option value="{{ chipset_manufacturer }}">{{ chipset_manufacturer }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Procured Date</label>
              <input type="date" name="procured_date" class="form-control" id="modal-procured-date">
            </div>

            <div class="mb-3">
              <label class="form-label">Availability</label>
              <select name="availability" class="form-select" id="modal-availability">
                <option value="default">-- All --</option>
                <option value="Available">Available</option>
                <option value="In Use">In Use</option>
              </select>
            </div>
          </div>

          <!-- Right Column -->
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label" for="modal-manufacturer">Manufacturer</label>
              <select name="manufacturer" class="form-select optimized-select" id="modal-manufacturer">
                <option value="default">-- All --</option>
                {% for manufacturer in manufacturers %}
                <option value="{{ manufacturer }}">{{ manufacturer }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Model Year</label>
              <input type="number" name="model_year" class="form-control" id="modal-model-year">
            </div>

            <div class="mb-3">
              <label class="form-label">Device Status</label>
              <select name="device_status" class="form-select" id="modal-device-status">
                <option value="default">-- All --</option>
                <option value="Active">Active</option>
                <option value="Missing">Missing</option>
                <option value="Retired">Retired</option>
                <option value="Damaged">Damaged</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Geo Location</label>
              <select name="geo_location" class="form-select" id="modal-geo-location">
                <option value="default">-- All --</option>
                <option value="SD">SD</option>
                <option value="SDC">SDC</option>
                <option value="QIPL">QIPL</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label" for="userSelect">Current User</label>
              <select class="form-select optimized-select" id="userSelect">
                <option value="">Choose...</option>
                {% for username in usernames %}
                <option value="{{ username }}">{{ username }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="userAssignmentModalSaveBtn">Save changes</button>
      </div>
    </div>
  </div>
</div>











// Add this to your existing JavaScript code
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all optimized selects in the modal
    const modalSelects = document.querySelectorAll('#userAssignmentModal .optimized-select');
    modalSelects.forEach(select => {
        new OptimizedSelect(select);
    });

    const userAssignmentModal = document.getElementById('userAssignmentModal');
    let currentDeviceId = null;

    // Function to populate modal with device data
    function populateModalWithDeviceData(deviceId) {
        const row = document.querySelector(`tr[data-id="${deviceId}"]`);
        if (!row) return;

        // Get all the cell values
        const deviceType = row.querySelector('td:nth-child(1)').textContent;
        const modelNumber = row.querySelector('td:nth-child(2)').textContent;
        const chipsetManufacturer = row.querySelector('td:nth-child(3)').textContent;
        const manufacturer = row.querySelector('td:nth-child(4)').textContent;
        const modelYear = row.querySelector('td:nth-child(5)').textContent;
        const procuredDate = row.querySelector('td:nth-child(6)').textContent;
        const availability = row.querySelector('td:nth-child(7)').textContent;
        const deviceStatus = row.querySelector('td:nth-child(8)').textContent;
        const geoLocation = row.querySelector('td:nth-child(9)').textContent;
        const currentUser = row.querySelector('td:nth-child(10)').textContent;

        // Set values in modal
        document.getElementById('modal-device-type').value = deviceType;
        document.getElementById('modal-model-number').value = modelNumber;
        document.getElementById('modal-chipset-manufacturer').value = chipsetManufacturer;
        document.getElementById('modal-manufacturer').value = manufacturer;
        document.getElementById('modal-model-year').value = modelYear;
        document.getElementById('modal-procured-date').value = procuredDate;
        document.getElementById('modal-availability').value = availability;
        document.getElementById('modal-device-status').value = deviceStatus;
        document.getElementById('modal-geo-location').value = geoLocation;
        document.getElementById('userSelect').value = currentUser;

        // Update the OptimizedSelect displays
        modalSelects.forEach(select => {
            if (select.optimizedSelect) {
                select.optimizedSelect.button.textContent = select.options[select.selectedIndex].text;
            }
        });
    }

    // Modified event listener for edit icon click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('current-user-edit-icon')) {
            const deviceId = e.target.closest('tr').getAttribute('data-id');
            currentDeviceId = deviceId;
            populateModalWithDeviceData(deviceId);
            const modal = new bootstrap.Modal(userAssignmentModal);
            modal.show();
        }
    });

    // Modified save button event listener
    document.getElementById('userAssignmentModalSaveBtn').addEventListener('click', function() {
        if (!currentDeviceId) return;

        const formData = {
            id: currentDeviceId,
            device_type: document.getElementById('modal-device-type').value,
            model_number: document.getElementById('modal-model-number').value,
            chipset_manufacturer: document.getElementById('modal-chipset-manufacturer').value,
            manufacturer: document.getElementById('modal-manufacturer').value,
            model_year: document.getElementById('modal-model-year').value,
            procured_date: document.getElementById('modal-procured-date').value,
            availability: document.getElementById('modal-availability').value,
            device_status: document.getElementById('modal-device-status').value,
            geo_location: document.getElementById('modal-geo-location').value,
            user: document.getElementById('userSelect').value
        };

        const csrftoken = getCookie('csrftoken');

        // Send PATCH request with all form data
        fetch("{% url 'iot_catalogue:assign_user' %}", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            // Update the row in the table with new values
            const row = document.querySelector(`tr[data-id="${currentDeviceId}"]`);
            if (row) {
                // Update all cells with new values
                const cells = row.querySelectorAll('td');
                cells[0].textContent = formData.device_type;
                cells[1].textContent = formData.model_number;
                cells[2].textContent = formData.chipset_manufacturer;
                cells[3].textContent = formData.manufacturer;
                cells[4].textContent = formData.model_year;
                cells[5].textContent = formData.procured_date;
                cells[6].textContent = formData.availability;
                cells[7].textContent = formData.device_status;
                cells[8].textContent = formData.geo_location;
                cells[9].querySelector('.current-user-text').textContent = formData.user;
            }

            // Hide the modal
            const modal = bootstrap.Modal.getInstance(userAssignmentModal);
            modal.hide();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });
});










document.addEventListener('DOMContentLoaded', function() {
    // Your existing initialization code for optimized selects
    document.querySelectorAll('.optimized-select').forEach(select => {
        new OptimizedSelect(select);
    });

    const devicesData = JSON.parse(document.getElementById('devices-data').textContent);
    const tableBody = document.getElementById('results-table-body');
    let currentRow = null;

    // Your existing code for creating table rows
    devicesData.forEach((device, rowIndex) => {
        // ... (keep your existing table row creation code)
    });

    // Initialize the optimized select when the modal is shown
    const userAssignmentModal = document.getElementById('userAssignmentModal');
    let currentDeviceId = null;

    // Function to populate modal with device data
    function populateModalWithDeviceData(deviceId) {
        const row = document.querySelector(`tr[data-id="${deviceId}"]`);
        if (!row) return;

        // Get all the cell values
        const deviceType = row.querySelector('td:nth-child(1)').textContent;
        const modelNumber = row.querySelector('td:nth-child(2)').textContent;
        const chipsetManufacturer = row.querySelector('td:nth-child(3)').textContent;
        const manufacturer = row.querySelector('td:nth-child(4)').textContent;
        const modelYear = row.querySelector('td:nth-child(5)').textContent;
        const procuredDate = row.querySelector('td:nth-child(6)').textContent;
        const availability = row.querySelector('td:nth-child(7)').textContent;
        const deviceStatus = row.querySelector('td:nth-child(8)').textContent;
        const geoLocation = row.querySelector('td:nth-child(9)').textContent;
        const currentUser = row.querySelector('td:nth-child(10) .current-user-text').textContent.trim();

        // Set values in modal
        document.getElementById('modal-device-type').value = deviceType;
        document.getElementById('modal-model-number').value = modelNumber;
        document.getElementById('modal-chipset-manufacturer').value = chipsetManufacturer;
        document.getElementById('modal-manufacturer').value = manufacturer;
        document.getElementById('modal-model-year').value = modelYear;
        document.getElementById('modal-procured-date').value = procuredDate;
        document.getElementById('modal-availability').value = availability;
        document.getElementById('modal-device-status').value = deviceStatus;
        document.getElementById('modal-geo-location').value = geoLocation;
        document.getElementById('userSelect').value = currentUser;

        // Update the OptimizedSelect displays
        document.querySelectorAll('#userAssignmentModal .optimized-select').forEach(select => {
            if (select.optimizedSelect) {
                select.optimizedSelect.button.textContent = select.options[select.selectedIndex].text;
            }
        });
    }

    // Modified event listener for edit icon click
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('current-user-edit-icon')) {
            const deviceId = e.target.closest('tr').getAttribute('data-id');
            currentDeviceId = deviceId;
            currentRow = e.target.closest('tr');
            populateModalWithDeviceData(deviceId);
            
            // Initialize all optimized selects in the modal if not already initialized
            document.querySelectorAll('#userAssignmentModal .optimized-select').forEach(select => {
                if (!select.optimizedSelect) {
                    new OptimizedSelect(select);
                }
            });

            const modal = new bootstrap.Modal(userAssignmentModal);
            modal.show();
        }
    });

    // Replace your existing save button event listener with this updated version
    document.getElementById('userAssignmentModalSaveBtn').addEventListener('click', function() {
        if (!currentDeviceId) return;

        const formData = {
            id: currentDeviceId,
            device_type: document.getElementById('modal-device-type').value,
            model_number: document.getElementById('modal-model-number').value,
            chipset_manufacturer: document.getElementById('modal-chipset-manufacturer').value,
            manufacturer: document.getElementById('modal-manufacturer').value,
            model_year: document.getElementById('modal-model-year').value,
            procured_date: document.getElementById('modal-procured-date').value,
            availability: document.getElementById('modal-availability').value,
            device_status: document.getElementById('modal-device-status').value,
            geo_location: document.getElementById('modal-geo-location').value,
            user: document.getElementById('userSelect').value
        };

        const csrftoken = getCookie('csrftoken');

        // Send PATCH request with all form data
        fetch("{% url 'iot_catalogue:assign_user' %}", {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            // Update the row in the table with new values
            if (currentRow) {
                const cells = currentRow.querySelectorAll('td');
                cells[0].textContent = formData.device_type;
                cells[1].textContent = formData.model_number;
                cells[2].textContent = formData.chipset_manufacturer;
                cells[3].textContent = formData.manufacturer;
                cells[4].textContent = formData.model_year;
                cells[5].textContent = formData.procured_date;
                cells[6].textContent = formData.availability;
                cells[7].textContent = formData.device_status;
                cells[8].textContent = formData.geo_location;
                cells[9].querySelector('.current-user-text').textContent = formData.user;
            }

            // Hide the modal
            const modal = bootstrap.Modal.getInstance(userAssignmentModal);
            modal.hide();
        })
        .catch((error) => {
            console.error('Error:', error);
        });
    });

    // Keep your existing getCookie function
    function getCookie(name) {
        // ... (your existing getCookie function)
    }
});
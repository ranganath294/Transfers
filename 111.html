{% extends "generate_config/base.html" %}
{% load static %}

{% block content %}

<div class="container-fluid px-4 mt-5">
    <h2 class="mb-4">Generate Configuration</h2>
    
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Select Configuration</h5>
        </div>
        <div class="card-body">
            <form id="configSelectionForm" method="GET" action="{% url 'generate_config:generate_config' %}">
                <div class="mb-3">
                    <label for="configDropdown" class="form-label">Choose Configuration</label>
                    <select class="form-select optimized-select" id="configDropdown" name="config_type" required>
                        <option value="">Select Configuration Type</option>
                        {% for config in configs_list %}
                        <option value="{{ config.name }}">{{ config.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        Show Configuration
                        <i class="bi bi-arrow-right-circle ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="configFormContainer" style="display: none;">
        <form id="configGenerationForm" method="POST" action="{% url 'generate_config:generate_config' %}">
            {% csrf_token %}
            <div id="dynamicFields" class="row g-3"></div>
            <input type="hidden" id="parsedData" name="parsedData">
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Generate Config</button>
                <button type="reset" class="btn btn-secondary ms-2">Reset</button>
            </div>
        </form>
    </div>
    
</div>

<style>
    .optimized-select-wrapper {
        position: relative;
        width: 100%;
    }
    
    .optimized-select-button {
        width: 100%;
        text-align: left;
        cursor: pointer;
    }
    
    .optimized-select-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1000;
        margin-top: 0.25rem;
    }
    
    .optimized-select-search {
        width: 100%;
        padding: 0.5rem;
        border-bottom: 1px solid #dee2e6;
        border-radius: 0.375rem 0.375rem 0 0;
    }
    
    .optimized-select-options {
        overflow-y: auto;
        position: relative;
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
    .virtual-scroll-container {
        position: relative;
    }
    
    .optimized-select-option {
        padding: 0.5rem 1rem;
        cursor: pointer;
        position: absolute;
        width: 100%;
        display: flex;
        align-items: center;
    }
    
    .optimized-select-option:hover {
        background-color: #f8f9fa;
    }
    
    .optimized-select-options::-webkit-scrollbar {
        width: 6px;
    }
    
    .optimized-select-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .optimized-select-options::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    .optimized-select-options::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>

<script>
    // Custom select with virtual scrolling and search that can be reused
    class OptimizedSelect {
        constructor(originalSelect, options = {}) {
            if(originalSelect.dataset.initialized){
                return;
            }

          this.originalSelect = originalSelect;
          this.options = options;
          this.itemHeight = 35;
          this.visibleItems = 8;
          this.allOptions = Array.from(originalSelect.options).map(opt => ({
            value: opt.value,
            label: opt.text
          }));
          this.isOpen = false;

          originalSelect.dataset.initialized = 'true';
      
          this.init();
        }
      
        init() {
          // Create wrapper
          this.wrapper = document.createElement('div');
          this.wrapper.className = 'optimized-select-wrapper';
          this.wrapper.id = `${this.elementId}-wrapper`;
      
          // Create custom select button
          this.button = document.createElement('button');
          this.button.className = 'optimized-select-button form-select';
          this.button.id = `${this.elementId}-button`;
          this.button.type = 'button'; // Prevent form submission
          this.button.textContent = this.originalSelect.selectedOptions[0]?.text || 'Choose...';
      
          // Create dropdown container
          this.dropdown = document.createElement('div');
          this.dropdown.className = 'optimized-select-dropdown';
          this.dropdown.id = `${this.elementId}-dropdown`;
      
          // Create search input
          this.searchInput = document.createElement('input');
          this.searchInput.className = 'optimized-select-search form-control';
          this.searchInput.id = `${this.elementId}-search`;
          this.searchInput.placeholder = 'Search...';
      
          // Create options container
          this.optionsContainer = document.createElement('div');
          this.optionsContainer.className = 'optimized-select-options';
          this.optionsContainer.id = `${this.elementId}-options`;
          this.optionsContainer.style.height = `${this.itemHeight * this.visibleItems}px`;
      
          // Create virtual scroll container
          this.virtualScroll = document.createElement('div');
          this.virtualScroll.className = 'virtual-scroll-container';
          this.virtualScroll.id = `${this.elementId}-virtual-scroll`;
      
          // Assemble the components
          this.dropdown.appendChild(this.searchInput);
          this.dropdown.appendChild(this.optionsContainer);
          this.optionsContainer.appendChild(this.virtualScroll);
          this.wrapper.appendChild(this.button);
          this.wrapper.appendChild(this.dropdown);
      
          // Insert custom select after original
          this.originalSelect.style.display = 'none';
          this.originalSelect.parentNode.insertBefore(this.wrapper, this.originalSelect.nextSibling);
      
          this.addEventListeners();
          this.filterAndRenderOptions();
        }
      
        addEventListeners() {
          // Toggle dropdown with improved handling
          this.button.addEventListener('mousedown', (e) => {
            e.preventDefault(); // Prevent focus issues
            this.toggleDropdown();
          });
      
          // Handle search
          this.searchInput.addEventListener('input', () => {
            this.filterAndRenderOptions();
          });
      
          // Prevent search input from closing dropdown
          this.searchInput.addEventListener('mousedown', (e) => {
            e.stopPropagation();
          });
      
          // Handle scroll
          this.optionsContainer.addEventListener('scroll', () => {
            this.renderVisibleOptions();
          });
      
          // Close dropdown when clicking outside
          document.addEventListener('mousedown', (e) => {
            if (!this.wrapper.contains(e.target)) {
              this.closeDropdown();
            }
          });
      
          // Prevent dropdown from closing when clicking inside
          this.dropdown.addEventListener('mousedown', (e) => {
            e.stopPropagation();
          });
        }
      
        toggleDropdown() {
          if (this.isOpen) {
            this.closeDropdown();
          } else {
            this.openDropdown();
          }
        }
      
        openDropdown() {
          this.isOpen = true;
          this.dropdown.style.display = 'block';
          this.searchInput.focus();
          this.filterAndRenderOptions();
        }
      
        closeDropdown() {
          this.isOpen = false;
          this.dropdown.style.display = 'none';
          this.searchInput.value = '';
          this.filterAndRenderOptions();
        }
      
        filterAndRenderOptions() {
          const searchTerm = this.searchInput.value.toLowerCase();
          this.filteredOptions = this.allOptions.filter(option => 
            option.label.toLowerCase().includes(searchTerm)
          );
      
          // Reset scroll position
          this.optionsContainer.scrollTop = 0;
          this.virtualScroll.style.height = `${this.filteredOptions.length * this.itemHeight}px`;
          this.renderVisibleOptions();
        }
      
        renderVisibleOptions() {
          const scrollTop = this.optionsContainer.scrollTop;
          const startIndex = Math.floor(scrollTop / this.itemHeight);
          const endIndex = startIndex + this.visibleItems + 2;
      
          this.virtualScroll.innerHTML = '';
      
          this.filteredOptions.slice(startIndex, endIndex).forEach((option, index) => {
            const optionEl = document.createElement('div');
            optionEl.className = 'optimized-select-option';
            optionEl.textContent = option.label;
            optionEl.style.position = 'absolute';
            optionEl.style.top = `${(startIndex + index) * this.itemHeight}px`;
            optionEl.style.height = `${this.itemHeight}px`;
      
            optionEl.addEventListener('mousedown', (e) => {
              e.preventDefault(); // Prevent focus issues
              this.selectOption(option);
            });
      
            this.virtualScroll.appendChild(optionEl);
          });
        }
      
        selectOption(option) {
          // Update original select
          this.originalSelect.value = option.value;
          this.originalSelect.dispatchEvent(new Event('change'));
      
          // Update custom select
          this.button.textContent = option.label;
          this.closeDropdown();
        }
      }
</script>

<script>
    // Initialize all optimized selects
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize optimized selects for all elements with the 'optimized-select' class
        document.querySelectorAll('.optimized-select:not([data-modal])').forEach(select => {
            new OptimizedSelect(select);
        });
        // Handle config selection form submission
        document.getElementById('configSelectionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const configType = document.getElementById('configDropdown').value;
            const url = `{% url 'generate_config:generate_config' %}?config_type=${configType}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        // Update the page with the retrieved data
                        console.log(data);
                        // For example, you can display the data in a div
                        document.getElementById('configDetails').innerText = JSON.stringify(data, null, 2);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        })
    });
    
</script>

{% if config %}

<style>
    .required-label::after {
        content: " *";
        color: red;
    }
    .form-text.text-muted {
        color: #6c757d !important;
        word-wrap: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        width: 100%;
        display: block;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
        
        #dynamicFields .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .btn {
            margin-bottom: 10px;
            width: 100%;
        }
        
        .btn:not(:first-child) {
            margin-left: 0 !important;
        }
        
        h2 {
            font-size: 1.5rem;
        }
        
        .form-control {
            font-size: 14px;
        }
        
        .form-text.text-muted {
            font-size: 12px;
        }
    }

    /* Ensure textarea and inputs are consistent */
    textarea.form-control, input.form-control {
        min-height: 38px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration data passed from Django context
    const configData = {{ config|safe }};

    // Function to render input based on data type
    function renderInput(fieldName, fieldConfig) {
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'col-md-6 mb-3';

        // Create label
        const label = document.createElement('label');
        label.htmlFor = fieldName;
        label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
        label.textContent = `${fieldConfig.ui_displayed_name} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
        inputWrapper.appendChild(label);

        // Create input or textarea based on value type
        let inputElement;
        if (Array.isArray(fieldConfig.default)) {
            // Array input (textarea for easier editing)
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else if (typeof fieldConfig.default === 'object' && fieldConfig.default !== null) {
            // Object input (textarea for JSON)
            inputElement = document.createElement('textarea');
            inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
        } else {
            // Standard text input
            inputElement = document.createElement('input');
            inputElement.type = 'text';
            inputElement.value = fieldConfig.default;
        }

        inputElement.id = fieldName;
        inputElement.name = fieldName;
        inputElement.className = 'form-control';
        inputElement.placeholder = JSON.stringify(fieldConfig.default);
        
        if (fieldConfig.required !== false) {
            inputElement.required = true;
        }

        inputWrapper.appendChild(inputElement);

        // Example text
        const exampleText = document.createElement('small');
        exampleText.className = 'form-text text-muted';

        let defaultValue = fieldConfig.default;

        if (Array.isArray(defaultValue) && defaultValue.length > 3) {
            defaultValue = defaultValue.slice(0, 3);
        } else if (typeof defaultValue === 'object' && defaultValue !== null) {
            const keys = Object.keys(defaultValue);
            if (keys.length > 3) {
                defaultValue = keys.slice(0, 3).reduce((obj, key) => {
                    obj[key] = defaultValue[key];
                    return obj;
                }, {});
            }
        }

        exampleText.textContent = `Example: ${JSON.stringify(defaultValue)}`;
        inputWrapper.appendChild(exampleText);

        return inputWrapper;
    }

    // Render dynamic fields
    const dynamicFieldsContainer = document.getElementById('dynamicFields');
    Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
        if (fieldConfig.show) {
            dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
        }
    });

    // Form submission handler
    document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const parsedData = {};
        const formElements = this.elements;

        for (let element of formElements) {
            if (element.name && element.name !== 'csrfmiddlewaretoken') {
                try {
                    // Attempt to parse the input value
                    const value = element.value.trim();
                    
                    if (value.startsWith('[') || value.startsWith('{')) {
                        // Parse JSON for arrays and objects
                        parsedData[element.name] = JSON.parse(value);
                    } else if (value === 'true' || value === 'false') {
                        // Parse boolean
                        parsedData[element.name] = value === 'true';
                    } else if (!isNaN(value) && value !== '') {
                        // Parse number
                        parsedData[element.name] = Number(value);
                    } else {
                        // Keep as string
                        parsedData[element.name] = value;
                    }
                } catch (error) {
                    console.error(`Error parsing ${element.name}:`, error);
                    parsedData[element.name] = element.value;
                }
            }
        }

        // Submit via AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(parsedData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.status === 'success') {
                alert('Config generated successfully!');
            } else {
                alert('Error: ' + data.message);
           }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });
});
</script>

{% endif %}
{% endblock %}

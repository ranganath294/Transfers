<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Generator</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        body {
            background-color: #f4f6f9;
            font-family: 'Inter', sans-serif;
        }
        .config-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 30px;
            margin-top: 30px;
        }
        .form-control, .btn {
            border-radius: 8px;
        }
        .required-label::after {
            content: " *";
            color: red;
        }
        .form-text.text-muted {
            color: #6c757d !important;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            width: 100%;
            display: block;
        }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .config-container {
                padding: 15px;
                margin-top: 15px;
            }
            .btn-group {
                flex-direction: column;
            }
            .btn-group > .btn {
                margin-bottom: 10px;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10 config-container">
                <h2 class="mb-4 text-center">Configuration Generator</h2>
                
                <!-- Config Selection Section -->
                <div id="configSelectionSection">
                    <div class="mb-3">
                        <label class="form-label" for="config-select">Select Config</label>
                        <select name="config" class="form-select" id="config-select">
                            <option value="" selected>Select Configuration</option>
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                    <div class="text-center">
                        <button id="show-config-btn" class="btn btn-primary">Show Configuration</button>
                    </div>
                </div>

                <!-- Config Generation Form -->
                <form id="configGenerationForm" class="mt-4" style="display:none;">
                    {% csrf_token %}
                    <div id="dynamicFields" class="row g-3"></div>
                    <input type="hidden" id="parsedData" name="parsedData">
                    <div class="mt-4 d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-success">Generate Config</button>
                            <button type="reset" class="btn btn-secondary ms-2">Reset</button>
                        </div>
                        <button id="back-to-select" type="button" class="btn btn-outline-secondary">Back to Selection</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const configSelect = document.getElementById('config-select');
        const showConfigBtn = document.getElementById('show-config-btn');
        const configSelectionSection = document.getElementById('configSelectionSection');
        const configGenerationForm = document.getElementById('configGenerationForm');
        const dynamicFieldsContainer = document.getElementById('dynamicFields');
        const backToSelectBtn = document.getElementById('back-to-select');

        // Populate config dropdown
        function populateConfigDropdown() {
            fetch('/get-config-list/')  // Replace with your actual endpoint
                .then(response => response.json())
                .then(configs => {
                    configSelect.innerHTML = '<option value="" selected>Select Configuration</option>';
                    configs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.name;
                        option.textContent = config.name;
                        configSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error fetching config list:', error);
                    alert('Failed to load configurations');
                });
        }

        // Function to render input based on data type
        function renderInput(fieldName, fieldConfig) {
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'col-md-6 mb-3';

            // Create label
            const label = document.createElement('label');
            label.htmlFor = fieldName;
            label.className = `form-label ${fieldConfig.required !== false ? 'required-label' : ''}`;
            label.textContent = `${fieldConfig.ui_displayed_name} ${fieldConfig.required !== false ? '(required)' : '(optional)'}`;
            inputWrapper.appendChild(label);

            // Create input or textarea based on value type
            let inputElement;
            if (Array.isArray(fieldConfig.default)) {
                // Array input (textarea for easier editing)
                inputElement = document.createElement('textarea');
                inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
            } else if (typeof fieldConfig.default === 'object' && fieldConfig.default !== null) {
                // Object input (textarea for JSON)
                inputElement = document.createElement('textarea');
                inputElement.value = JSON.stringify(fieldConfig.default, null, 2);
            } else {
                // Standard text input
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = fieldConfig.default;
            }

            inputElement.id = fieldName;
            inputElement.name = fieldName;
            inputElement.className = 'form-control';
            inputElement.placeholder = JSON.stringify(fieldConfig.default);

            if (fieldConfig.required !== false) {
                inputElement.required = true;
            }

            inputWrapper.appendChild(inputElement);

            // Example text
            const exampleText = document.createElement('small');
            exampleText.className = 'form-text text-muted';

            let defaultValue = fieldConfig.default;

            if (Array.isArray(defaultValue) && defaultValue.length > 3) {
                defaultValue = defaultValue.slice(0, 3);
            } else if (typeof defaultValue === 'object' && defaultValue !== null) {
                const keys = Object.keys(defaultValue);
                if (keys.length > 3) {
                    defaultValue = keys.slice(0, 3).reduce((obj, key) => {
                        obj[key] = defaultValue[key];
                        return obj;
                    }, {});
                }
            }

            exampleText.textContent = `Example: ${JSON.stringify(defaultValue)}`;
            inputWrapper.appendChild(exampleText);

            return inputWrapper;
        }

        // Show Configuration Button Click
        showConfigBtn.addEventListener('click', function() {
            const selectedConfig = configSelect.value;
            if (!selectedConfig) {
                alert('Please select a configuration');
                return;
            }

            // Fetch configuration details
            fetch(`/get-config-details/?config=${selectedConfig}`)  // Replace with your actual endpoint
                .then(response => response.json())
                .then(configData => {
                    // Clear previous fields
                    dynamicFieldsContainer.innerHTML = '';

                    // Render dynamic fields
                    Object.entries(configData).forEach(([fieldName, fieldConfig]) => {
                        if (fieldConfig.show) {
                            dynamicFieldsContainer.appendChild(renderInput(fieldName, fieldConfig));
                        }
                    });

                    // Toggle visibility
                    configSelectionSection.style.display = 'none';
                    configGenerationForm.style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching config details:', error);
                    alert('Failed to load configuration details');
                });
        });

        // Back to Selection Button
        backToSelectBtn.addEventListener('click', function() {
            configSelectionSection.style.display = 'block';
            configGenerationForm.style.display = 'none';
        });

        // Form submission handler
        document.getElementById('configGenerationForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const parsedData = {};
            const formElements = this.elements;

            for (let element of formElements) {
                if (element.name && element.name !== 'csrfmiddlewaretoken') {
                    try {
                        // Attempt to parse the input value
                        const value = element.value.trim();

                        if (value.startsWith('[') || value.startsWith('{')) {
                            // Parse JSON for arrays and objects
                            parsedData[element.name] = JSON.parse(value);
                        } else if (value === 'true' || value === 'false') {
                            // Parse boolean
                            parsedData[element.name] = value === 'true';
                        } else if (!isNaN(value) && value !== '') {
                            // Parse number
                            parsedData[element.name] = Number(value);
                        } else {
                            // Keep as string
                            parsedData[element.name] = value;
                        }
                    } catch (error) {
                        console.error(`Error parsing ${element.name}:`, error);
                        parsedData[element.name] = element.value;
                    }
                }
            }

            // Submit via AJAX
            fetch('/generate-config/', {  // Replace with your actual endpoint
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(parsedData)
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                if (data.status === 'success') {
                    alert('Config generated successfully!');
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while generating the config');
            });
        });

        // Initial population of config dropdown
        populateConfigDropdown();
    });
    </script>
</body>
</html>
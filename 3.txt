{% extends 'iot_catalogue/base.html' %}
{% load static %}

{% block content_div %}
<form id="iot-search-form" method="post" action="{% url 'iot_catalogue:search' %}" class="row g-3">
    {% csrf_token %}
    <div class="col-md-6">
        {% include 'iot_catalogue/components/search_form_left.html' %}
    </div>
    <div class="col-md-6">
        {% include 'iot_catalogue/components/search_form_right.html' %}
    </div>
    <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>Search
        </button>
        <button type="reset" class="btn btn-secondary">
            <i class="fas fa-undo me-2"></i>Reset
        </button>
    </div>
</form>

{% include 'iot_catalogue/components/user_assignment_modal.html' %}
{% endblock %}

{% block results_div %}
{% if devices %}
    {% include 'iot_catalogue/components/results_table.html' %}
{% endif %}
{% endblock %}






<!-- templates/iot_catalogue/components/search_form_left.html -->
<div class="mb-3">
    <label class="form-label" for="device-type-select">Device Type</label>
    <select name="device_type" id="device-type-select" class="form-select">
        <option value="default" selected>-- All --</option>
        <option value="Headset">Headset</option>
        <option value="Speaker">Speaker</option>
        <option value="Earbud">Earbud</option>
        <option value="HID Mouse">HID Mouse</option>
        <option value="HID Keyboard">HID Keyboard</option>
        <option value="HID Gamepad">HID Gamepad</option>
        <option value="HOGP Mouse">HOGP Mouse</option>
        <option value="HOGP Keyboard">HOGP Keyboard</option>
        <option value="HOGP Gamepad">HOGP Gamepad</option>
        <option value="Carkit">Carkit</option>
        <option value="Smart Watch">Smart Watch</option>
        <option value="Fitness band">Fitness band</option>
        <option value="Heart rate monitor">Heart rate monitor</option>
        <option value="LE tracker">LE tracker</option>
        <option value="Phone">Phone</option>
        <option value="Smart ring">Smart ring</option>
        <option value="Health device">Health device</option>
        <option value="Smart bulb">Smart bulb</option>
    </select>
</div>

<div class="mb-3">
    <label class="form-label" for="model-number-input">Model Number</label>
    <div class="input-group">
        <span class="input-group-text">LIKE</span>
        <input type="text" name="model_number" id="model-number-input" class="form-control">
    </div>
</div>

<div class="mb-3">
    <label class="form-label" for="chipset-manufacturer-input">Chipset Manufacturer</label>
    <div class="input-group">
        <span class="input-group-text">LIKE</span>
        <input type="text" name="chipset_manufacturer" id="chipset-manufacturer-input" class="form-control">
    </div>
</div>

<div class="mb-3">
    <label class="form-label" for="procured-date-between">Procured Date</label>
    <div class="input-group">
        <span class="input-group-text">BETWEEN</span>
        <input type="date" name="procured_date_between" id="procured-date-between" class="form-control">
        <span class="input-group-text">AND</span>
        <input type="date" name="procured_date_and" id="procured-date-and" class="form-control">
    </div>
</div>

<div class="mb-3">
    <label class="form-label" for="availability-select">Availability</label>
    <select name="availability" id="availability-select" class="form-select">
        <option value="default" selected>-- All --</option>
        <option value="Available">Available</option>
        <option value="In Use">In Use</option>
    </select>
</div>





<!-- templates/iot_catalogue/components/search_form_right.html -->
<div class="mb-3">
    <label class="form-label" for="manufacturer-input">Manufacturer</label>
    <div class="input-group">
        <span class="input-group-text">LIKE</span>
        <input type="text" name="manufacturer" id="manufacturer-input" class="form-control">
    </div>
</div>

<div class="mb-3">
    <label class="form-label" for="model-year-between">Model Year</label>
    <div class="input-group">
        <span class="input-group-text">BETWEEN</span>
        <input type="number" name="model_year_between" id="model-year-between" class="form-control">
        <span class="input-group-text">AND</span>
        <input type="number" name="model_year_and" id="model-year-and" class="form-control">
    </div>
</div>

<div class="mb-3">
    <label class="form-label" for="device-status-select">Device Status</label>
    <select name="device_status" id="device-status-select" class="form-select">
        <option value="default" selected>-- All --</option>
        <option value="Active">Active</option>
        <option value="Missing">Missing</option>
        <option value="Retired">Retired</option>
        <option value="Damaged">Damaged</option>
    </select>
</div>

<div class="mb-3">
    <label class="form-label" for="geo-location-select">Geo Locations</label>
    <select name="geo_location" id="geo-location-select" class="form-select">
        <option value="default" selected>-- All --</option>
        <option value="SD">SD</option>
        <option value="SDC">SDC</option>
        <option value="QIPL">QIPL</option>
    </select>
</div>








<!-- templates/iot_catalogue/components/user_assignment_modal.html -->
<div class="modal fade" id="user-assignment-modal" tabindex="-1" aria-labelledby="user-assignment-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="user-assignment-modal-label">Assign User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="user-select" class="form-label">Select User</label>
                    <select class="form-select" id="user-select">
                        <option value="">Choose...</option>
                        {% for username in usernames %}
                        <option value="{{ username }}">{{ username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="user-assignment-save-btn">Save changes</button>
            </div>
        </div>
    </div>
</div>









<!-- templates/iot_catalogue/components/results_table.html -->
<div class="card-body">
    <div class="table-shadow">
        <div class="table-container">
            <table class="table table-hover table-sticky mb-0" id="iot-devices-table">
                <thead>
                    <tr class="bg-light">
                        {% for col_name in column_names %}
                        <th class="fw-semibold" id="col-header-{{ col_name|lower|replace:" ":"_" }}">{{ col_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody id="iot-devices-tbody">
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script id="devices-data" type="application/json">
{{ devices|safe }}
</script>

<!-- Include the JavaScript files -->
<script src="{% static 'iot_catalogue/js/optimized-select.js' %}"></script>
<script src="{% static 'iot_catalogue/js/device-table-manager.js' %}"></script>
<script src="{% static 'iot_catalogue/js/main.js' %}"></script>









/* static/iot_catalogue/css/table-styles.css */
.table-container {
    position: relative;
    max-height: calc(100vh - 300px);
    overflow: auto;
}

.table-sticky thead {
    position: sticky;
    top: 0;
    z-index: 1;
    background-color: #f8f9fa;
}

.table-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.table-container::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.table-sticky th,
.table-sticky td {
    white-space: nowrap;
    padding: 0.75rem;
}

.table-shadow {
    box-shadow: inset 0 0 5px rgba(0,0,0,0.15);
    border-radius: 0.375rem;
}

.current-user-cell {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.current-user-text {
    flex-grow: 1;
}

.current-user-edit-icon {
    color: #6c757d;
    cursor: pointer;
    transition: color 0.2s ease;
}

.current-user-edit-icon:hover {
    color: #0d6efd;
}








// static/iot_catalogue/js/optimized-select.js
class OptimizedSelect {
    constructor(originalSelect) {
        this.originalSelect = originalSelect;
        this.selectId = originalSelect.id;
        this.itemHeight = 35;
        this.visibleItems = 8;
        this.allOptions = Array.from(originalSelect.options).map(opt => ({
            value: opt.value,
            label: opt.text
        }));
        this.init();
    }

    init() {
        this.createElements();
        this.setupEventListeners();
    }

    createElements() {
        // Create wrapper with meaningful ID
        this.wrapper = document.createElement('div');
        this.wrapper.id = `${this.selectId}-wrapper`;
        this.wrapper.className = 'optimized-select-wrapper';

        // Create button
        this.button = document.createElement('button');
        this.button.id = `${this.selectId}-button`;
        this.button.className = 'optimized-select-button form-select';
        this.button.type = 'button';
        this.button.textContent = this.originalSelect.selectedOptions[0]?.text || 'Choose...';

        // Create dropdown
        this.createDropdown();

        // Assemble and insert
        this.wrapper.appendChild(this.button);
        this.wrapper.appendChild(this.dropdown);
        this.originalSelect.style.display = 'none';
        this.originalSelect.parentNode.insertBefore(this.wrapper, this.originalSelect.nextSibling);
    }

    createDropdown() {
        this.dropdown = document.createElement('div');
        this.dropdown.id = `${this.selectId}-dropdown`;
        this.dropdown.className = 'optimized-select-dropdown';

        // Search input
        this.searchInput = document.createElement('input');
        this.searchInput.id = `${this.selectId}-search`;
        this.searchInput.className = 'optimized-select-search form-control';
        this.searchInput.placeholder = 'Search...';

        // Options container
        this.optionsContainer = document.createElement('div');
        this.optionsContainer.id = `${this.selectId}-options-container`;
        this.optionsContainer.className = 'optimized-select-options';
        this.optionsContainer.style.height = `${this.itemHeight * this.visibleItems}px`;

        // Virtual scroll container
        this.virtualScroll = document.createElement('div');
        this.virtualScroll.id = `${this.selectId}-virtual-scroll`;
        this.virtualScroll.className = 'virtual-scroll-container';

        this.dropdown.appendChild(this.searchInput);
        this.optionsContainer.appendChild(this.virtualScroll);
        this.dropdown.appendChild(this.optionsContainer);
    }

    setupEventListeners() {
        // Toggle dropdown
        this.button.addEventListener('click', () => this.toggleDropdown());

        // Handle search
        this.searchInput.addEventListener('input', () => this.filterOptions());

        // Handle scroll
        this.optionsContainer.addEventListener('scroll', () => this.renderVisibleOptions());

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!this.wrapper.contains(e.target)) {
                this.closeDropdown();
            }
        });
    }

    toggleDropdown() {
        if (this.dropdown.style.display === 'block') {
            this.closeDropdown();
        } else {
            this.openDropdown();
        }
    }

    openDropdown() {
        this.dropdown.style.display = 'block';
        this.searchInput.value = '';
        this.filterOptions();
        this.searchInput.focus();
    }

    closeDropdown() {
        this.dropdown.style.display = 'none';
    }

    filterOptions() {
        const searchTerm = this.